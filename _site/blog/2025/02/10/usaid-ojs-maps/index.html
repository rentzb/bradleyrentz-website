<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Bradley Rentz">
<meta name="description" content="Manipulate geographic data, change projections, get live data from a database, and make interactive plots with Observable JS">
<title>Using USAID data to make fancy world maps with Observable Plot | Bradley Rentz – Bradley Rentz</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/probability.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-1234', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script type="module" src="../../../../../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script><link href="../../../../../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">
<style type="text/css">
div.sourceCode > pre.sourceCode.js::before {
  content: 'Observable JS';
  display: block;
  text-align: left;
  font-size: 1em;
  margin-bottom: 7px;
  border-bottom: #dddddd 1px solid;
  padding-left: 4.25px;
  padding-bottom: 5px;
  color: #aaaaaa;
}

div.sourceCode > pre.sourceCode.r::before {
  content: 'R';
  display: block;
  text-align: left;
  font-size: 1em;
  margin-bottom: 7px;
  border-bottom: #dddddd 1px solid;
  padding-left: 4.25px;
  padding-bottom: 5px;
  color: #aaaaaa;
}

div.sourceCode > pre.sourceCode.sql::before {
  content: 'SQL';
  display: block;
  text-align: left;
  font-size: 1em;
  margin-bottom: 7px;
  border-bottom: #dddddd 1px solid;
  padding-left: 4.25px;
  padding-bottom: 5px;
  color: #aaaaaa;
}
</style>
<meta property="og:title" content="Using USAID data to make fancy world maps with Observable Plot | Bradley Rentz">
<meta property="og:description" content="Manipulate geographic data, change projections, get live data from a database, and make interactive plots with Observable JS">
<meta property="og:image" content="https://www.bradleyrentz.com/blog/2025/02/10/usaid-ojs-maps/img/final-plot.png">
<meta property="og:site_name" content="Bradley Rentz">
<meta property="og:image:height" content="1012">
<meta property="og:image:width" content="1964">
<meta name="twitter:title" content="Using USAID data to make fancy world maps with Observable Plot | Bradley Rentz">
<meta name="twitter:description" content="Manipulate geographic data, change projections, get live data from a database, and make interactive plots with Observable JS">
<meta name="twitter:image" content="https://www.bradleyrentz.com/blog/2025/02/10/usaid-ojs-maps/img/final-plot.png">
<meta name="twitter:image-height" content="1012">
<meta name="twitter:image-width" content="1964">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Bradley Rentz</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/rentzb" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/bradleyrentz" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Using USAID data to make fancy world maps with Observable Plot</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Manipulate geographic data, change projections, get live data from a database, and make interactive plots with Observable JS
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">ojs</div>
                <div class="quarto-category">observable plot</div>
                <div class="quarto-category">gis</div>
                <div class="quarto-category">maps</div>
                <div class="quarto-category">usaid</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Monday, February 10, 2025</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/c0aep-hp989">10.59350/c0aep-hp989</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#working-with-map-data" id="toc-working-with-map-data" class="nav-link active" data-scroll-target="#working-with-map-data">Working with map data</a>
  <ul>
<li><a href="#get-map-data" id="toc-get-map-data" class="nav-link" data-scroll-target="#get-map-data">Get map data</a></li>
  <li>
<a href="#maps-and-projections-with-observable-plot" id="toc-maps-and-projections-with-observable-plot" class="nav-link" data-scroll-target="#maps-and-projections-with-observable-plot">Maps and projections with Observable Plot</a>
  <ul class="collapse">
<li><a href="#built-in-projections" id="toc-built-in-projections" class="nav-link" data-scroll-target="#built-in-projections">Built-in projections</a></li>
  <li><a href="#other-projections" id="toc-other-projections" class="nav-link" data-scroll-target="#other-projections">Other projections</a></li>
  </ul>
</li>
  <li>
<a href="#filtering-map-data-and-adjusting-projections" id="toc-filtering-map-data-and-adjusting-projections" class="nav-link" data-scroll-target="#filtering-map-data-and-adjusting-projections">Filtering map data and adjusting projections</a>
  <ul class="collapse">
<li><a href="#removing-elements" id="toc-removing-elements" class="nav-link" data-scroll-target="#removing-elements">Removing elements</a></li>
  <li><a href="#quick-and-dirty-cheating-method-change-the-width-or-height" id="toc-quick-and-dirty-cheating-method-change-the-width-or-height" class="nav-link" data-scroll-target="#quick-and-dirty-cheating-method-change-the-width-or-height">Quick and dirty cheating method: change the width or height</a></li>
  <li><a href="#built-in-projections-and-domain-settings" id="toc-built-in-projections-and-domain-settings" class="nav-link" data-scroll-target="#built-in-projections-and-domain-settings">Built-in projections and domain settings</a></li>
  <li><a href="#other-projections-and-.fitextent" id="toc-other-projections-and-.fitextent" class="nav-link" data-scroll-target="#other-projections-and-.fitextent">Other projections and <code>.fitExtent()</code></a></li>
  <li><a href="#arbitrary-areas-and-.fitextent" id="toc-arbitrary-areas-and-.fitextent" class="nav-link" data-scroll-target="#arbitrary-areas-and-.fitextent">Arbitrary areas and <code>.fitExtent()</code></a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#working-with-usaid-data" id="toc-working-with-usaid-data" class="nav-link" data-scroll-target="#working-with-usaid-data">Working with USAID data</a>
  <ul>
<li><a href="#get-usaid-data" id="toc-get-usaid-data" class="nav-link" data-scroll-target="#get-usaid-data">Get USAID data</a></li>
  </ul>
</li>
  <li>
<a href="#connect-usaid-data-to-the-map-data" id="toc-connect-usaid-data-to-the-map-data" class="nav-link" data-scroll-target="#connect-usaid-data-to-the-map-data">Connect USAID data to the map data</a>
  <ul>
<li><a href="#improving-the-map" id="toc-improving-the-map" class="nav-link" data-scroll-target="#improving-the-map">Improving the map</a></li>
  <li><a href="#fixing-labelling-issues" id="toc-fixing-labelling-issues" class="nav-link" data-scroll-target="#fixing-labelling-issues">Fixing labelling issues</a></li>
  <li><a href="#some-final-tweaks" id="toc-some-final-tweaks" class="nav-link" data-scroll-target="#some-final-tweaks">Some final tweaks</a></li>
  </ul>
</li>
  <li><a href="#the-full-game-complete-final-code" id="toc-the-full-game-complete-final-code" class="nav-link" data-scroll-target="#the-full-game-complete-final-code">The full game: Complete final code</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>As part of Elon Musk’s weird Department of Government Efficiency’s unconstitutional rampage through the federal government, USAID’s ForeignAssistance.gov was taken offline on January 31, 2025. It reappeared on February 3, but it’s not clear how long it will be available, especially as USAID is gutted (despite court orders and injunctions to stop).</p>
<p>I study civil society, human rights, and foreign aid and rely on USAID aid data for several of my <a href="https://www.andrewheiss.com/research/working-papers/chaudhry-heiss-ngos-aid/">research projects</a>, so as a backup, I used <a href="https://datasette.io/">Datasette</a> to create a mirror website/API of the entire ForeignAssistance.gov dataset at <a href="https://foreignassistance-data.andrewheiss.com/" class="uri">https://foreignassistance-data.andrewheiss.com/</a>. Everything as of December 19, 2024 is available there, both as a queryable SQL database and as downloadable CSV files.</p>
<p>I also made <a href="https://foreignassistance.andrewheiss.com/">a little frontend website</a> with links to each individual dataset. As I built that website, I decided to try recreating the ForeignAssistance.gov dashboard, which had neat interactive maps and tables.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="img/foreign-assistance-gov.png" class="border img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="margin-caption">ForeignAssistance.gov dashboard</figcaption></figure>
</div>
<p>Since <a href="https://quarto.org/docs/interactive/ojs/">Quarto has native support</a> for <a href="https://observablehq.com/@observablehq/observables-not-javascript">Observable JS</a> for interactive work, and since I’ve meant to really dig into Observable and figure out how to make more interactive graphs, I figured I’d play around with the rescued USAID data.</p>
<p>So in this post, I show what I learned about working with geographic data and making pretty maps with <a href="https://observablehq.com/plot/getting-started">Observable Plot</a>,</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caveat!
</div>
</div>
<div class="callout-body-container callout-body">
<p>I’m really bad at Javascript! The code here is probably wildly inefficient and feels R-flavored.</p>
<p>But it works, and that’s all that matters :)</p>
</div>
</div>
<section id="working-with-map-data" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="working-with-map-data">Working with map data</h2>
<section id="get-map-data" class="level3"><h3 class="anchored" data-anchor-id="get-map-data">Get map data</h3>
<p>Observable Plot uses the <a href="https://github.com/d3/d3-geo"><code>d3-geo</code></a> module behind the scenes to parse and work with map data, and D3 typically works with data formatted as <a href="https://en.wikipedia.org/wiki/GeoJSON">GeoJSON</a>. There are tons of high quality geographic data sources online, like the <del>US Census</del> (they’ve been removing those in the past few weeks), <a href="https://www.nhgis.org/">IPUMS NHGIS</a>, <a href="https://ihgis.ipums.org/">IPUMS IHGIS</a>, and the <a href="https://www.naturalearthdata.com/">Natural Earth project</a>, and cities and states typically offer GIS data for public sector-related data. These data sources tend to be stored as <a href="https://en.wikipedia.org/wiki/Shapefile">shapefiles</a>, which are a fairly complex (but standard) format for geographic data that involve multiple files.</p>
<p>Observable Plot/D3 might be able to work with shapefiles directly, but it’s nowhere in the documentation. They seem to expect GeoJSON instead. We could hunt around online for GeoJSON data, but—even better—we can use the {sf} package in R to convert any shapefile-based data into GeoJSON by setting <code>driver = "GeoJSON"</code> in <code><a href="https://r-spatial.github.io/sf/reference/st_write.html">sf::st_write()</a></code>. Here we’ll load two datasets from Natural Earth—(1) small scale low resolution 1:110m data for mapping the whole world and (2) medium scale 1:50m data for mapping specific regions and countries—and convert them to GeoJSON files.</p>
<div class="cell">
<div class="sourceCode" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/">rnaturalearth</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get low resolution Natural Earth data as map units instead of countries because of France</span></span>
<span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">110</span>, type <span class="op">=</span> <span class="st">"map_units"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save as geojson for Observable Plot</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html">st_write</a></span><span class="op">(</span></span>
<span>  obj <span class="op">=</span> <span class="va">world</span>, </span>
<span>  dsn <span class="op">=</span> <span class="st">"ne_110m_admin_0_countries.geojson"</span>, </span>
<span>  driver <span class="op">=</span> <span class="st">"GeoJSON"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save medium resolution geojson</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html">st_write</a></span><span class="op">(</span></span>
<span>  obj <span class="op">=</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">50</span>, type <span class="op">=</span> <span class="st">"countries"</span><span class="op">)</span>, </span>
<span>  dsn <span class="op">=</span> <span class="st">"ne_50m_admin_0_countries.geojson"</span>, </span>
<span>  driver <span class="op">=</span> <span class="st">"GeoJSON"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Maybe skip intermediate saving?
</div>
</div>
<div class="callout-body-container callout-body">
<p>We could probably use <a href="https://quarto.org/docs/interactive/ojs/data-sources.html#python-and-r">Quarto’s special R-to-OJS function <code>ojs_define()</code></a> and make these R objects directly accessible to OJS without needing to save intermediate files:</p>
<div class="cell">
<div class="sourceCode" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ojs_define</span><span class="op">(</span>world <span class="op">=</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">110</span>, type <span class="op">=</span> <span class="st">"map_units"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…but geographic data is complex and I don’t know how things like Observable Plot’s <code>Plot.geo()</code> handle data that’s not read as GeoJSON. So to keep things simple, I ended up just saving these as GeoJSON. 🤷‍♂️</p>
</div>
</div>
</section><section id="maps-and-projections-with-observable-plot" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="maps-and-projections-with-observable-plot">Maps and projections with Observable Plot</h3>
<p>We can load these into our document with OJS with <code>FileAttachment()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" data-startfrom="150" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 149;"><span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>world <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"ne_110m_admin_0_countries.geojson"</span>)<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>world_medium <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"ne_50m_admin_0_countries.geojson"</span>)<span class="op">.</span><span class="fu">json</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<p>Check out the structure of <code>world</code>. It’s a <code>FeatureCollection</code> with a slot named <code>crs</code> with the projection information and a slot named <code>features</code> with entries for each country. Each country <code>Feature</code> has a slot named <code>properties</code> with columns like <code>name</code>, <code>iso_a3</code>, <code>formal_en</code>, <code>pop_est</code>, and other details.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" data-startfrom="156" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 155;"><span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>world</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-2" data-nodetype="expression">

</div>
</div>
</div>
<p>To plot it, we can use <a href="https://observablehq.com/plot/marks/geo">the <code>Geo</code> mark</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" data-startfrom="162" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 161;"><span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world)</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="expression">

</div>
</div>
</div>
<p>To make things look nicer throughout this post, we’ll define some nicer colors for countries and land and ocean from <a href="https://carto.com/carto-colors/">CARTOColors</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" data-startfrom="174" data-source-offset="-21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 173;"><span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>carto_prism <span class="op">=</span> [</span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>  <span class="st">"#5F4690"</span><span class="op">,</span> <span class="st">"#1D6996"</span><span class="op">,</span> <span class="st">"#38A6A5"</span><span class="op">,</span> <span class="st">"#0F8554"</span><span class="op">,</span> <span class="st">"#73AF48"</span><span class="op">,</span> <span class="st">"#EDAD08"</span><span class="op">,</span> </span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>  <span class="st">"#E17C05"</span><span class="op">,</span> <span class="st">"#CC503E"</span><span class="op">,</span> <span class="st">"#94346E"</span><span class="op">,</span> <span class="st">"#6F4070"</span><span class="op">,</span> <span class="st">"#994E95"</span><span class="op">,</span> <span class="st">"#666666"</span></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a><span class="co">// From R:</span></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a><span class="co">// clr_ocean &lt;- colorspace::lighten("#88CCEE", 0.7)</span></span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>clr_ocean <span class="op">=</span> <span class="st">"#D9F0FF"</span></span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a><span class="co">// From CARTOColors Peach 2</span></span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>clr_land <span class="op">=</span> <span class="st">"#facba6"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-3" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<p>We’ll make the land be orange-ish, add some thin black borders around the countries, and include a blue background color with <code>Plot.frame()</code>:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb7" data-startfrom="190" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="3,4,5,6,7,8"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 189;"><span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean })<span class="op">,</span>  </span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world<span class="op">,</span> { </span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> </span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span> </span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land </span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>    }) </span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-5" data-nodetype="expression">

</div>
</div>
</div>
<section id="built-in-projections" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="built-in-projections">Built-in projections</h4>
<p>Taking a round globe and smashing it on a two-dimensional surface <a href="https://datavizsp25.classes.andrewheiss.com/example/12-example.html#projections-and-coordinate-reference-systems">always requires geometric shenanigans to get things flat</a>. We can control how things get flattened by specifying the projection for the map. Here we’ll use the <a href="https://en.wikipedia.org/wiki/Equal_Earth_projection">Equal Earth projection</a> (invented in 2018 to show countries and continents at their true relative sizes to each other). Since projections contain relative height and width details, we need to specify a width for the plot now. I arbitrarily chose 1000 pixels here, which is the maximum width—it should autoshrink in smaller browser windows, and the height should be calculated automatically. Finally, instead of adding the background color with <code>Plot.frame()</code>, we can use <code>Plot.sphere()</code> to get a nicer background that uses the specified projection:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb8" data-startfrom="209" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="2,3,5"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 208;"><span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> <span class="st">"equal-earth"</span><span class="op">,</span> </span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span> </span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">sphere</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean })<span class="op">,</span> </span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world<span class="op">,</span> {</span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-6" data-nodetype="expression">

</div>
</div>
</div>
<p>The Observable Plot library <a href="https://observablehq.com/plot/features/projections#projection-options">includes a bunch of common built-in projections</a>:</p>
<div class="column-body-outset">
<div class="panel-grid layout-sidebar ms-md-0 layout-sidebar-left">
<div class="cell panel-sidebar card bg-light p-2 g-col-24 g-col-lg-7">
<div class="sourceCode cell-code hidden" id="cb9" data-startfrom="231" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 230;"><span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>viewof projection <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(</span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"equirectangular"</span><span class="op">,</span> <span class="st">"equal-earth"</span><span class="op">,</span> <span class="st">"mercator"</span><span class="op">,</span> <span class="st">"transverse-mercator"</span><span class="op">,</span> <span class="st">"azimuthal-equal-area"</span><span class="op">,</span> <span class="st">"gnomonic"</span>]<span class="op">,</span></span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="st">"azimuthal-equal-area"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Projection"</span>}</span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="panel-fill panel-grid g-col-24 g-col-lg-17 pt-3 pt-lg-0">
<div class="g-col-24">
<div class="cell panel-fill">
<div class="sourceCode cell-code hidden" id="cb10" data-startfrom="241" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 240;"><span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> projection<span class="op">,</span></span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a>  <span class="co">// width,</span></span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">sphere</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean })<span class="op">,</span></span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world<span class="op">,</span> {</span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-8" data-nodetype="expression">

</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section><section id="other-projections" class="level4"><h4 class="anchored" data-anchor-id="other-projections">Other projections</h4>
<p>Observable Plot can support any other D3 projection too. There are a whole bunch of projections in the <a href="https://github.com/d3/d3-geo">main <code>d3-geo</code> module</a>, and there’s a separate <a href="https://github.com/d3/d3-geo-projection"><code>d3-geo-projection</code></a> module for dozens of others. My favorite global projection is <a href="https://en.wikipedia.org/wiki/Robinson_projection">Robinson</a> (the foundation for Equal Earth), which lives in <code>d3-geo-projection</code>. To use it, we can import the module with <code><a href="https://rdrr.io/r/base/library.html">require()</a></code> and then access it with <code>d3_geo_projection.geoRobinson()</code>:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb11" data-startfrom="266" data-source-offset="-1" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="1,4,6"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 265;"><span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>d3_geo_projection <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3-geo-projection"</span>) </span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()<span class="op">,</span> </span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span> </span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">sphere</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean })<span class="op">,</span></span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world<span class="op">,</span> {</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-9-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-9-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
</section></section><section id="filtering-map-data-and-adjusting-projections" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="filtering-map-data-and-adjusting-projections">Filtering map data and adjusting projections</h3>
<section id="removing-elements" class="level4"><h4 class="anchored" data-anchor-id="removing-elements">Removing elements</h4>
<p>Now that we have a nice projection, we can tweak the map a little. Antarctica is taking up a big proportion of the southern hemisphere, so we’ll filter it out. The <code>world</code> object that has all the map data keeps each country object inside a <code>features</code> slot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" data-startfrom="290" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 289;"><span id="cb12-290"><a href="#cb12-290" aria-hidden="true" tabindex="-1"></a>world<span class="op">.</span><span class="at">features</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-10" data-nodetype="expression">

</div>
</div>
</div>
<p>We can filter it using Javascript’s <code>.filter()</code> function. To make sure that the resulting array keeps the geographic-ness of the data and is a <code>FeatureCollection</code>, we need to create a similarly structured object, with <code>type</code> and <code>features</code> slots:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb13" data-startfrom="300" data-source-offset="-34" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="1,2,3,4,12"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 299;"><span id="cb13-300"><a href="#cb13-300" aria-hidden="true" tabindex="-1"></a>world_sans_penguins <span class="op">=</span> ({ </span>
<span id="cb13-301"><a href="#cb13-301" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">"FeatureCollection"</span><span class="op">,</span> </span>
<span id="cb13-302"><a href="#cb13-302" aria-hidden="true" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> world<span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span> <span class="op">!==</span> <span class="st">"ATA"</span>) </span>
<span id="cb13-303"><a href="#cb13-303" aria-hidden="true" tabindex="-1"></a>}) </span>
<span id="cb13-304"><a href="#cb13-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-305"><a href="#cb13-305" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb13-306"><a href="#cb13-306" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()<span class="op">,</span></span>
<span id="cb13-307"><a href="#cb13-307" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb13-308"><a href="#cb13-308" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb13-309"><a href="#cb13-309" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb13-310"><a href="#cb13-310" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">sphere</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean })<span class="op">,</span></span>
<span id="cb13-311"><a href="#cb13-311" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> { </span>
<span id="cb13-312"><a href="#cb13-312" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb13-313"><a href="#cb13-313" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb13-314"><a href="#cb13-314" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb13-315"><a href="#cb13-315" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb13-316"><a href="#cb13-316" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb13-317"><a href="#cb13-317" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-11-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-11-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>That works and Antarctica is gone, as expected, but in reality the map didn’t actually change that much. Even if we stop using the sphere background and just fill the plot frame, we can see that the area where Antarctica was is still there, it’s just missing the land itself:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb14" data-startfrom="323" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="6"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 322;"><span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()<span class="op">,</span></span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span> </span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-12" data-nodetype="expression">

</div>
</div>
</div>
</section><section id="quick-and-dirty-cheating-method-change-the-width-or-height" class="level4"><h4 class="anchored" data-anchor-id="quick-and-dirty-cheating-method-change-the-width-or-height">Quick and dirty cheating method: change the width or height</h4>
<p>One quick and dirty solution is to mess with the dimensions and shrink the height. After some trial and error, 430 pixels looks good:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb15" data-startfrom="345" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="4"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 344;"><span id="cb15-345"><a href="#cb15-345" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb15-346"><a href="#cb15-346" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()<span class="op">,</span></span>
<span id="cb15-347"><a href="#cb15-347" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb15-348"><a href="#cb15-348" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">430</span><span class="op">,</span> </span>
<span id="cb15-349"><a href="#cb15-349" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb15-350"><a href="#cb15-350" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb15-351"><a href="#cb15-351" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb15-352"><a href="#cb15-352" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb15-353"><a href="#cb15-353" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb15-354"><a href="#cb15-354" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb15-355"><a href="#cb15-355" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb15-356"><a href="#cb15-356" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb15-357"><a href="#cb15-357" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-13" data-nodetype="expression">

</div>
</div>
</div>
<p>While this works in this case, <strong>it’s not a universal solution</strong>. The only reason this works is because Antarctica happens to be at the bottom of the map. When you adjust the height of the plot area, the map itself is <em>anchored to the top</em>. Like, if we set the height to 215, we’ll get just the northern hemisphere:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb16" data-startfrom="365" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="4"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 364;"><span id="cb16-365"><a href="#cb16-365" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb16-366"><a href="#cb16-366" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()<span class="op">,</span></span>
<span id="cb16-367"><a href="#cb16-367" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb16-368"><a href="#cb16-368" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">215</span><span class="op">,</span> </span>
<span id="cb16-369"><a href="#cb16-369" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb16-370"><a href="#cb16-370" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb16-371"><a href="#cb16-371" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb16-372"><a href="#cb16-372" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb16-373"><a href="#cb16-373" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb16-374"><a href="#cb16-374" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb16-375"><a href="#cb16-375" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb16-376"><a href="#cb16-376" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb16-377"><a href="#cb16-377" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-14" data-nodetype="expression">

</div>
</div>
</div>
<p>As far as I can tell, there’s no way to anchor the map in any other position. If we filter the map data to only look at one continent, there’s no easy way to focus on just that continent by adjusting only the <code>width</code> or <code>height</code> options. Here’s Africa all by itself in a big empty plot area:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb17" data-startfrom="387" data-source-offset="-1" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="1,2,3,4,9"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 386;"><span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a>just_africa <span class="op">=</span> ({ </span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"FeatureCollection"</span><span class="op">,</span> </span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a>    <span class="dt">features</span><span class="op">:</span> world<span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">continent</span> <span class="op">==</span> <span class="st">"Africa"</span>) </span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a>}) </span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()<span class="op">,</span></span>
<span id="cb17-394"><a href="#cb17-394" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb17-395"><a href="#cb17-395" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">430</span><span class="op">,</span> </span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(just_africa<span class="op">,</span> {</span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-15-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-15-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>If we adjust the width or the height, the plot area will be resized with the map anchored in the top left corner so we’re left with just the northwestern part of Africa (and big empty areas where North America, South America, and Europe would be):</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb18" data-startfrom="410" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="3,4"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 409;"><span id="cb18-410"><a href="#cb18-410" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb18-411"><a href="#cb18-411" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()<span class="op">,</span></span>
<span id="cb18-412"><a href="#cb18-412" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">550</span><span class="op">,</span> </span>
<span id="cb18-413"><a href="#cb18-413" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">215</span><span class="op">,</span> </span>
<span id="cb18-414"><a href="#cb18-414" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb18-415"><a href="#cb18-415" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb18-416"><a href="#cb18-416" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(just_africa<span class="op">,</span> {</span>
<span id="cb18-417"><a href="#cb18-417" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb18-418"><a href="#cb18-418" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb18-419"><a href="#cb18-419" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb18-420"><a href="#cb18-420" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb18-421"><a href="#cb18-421" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb18-422"><a href="#cb18-422" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-16" data-nodetype="expression">

</div>
</div>
</div>
<p>That’s not great, but there are better ways!</p>
</section><section id="built-in-projections-and-domain-settings" class="level4"><h4 class="anchored" data-anchor-id="built-in-projections-and-domain-settings">Built-in projections and domain settings</h4>
<p>The official Observable Plot method for fitting the plot window to a specific area of the map is to define a “domain” for one of the built-in projections to zoom in on specific areas. <a href="https://observablehq.com/plot/features/projections#projections">The documentation shows</a> how to use special functions in <code>d3-geo</code> to create a circle around a point, but you can also pass a GeoJSON object and Plot will use its boundaries for the domain. The built-in projection options also let us control the outside margin of the domain with <code>inset</code>.</p>
<p>Here’s the world map without Antarctica with the Equal Earth projection, with the projection resized to fit within the bounds of <code>world_sans_penguins</code>, with 10 pixels of padding around the landmass. Antarctica is gone now and the rest of the map is vertically centered within the plot area:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb19" data-startfrom="436" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="2,3,4,5,6"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 435;"><span id="cb19-436"><a href="#cb19-436" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb19-437"><a href="#cb19-437" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> { </span>
<span id="cb19-438"><a href="#cb19-438" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"equal-earth"</span><span class="op">,</span> </span>
<span id="cb19-439"><a href="#cb19-439" aria-hidden="true" tabindex="-1"></a>    <span class="dt">domain</span><span class="op">:</span> world_sans_penguins<span class="op">,</span> </span>
<span id="cb19-440"><a href="#cb19-440" aria-hidden="true" tabindex="-1"></a>    <span class="dt">inset</span><span class="op">:</span> <span class="dv">10</span> </span>
<span id="cb19-441"><a href="#cb19-441" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> </span>
<span id="cb19-442"><a href="#cb19-442" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb19-443"><a href="#cb19-443" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb19-444"><a href="#cb19-444" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb19-445"><a href="#cb19-445" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb19-446"><a href="#cb19-446" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb19-447"><a href="#cb19-447" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb19-448"><a href="#cb19-448" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb19-449"><a href="#cb19-449" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-450"><a href="#cb19-450" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb19-451"><a href="#cb19-451" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-17" data-nodetype="expression">

</div>
</div>
</div>
<p>We can see what’s happening behind the scenes if we add <code>Plot.sphere()</code> back in. The rounded globe area is still there, but it’s shifted down and out of the frame. We’re essentially panning around and zooming in on the Equal Earth projection:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb20" data-startfrom="459" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="9,10"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 458;"><span id="cb20-459"><a href="#cb20-459" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb20-460"><a href="#cb20-460" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> {</span>
<span id="cb20-461"><a href="#cb20-461" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"equal-earth"</span><span class="op">,</span></span>
<span id="cb20-462"><a href="#cb20-462" aria-hidden="true" tabindex="-1"></a>    <span class="dt">domain</span><span class="op">:</span> world_sans_penguins<span class="op">,</span> </span>
<span id="cb20-463"><a href="#cb20-463" aria-hidden="true" tabindex="-1"></a>    <span class="dt">inset</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb20-464"><a href="#cb20-464" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb20-465"><a href="#cb20-465" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb20-466"><a href="#cb20-466" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb20-467"><a href="#cb20-467" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span> </span>
<span id="cb20-468"><a href="#cb20-468" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">sphere</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean })<span class="op">,</span> </span>
<span id="cb20-469"><a href="#cb20-469" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb20-470"><a href="#cb20-470" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb20-471"><a href="#cb20-471" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb20-472"><a href="#cb20-472" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb20-473"><a href="#cb20-473" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb20-474"><a href="#cb20-474" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb20-475"><a href="#cb20-475" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-18" data-nodetype="expression">

</div>
</div>
</div>
<p>Passing a GeoJSON object as the domain is really neat because it makes it straightforward to zoom in on specific areas. For instance, here’s the complete medium resolution world map zoomed in around the <code>just_africa</code> object, which keeps non-African countries in the Middle East and southern Europe:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb21" data-startfrom="483" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="4,7,8,11"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 482;"><span id="cb21-483"><a href="#cb21-483" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb21-484"><a href="#cb21-484" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> {</span>
<span id="cb21-485"><a href="#cb21-485" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"equal-earth"</span><span class="op">,</span></span>
<span id="cb21-486"><a href="#cb21-486" aria-hidden="true" tabindex="-1"></a>    <span class="dt">domain</span><span class="op">:</span> just_africa<span class="op">,</span> </span>
<span id="cb21-487"><a href="#cb21-487" aria-hidden="true" tabindex="-1"></a>    <span class="dt">inset</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb21-488"><a href="#cb21-488" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb21-489"><a href="#cb21-489" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span> </span>
<span id="cb21-490"><a href="#cb21-490" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span> </span>
<span id="cb21-491"><a href="#cb21-491" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb21-492"><a href="#cb21-492" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb21-493"><a href="#cb21-493" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_medium<span class="op">,</span> { </span>
<span id="cb21-494"><a href="#cb21-494" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb21-495"><a href="#cb21-495" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb21-496"><a href="#cb21-496" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb21-497"><a href="#cb21-497" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb21-498"><a href="#cb21-498" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb21-499"><a href="#cb21-499" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-19" data-nodetype="expression">

</div>
</div>
</div>
<p>We could also extract Africa from the medium resolution world map and plot only that continent, omitting the Middle East and Europe:</p>
<div class="cell" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb22" data-startfrom="509" data-source-offset="-1" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="1,2,3,4,15,16,17,18"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 508;"><span id="cb22-509"><a href="#cb22-509" aria-hidden="true" tabindex="-1"></a>just_africa_medium <span class="op">=</span> ({ </span>
<span id="cb22-510"><a href="#cb22-510" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"FeatureCollection"</span><span class="op">,</span> </span>
<span id="cb22-511"><a href="#cb22-511" aria-hidden="true" tabindex="-1"></a>    <span class="dt">features</span><span class="op">:</span> world_medium<span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">continent</span> <span class="op">==</span> <span class="st">"Africa"</span>) </span>
<span id="cb22-512"><a href="#cb22-512" aria-hidden="true" tabindex="-1"></a>}) </span>
<span id="cb22-513"><a href="#cb22-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-514"><a href="#cb22-514" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb22-515"><a href="#cb22-515" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> {</span>
<span id="cb22-516"><a href="#cb22-516" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"equal-earth"</span><span class="op">,</span></span>
<span id="cb22-517"><a href="#cb22-517" aria-hidden="true" tabindex="-1"></a>    <span class="dt">domain</span><span class="op">:</span> just_africa<span class="op">,</span></span>
<span id="cb22-518"><a href="#cb22-518" aria-hidden="true" tabindex="-1"></a>    <span class="dt">inset</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb22-519"><a href="#cb22-519" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb22-520"><a href="#cb22-520" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span></span>
<span id="cb22-521"><a href="#cb22-521" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span></span>
<span id="cb22-522"><a href="#cb22-522" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb22-523"><a href="#cb22-523" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use a white background since we don't want to make it look like  </span></span>
<span id="cb22-524"><a href="#cb22-524" aria-hidden="true" tabindex="-1"></a>    <span class="co">// the Sinai peninsula has a coastline  </span></span>
<span id="cb22-525"><a href="#cb22-525" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span> </span>
<span id="cb22-526"><a href="#cb22-526" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(just_africa_medium<span class="op">,</span> {  </span>
<span id="cb22-527"><a href="#cb22-527" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb22-528"><a href="#cb22-528" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb22-529"><a href="#cb22-529" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb22-530"><a href="#cb22-530" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb22-531"><a href="#cb22-531" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb22-532"><a href="#cb22-532" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-20-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-20-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
</section><section id="other-projections-and-.fitextent" class="level4"><h4 class="anchored" data-anchor-id="other-projections-and-.fitextent">Other projections and <code>.fitExtent()</code>
</h4>
<p>Unfortunately, it’s a little bit trickier to set the domain and inset for projections that aren’t built in to Plot. We <em>can’t</em> do this:</p>
<div class="sourceCode" id="cb23" data-code-line-numbers=""><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()<span class="op">,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">domain</span><span class="op">:</span> world_sans_penguins<span class="op">,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">inset</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Instead, we need to adjust the size of the projection window itself and build in the inset with <a href="https://d3js.org/d3-geo/projection#projection_fitExtent"><code>d3-geo</code>’s <code>.fitExtent()</code></a>. This function takes four arguments in an array like <code>[[x1, y1], [x2, y2]]</code>, defining the top left and bottom right corners (in pixels) of a window that is centered in the middle of a given GeoJSON object. Here, for instance, we create a copy of the Robinson projection that has a window around <code>just_africa</code> with a top left corner at (30, 30) and a bottom right corner at (570, 570):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" data-startfrom="553" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 552;"><span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a>inset_africa <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a>africa_map_width <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a>africa_map_height <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb24-556"><a href="#cb24-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a>africa_robinson <span class="op">=</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()</span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">fitExtent</span>(</span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a>    [[inset_africa<span class="op">,</span> inset_africa]<span class="op">,</span>  <span class="co">// Top left</span></span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a>     [africa_map_width <span class="op">-</span> inset_africa<span class="op">,</span> africa_map_height <span class="op">-</span> inset_africa]]<span class="op">,</span>  <span class="co">// Bottom right </span></span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>    just_africa</span>
<span id="cb24-562"><a href="#cb24-562" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-563"><a href="#cb24-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-564"><a href="#cb24-564" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb24-565"><a href="#cb24-565" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> africa_robinson<span class="op">,</span></span>
<span id="cb24-566"><a href="#cb24-566" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> africa_map_width<span class="op">,</span></span>
<span id="cb24-567"><a href="#cb24-567" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> africa_map_height<span class="op">,</span></span>
<span id="cb24-568"><a href="#cb24-568" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb24-569"><a href="#cb24-569" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb24-570"><a href="#cb24-570" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb24-571"><a href="#cb24-571" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb24-572"><a href="#cb24-572" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb24-573"><a href="#cb24-573" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb24-574"><a href="#cb24-574" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb24-575"><a href="#cb24-575" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb24-576"><a href="#cb24-576" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-21-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-21-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-21-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-21-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-21-5" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>We can use the same approach with individual countries. For extra fun, we’ll fill these countries with distinct colors using Natural Earth’s <code>mapcolor7</code> column, which assigns countries one of 7 different colors that don’t border other countries (so neighboring countries will never be the same color). We’ll also add some labels in the middle of each country.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" data-startfrom="582" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 581;"><span id="cb25-582"><a href="#cb25-582" aria-hidden="true" tabindex="-1"></a>egypt <span class="op">=</span> world_medium<span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name</span> <span class="op">===</span> <span class="st">"Egypt"</span>)</span>
<span id="cb25-583"><a href="#cb25-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-584"><a href="#cb25-584" aria-hidden="true" tabindex="-1"></a>inset_egypt <span class="op">=</span> <span class="dv">75</span></span>
<span id="cb25-585"><a href="#cb25-585" aria-hidden="true" tabindex="-1"></a>egypt_map_width <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb25-586"><a href="#cb25-586" aria-hidden="true" tabindex="-1"></a>egypt_map_height <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb25-587"><a href="#cb25-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-588"><a href="#cb25-588" aria-hidden="true" tabindex="-1"></a>robinson_egypt <span class="op">=</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()</span>
<span id="cb25-589"><a href="#cb25-589" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">fitExtent</span>(</span>
<span id="cb25-590"><a href="#cb25-590" aria-hidden="true" tabindex="-1"></a>    [[inset_egypt<span class="op">,</span> inset_egypt]<span class="op">,</span>  <span class="co">// Top left</span></span>
<span id="cb25-591"><a href="#cb25-591" aria-hidden="true" tabindex="-1"></a>     [egypt_map_width <span class="op">-</span> inset_egypt<span class="op">,</span> egypt_map_height <span class="op">-</span> inset_egypt]]<span class="op">,</span>  <span class="co">// Bottom right</span></span>
<span id="cb25-592"><a href="#cb25-592" aria-hidden="true" tabindex="-1"></a>    egypt</span>
<span id="cb25-593"><a href="#cb25-593" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-594"><a href="#cb25-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-595"><a href="#cb25-595" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb25-596"><a href="#cb25-596" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> robinson_egypt<span class="op">,</span></span>
<span id="cb25-597"><a href="#cb25-597" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> egypt_map_width<span class="op">,</span></span>
<span id="cb25-598"><a href="#cb25-598" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> egypt_map_height<span class="op">,</span></span>
<span id="cb25-599"><a href="#cb25-599" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb25-600"><a href="#cb25-600" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb25-601"><a href="#cb25-601" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_medium<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb25-602"><a href="#cb25-602" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">mapcolor7</span><span class="op">,</span></span>
<span id="cb25-603"><a href="#cb25-603" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> </span>
<span id="cb25-604"><a href="#cb25-604" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb25-605"><a href="#cb25-605" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb25-606"><a href="#cb25-606" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(egypt<span class="op">,</span> { <span class="dt">stroke</span><span class="op">:</span> <span class="st">"yellow"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">3</span> })<span class="op">,</span></span>
<span id="cb25-607"><a href="#cb25-607" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">tip</span>(world_medium<span class="op">.</span><span class="at">features</span><span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb25-608"><a href="#cb25-608" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name</span><span class="op">,</span> </span>
<span id="cb25-609"><a href="#cb25-609" aria-hidden="true" tabindex="-1"></a>      <span class="dt">anchor</span><span class="op">:</span> <span class="st">"top"</span><span class="op">,</span></span>
<span id="cb25-610"><a href="#cb25-610" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">13</span><span class="op">,</span></span>
<span id="cb25-611"><a href="#cb25-611" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb25-612"><a href="#cb25-612" aria-hidden="true" tabindex="-1"></a>      <span class="dt">textPadding</span><span class="op">:</span> <span class="dv">3</span></span>
<span id="cb25-613"><a href="#cb25-613" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb25-614"><a href="#cb25-614" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb25-615"><a href="#cb25-615" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb25-616"><a href="#cb25-616" aria-hidden="true" tabindex="-1"></a>    <span class="dt">range</span><span class="op">:</span> carto_prism</span>
<span id="cb25-617"><a href="#cb25-617" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-618"><a href="#cb25-618" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-22-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-22-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-22-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-22-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-22-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-22-6" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>The approach works for the whole <code>world_sans_penguins</code> object as well. This addresses our original problem—here’s a world map with the Robinson projection <em>without</em> Antarctica that fills the plot area correctly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" data-startfrom="625" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 624;"><span id="cb26-625"><a href="#cb26-625" aria-hidden="true" tabindex="-1"></a>inset_world <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb26-626"><a href="#cb26-626" aria-hidden="true" tabindex="-1"></a>world_map_width <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb26-627"><a href="#cb26-627" aria-hidden="true" tabindex="-1"></a>world_map_height <span class="op">=</span> <span class="dv">450</span></span>
<span id="cb26-628"><a href="#cb26-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-629"><a href="#cb26-629" aria-hidden="true" tabindex="-1"></a>world_sans_penguins_robinson <span class="op">=</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()</span>
<span id="cb26-630"><a href="#cb26-630" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">fitExtent</span>(</span>
<span id="cb26-631"><a href="#cb26-631" aria-hidden="true" tabindex="-1"></a>    [[inset_world<span class="op">,</span> inset_world]<span class="op">,</span></span>
<span id="cb26-632"><a href="#cb26-632" aria-hidden="true" tabindex="-1"></a>     [world_map_width <span class="op">-</span> inset_world<span class="op">,</span> world_map_height <span class="op">-</span> inset_world]]<span class="op">,</span></span>
<span id="cb26-633"><a href="#cb26-633" aria-hidden="true" tabindex="-1"></a>    world_sans_penguins</span>
<span id="cb26-634"><a href="#cb26-634" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-635"><a href="#cb26-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-636"><a href="#cb26-636" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb26-637"><a href="#cb26-637" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb26-638"><a href="#cb26-638" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb26-639"><a href="#cb26-639" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb26-640"><a href="#cb26-640" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb26-641"><a href="#cb26-641" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb26-642"><a href="#cb26-642" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb26-643"><a href="#cb26-643" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb26-644"><a href="#cb26-644" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb26-645"><a href="#cb26-645" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> clr_land</span>
<span id="cb26-646"><a href="#cb26-646" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb26-647"><a href="#cb26-647" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb26-648"><a href="#cb26-648" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-23-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-23-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-23-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-23-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-23-5" data-nodetype="expression">

</div>
</div>
</div>
</div>
</section><section id="arbitrary-areas-and-.fitextent" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="arbitrary-areas-and-.fitextent">Arbitrary areas and <code>.fitExtent()</code>
</h4>
<p>For bonus fun, this approach also works for any arbitrary rectangles. For example, we can use <a href="https://www.openstreetmap.org/export#map=4/49.07/4.00">OpenStreetMap’s neat Export tool</a> to pick the top, bottom, left, and right edges of a box that focuses on Western Europe.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="img/osm-export.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="margin-caption">Rectangle around western Europe with OpenStreetMap’s Export tool</figcaption></figure>
</div>
<p>We can then use those coordinates to create a <code>MultiPoint</code> geometric feature/object, which essentially acts like a rectangular fake country/region that can be used as the domain or extent of the map:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" data-startfrom="660" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 659;"><span id="cb27-660"><a href="#cb27-660" aria-hidden="true" tabindex="-1"></a>inset_europe <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb27-661"><a href="#cb27-661" aria-hidden="true" tabindex="-1"></a>europe_map_width <span class="op">=</span> <span class="dv">800</span></span>
<span id="cb27-662"><a href="#cb27-662" aria-hidden="true" tabindex="-1"></a>europe_map_height <span class="op">=</span> <span class="dv">800</span></span>
<span id="cb27-663"><a href="#cb27-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-664"><a href="#cb27-664" aria-hidden="true" tabindex="-1"></a>europe_box <span class="op">=</span> ({</span>
<span id="cb27-665"><a href="#cb27-665" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">"Feature"</span><span class="op">,</span></span>
<span id="cb27-666"><a href="#cb27-666" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> {</span>
<span id="cb27-667"><a href="#cb27-667" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"MultiPoint"</span><span class="op">,</span></span>
<span id="cb27-668"><a href="#cb27-668" aria-hidden="true" tabindex="-1"></a>    <span class="dt">coordinates</span><span class="op">:</span> [</span>
<span id="cb27-669"><a href="#cb27-669" aria-hidden="true" tabindex="-1"></a>      [<span class="op">-</span><span class="dv">13</span><span class="op">,</span> <span class="dv">35</span>]<span class="op">,</span>  <span class="co">// [left/west, bottom/south] (or bottom left corner)</span></span>
<span id="cb27-670"><a href="#cb27-670" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">21</span><span class="op">,</span> <span class="dv">60</span>]    <span class="co">// [right/east, top/north]   (or top right corner)</span></span>
<span id="cb27-671"><a href="#cb27-671" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb27-672"><a href="#cb27-672" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-673"><a href="#cb27-673" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb27-674"><a href="#cb27-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-675"><a href="#cb27-675" aria-hidden="true" tabindex="-1"></a>europe_robinson <span class="op">=</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()</span>
<span id="cb27-676"><a href="#cb27-676" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">fitExtent</span>(</span>
<span id="cb27-677"><a href="#cb27-677" aria-hidden="true" tabindex="-1"></a>    [[inset_europe<span class="op">,</span> inset_europe]<span class="op">,</span></span>
<span id="cb27-678"><a href="#cb27-678" aria-hidden="true" tabindex="-1"></a>     [europe_map_width <span class="op">-</span> inset_europe<span class="op">,</span> europe_map_height <span class="op">-</span> inset_europe]]<span class="op">,</span> </span>
<span id="cb27-679"><a href="#cb27-679" aria-hidden="true" tabindex="-1"></a>    europe_box</span>
<span id="cb27-680"><a href="#cb27-680" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-681"><a href="#cb27-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-682"><a href="#cb27-682" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb27-683"><a href="#cb27-683" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> europe_robinson<span class="op">,</span></span>
<span id="cb27-684"><a href="#cb27-684" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> europe_map_width<span class="op">,</span></span>
<span id="cb27-685"><a href="#cb27-685" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> europe_map_height<span class="op">,</span></span>
<span id="cb27-686"><a href="#cb27-686" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb27-687"><a href="#cb27-687" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">fill</span><span class="op">:</span> clr_ocean<span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span></span>
<span id="cb27-688"><a href="#cb27-688" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_medium<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb27-689"><a href="#cb27-689" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">mapcolor9</span><span class="op">,</span></span>
<span id="cb27-690"><a href="#cb27-690" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span> </span>
<span id="cb27-691"><a href="#cb27-691" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.25</span></span>
<span id="cb27-692"><a href="#cb27-692" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb27-693"><a href="#cb27-693" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">tip</span>(world<span class="op">.</span><span class="at">features</span><span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb27-694"><a href="#cb27-694" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name</span><span class="op">,</span> </span>
<span id="cb27-695"><a href="#cb27-695" aria-hidden="true" tabindex="-1"></a>      <span class="dt">anchor</span><span class="op">:</span> <span class="st">"bottom"</span><span class="op">,</span></span>
<span id="cb27-696"><a href="#cb27-696" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">13</span><span class="op">,</span></span>
<span id="cb27-697"><a href="#cb27-697" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb27-698"><a href="#cb27-698" aria-hidden="true" tabindex="-1"></a>      <span class="dt">textPadding</span><span class="op">:</span> <span class="dv">3</span></span>
<span id="cb27-699"><a href="#cb27-699" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb27-700"><a href="#cb27-700" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb27-701"><a href="#cb27-701" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb27-702"><a href="#cb27-702" aria-hidden="true" tabindex="-1"></a>    <span class="dt">range</span><span class="op">:</span> carto_prism</span>
<span id="cb27-703"><a href="#cb27-703" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-704"><a href="#cb27-704" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-24-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-24-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-24-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-24-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-24-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-24-6" data-nodetype="expression">

</div>
</div>
</div>
</div>
</section></section></section><section id="working-with-usaid-data" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="working-with-usaid-data">Working with USAID data</h2>
<section id="get-usaid-data" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="get-usaid-data">Get USAID data</h3>
<p>To make it easier to access and filter and manipulate things, I put the rescued data on a <a href="https://datasette.io/">Datasette</a> instance, which is nice front-end for an SQLite database. This makes it possible to run SQL queries directly in the browser and generate custom datasets without needing to load the full massive CSV files into R or Python or Stata or whatever.</p>
<p>For example, one of the rescued USAID datasets is named <a href="https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance/~2E~2Fus_foreign_aid_country"><code>us_foreign_aid_country</code></a> and it contains 22,000+ rows, with data on aid obligations, appropriations, and disbursements starting in 1999.</p>
<p>If we want to get a total of all constant USD aid obligations by country in 2023, omitting regional and world totals, we could do something like this with R and {dplyr}:</p>
<div class="cell">
<div class="sourceCode" id="cb28" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download the raw CSV and put it somewhere</span></span>
<span><span class="va">us_foreign_aid_country</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"us_foreign_aid_country.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_foreign_aid_country</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">`Fiscal Year`</span> <span class="op">==</span> <span class="fl">2023</span>, </span>
<span>    <span class="va">`Transaction Type Name`</span> <span class="op">==</span> <span class="st">"Obligations"</span>,</span>
<span>    <span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">`Country Name`</span>, <span class="st">"Region"</span><span class="op">)</span>,</span>
<span>    <span class="va">`Country Name`</span> <span class="op">!=</span> <span class="st">"World"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">`Country Code`</span>, <span class="va">`Country Name`</span>, <span class="va">`Region Name`</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>total_constant_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">constant_amount</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">total_constant_amount</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  A tibble: 176 × 4</span></span>
<span><span class="co">#&gt;  Groups:   Country Code, Country Name [176]</span></span>
<span><span class="co">#&gt;   `Country Code` `Country Name`   `Region Name`                total_constant_amount</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt;            &lt;chr&gt;                                        &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 UKR            Ukraine          Europe and Eurasia                     17193710403</span></span>
<span><span class="co">#&gt; 2 ISR            Israel           Middle East and North Africa            3302860882</span></span>
<span><span class="co">#&gt; 3 JOR            Jordan           Middle East and North Africa            1686862605</span></span>
<span><span class="co">#&gt; 4 EGY            Egypt            Middle East and North Africa            1503609426</span></span>
<span><span class="co">#&gt; 5 ETH            Ethiopia         Sub-Saharan Africa                      1457374911</span></span>
<span><span class="co">#&gt; 6 SOM            Somalia          Sub-Saharan Africa                      1181033990</span></span>
<span><span class="co">#&gt; 7 NGA            Nigeria          Sub-Saharan Africa                      1019947490</span></span>
<span><span class="co">#&gt; 8 COD            Congo (Kinshasa) Sub-Saharan Africa                       990456757</span></span>
<span><span class="co">#&gt; 9 AFG            Afghanistan      South and Central Asia                   886536741</span></span>
<span><span class="co">#&gt; 0 KEN            Kenya            Sub-Saharan Africa                       846303488</span></span>
<span><span class="co">#&gt;  ℹ 166 more rows</span></span>
<span><span class="co">#&gt;  ℹ Use `print(n = ...)` to see more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or we could get that data extract directly from the database without needing to load the huge original CSV file. We can run <a href="https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance?sql=SELECT+%22Country+Code%22%2C+%22Country+Name%22%2C+%22Region+Name%22%2C+SUM%28%22constant_amount%22%29+AS+total_constant_amount%0D%0A++FROM+%22.%2Fus_foreign_aid_country%22%0D%0A++WHERE+%22Fiscal+Year%22+%3D+%272023%27+%0D%0A++++AND+%22Transaction+Type+Name%22+%3D+%27Obligations%27+%0D%0A++++AND+%22Country+Name%22+NOT+LIKE+%27%25Region%25%27+%0D%0A++++AND+%22Country+Name%22+%21%3D+%22World%22%0D%0A++GROUP+BY+%22Country+Code%22%2C+%22Country+Name%22%2C+%22Region+Name%22%0D%0A++ORDER+BY+total_constant_amount+DESC%3B">an SQL query like this</a> at the Datasette website:</p>
<div class="sourceCode" id="cb29" data-code-line-numbers=""><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="ot">"Country Code"</span>, <span class="ot">"Country Name"</span>, <span class="ot">"Region Name"</span>, <span class="fu">SUM</span>(<span class="ot">"constant_amount"</span>) <span class="kw">AS</span> total_constant_amount</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> <span class="ot">"./us_foreign_aid_country"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">"Fiscal Year"</span> <span class="op">=</span> <span class="st">'2023'</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="ot">"Transaction Type Name"</span> <span class="op">=</span> <span class="st">'Obligations'</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="ot">"Country Name"</span> <span class="kw">NOT</span> <span class="kw">LIKE</span> <span class="st">'%Region%'</span> </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="ot">"Country Name"</span> <span class="op">!=</span> <span class="ot">"World"</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="ot">"Country Code"</span>, <span class="ot">"Country Name"</span>, <span class="ot">"Region Name"</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> total_constant_amount <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="img/datasette-query.png" class="border img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="margin-caption">SQL query and results</figcaption></figure>
</div>
<p>Since we’re working with interactive Observable Javascript, we can load that data directly into the browser instead of downloading intermediate CSV files. There’s a neat <a href="https://observablehq.com/@ambassadors/datasette-client">Datasette database client</a> for Observable that lets us run SQL queries (there are <a href="https://observablehq.com/documentation/data/databases/database-clients">lots of other clients too</a>, if you want to connect to things like DuckDB, SQLite, MySQL, Snowflake, and so on).</p>
<div class="cell" data-eval="false">
<div class="sourceCode cell-code" id="cb30" data-startfrom="776" data-source-offset="-59" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 775;"><span id="cb30-776"><a href="#cb30-776" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { DatasetteClient } <span class="im">from</span> <span class="st">"@ambassadors/datasette-client"</span></span>
<span id="cb30-777"><a href="#cb30-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-778"><a href="#cb30-778" aria-hidden="true" tabindex="-1"></a>aid_db <span class="op">=</span> <span class="kw">new</span> <span class="fu">DatasetteClient</span>(</span>
<span id="cb30-779"><a href="#cb30-779" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance"</span></span>
<span id="cb30-780"><a href="#cb30-780" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-781"><a href="#cb30-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-782"><a href="#cb30-782" aria-hidden="true" tabindex="-1"></a>recipient_countries <span class="op">=</span> <span class="cf">await</span> aid_db<span class="op">.</span><span class="fu">sql</span><span class="vs">`</span></span>
<span id="cb30-783"><a href="#cb30-783" aria-hidden="true" tabindex="-1"></a><span class="vs">  SELECT "Country Code", "Country Name", "Region Name", SUM("constant_amount") AS total_constant_amount</span></span>
<span id="cb30-784"><a href="#cb30-784" aria-hidden="true" tabindex="-1"></a><span class="vs">  FROM "./us_foreign_aid_country"</span></span>
<span id="cb30-785"><a href="#cb30-785" aria-hidden="true" tabindex="-1"></a><span class="vs">  WHERE </span></span>
<span id="cb30-786"><a href="#cb30-786" aria-hidden="true" tabindex="-1"></a><span class="vs">    "Fiscal Year" = '2023' </span></span>
<span id="cb30-787"><a href="#cb30-787" aria-hidden="true" tabindex="-1"></a><span class="vs">    AND "Transaction Type Name" = 'Obligations' </span></span>
<span id="cb30-788"><a href="#cb30-788" aria-hidden="true" tabindex="-1"></a><span class="vs">    AND "Country Name" NOT LIKE '%Region%' </span></span>
<span id="cb30-789"><a href="#cb30-789" aria-hidden="true" tabindex="-1"></a><span class="vs">    AND "Country Name" != "World"</span></span>
<span id="cb30-790"><a href="#cb30-790" aria-hidden="true" tabindex="-1"></a><span class="vs">  GROUP BY "Country Code", "Country Name", "Region Name"</span></span>
<span id="cb30-791"><a href="#cb30-791" aria-hidden="true" tabindex="-1"></a><span class="vs">  ORDER BY total_constant_amount DESC;</span></span>
<span id="cb30-792"><a href="#cb30-792" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-25-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-25-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-25-3" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<p>Through the magic of this Datasette client, we now have a pre-summarized dataset to work with!</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb31" data-startfrom="798" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 797;"><span id="cb31-798"><a href="#cb31-798" aria-hidden="true" tabindex="-1"></a><span class="co">// I don't want to keep hitting the Datasette server with requests, so I'm </span></span>
<span id="cb31-799"><a href="#cb31-799" aria-hidden="true" tabindex="-1"></a><span class="co">// cheating and loading a CSV extract instead. It comes from this query: </span></span>
<span id="cb31-800"><a href="#cb31-800" aria-hidden="true" tabindex="-1"></a><span class="co">// https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance.csv?sql=SELECT+%22Country+Code%22%2C+%22Country+Name%22%2C+%22Region+Name%22%2C+SUM%28%22constant_amount%22%29+AS+total_constant_amount%0D%0A++FROM+%22.%2Fus_foreign_aid_country%22%0D%0A++WHERE+%22Fiscal+Year%22+%3D+%272023%27+%0D%0A++++AND+%22Transaction+Type+Name%22+%3D+%27Obligations%27+%0D%0A++++AND+%22Country+Name%22+NOT+LIKE+%27%25Region%25%27+%0D%0A++++AND+%22Country+Name%22+%21%3D+%22World%22%0D%0A++GROUP+BY+%22Country+Code%22%2C+%22Country+Name%22%2C+%22Region+Name%22%0D%0A++ORDER+BY+total_constant_amount+DESC%3B&amp;_size=max</span></span>
<span id="cb31-801"><a href="#cb31-801" aria-hidden="true" tabindex="-1"></a>recipient_countries <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(<span class="st">"recipient_countries.csv"</span>)<span class="op">.</span><span class="fu">csv</span>({ <span class="dt">typed</span><span class="op">:</span> <span class="kw">true</span> })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-26" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" data-startfrom="806" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 805;"><span id="cb32-806"><a href="#cb32-806" aria-hidden="true" tabindex="-1"></a>recipient_countries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-27" data-nodetype="expression">

</div>
</div>
</div>
</section></section><section id="connect-usaid-data-to-the-map-data" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="connect-usaid-data-to-the-map-data">Connect USAID data to the map data</h2>
<p><a href="https://observablehq.com/@observablehq/build-your-first-choropleth-map-with-observable-plot#cell-434">Following Observable Plot’s choropleth tutorial</a>, to show these totals on a map, we need to create a <code>Map</code> object,<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> which is like a Python dictionary or an R data frame with two columns, where we have (1) a name that shares a name with something in the geographic data, like an ISO3 country code, and (2) a value with the thing we want to plot.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;This term is admittedly confusing because it has nothing to do with geographic maps and is <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">instead related to functional programming</a>.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb33" data-startfrom="815" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 814;"><span id="cb33-815"><a href="#cb33-815" aria-hidden="true" tabindex="-1"></a>country_totals <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(recipient_countries<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> [d[<span class="st">"Country Code"</span>]<span class="op">,</span> d<span class="op">.</span><span class="at">total_constant_amount</span>]))</span>
<span id="cb33-816"><a href="#cb33-816" aria-hidden="true" tabindex="-1"></a>country_totals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-28-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-28-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>This lets us get specific totals with the <code>.get()</code> method. Here’s Ukraine, for example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" data-startfrom="821" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 820;"><span id="cb34-821"><a href="#cb34-821" aria-hidden="true" tabindex="-1"></a>country_totals<span class="op">.</span><span class="fu">get</span>(<span class="st">"UKR"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-29" data-nodetype="expression">

</div>
</div>
</div>
<p>We can feed the ISO3 code of each country-level geographic shape into this <code>country_totals</code> object to extract the total amount of aid for each country. We’ll use the Antarctica-free Robinson projection we made earlier, and we’ll remove the ocean fill since we’ll ultimately make this interactive and hoverable:</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb35" data-startfrom="828" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 827;"><span id="cb35-828"><a href="#cb35-828" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb35-829"><a href="#cb35-829" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb35-830"><a href="#cb35-830" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb35-831"><a href="#cb35-831" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb35-832"><a href="#cb35-832" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb35-833"><a href="#cb35-833" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span>} )<span class="op">,</span></span>
<span id="cb35-834"><a href="#cb35-834" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb35-835"><a href="#cb35-835" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> country_totals<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span>)</span>
<span id="cb35-836"><a href="#cb35-836" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb35-837"><a href="#cb35-837" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb35-838"><a href="#cb35-838" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display column-body-outset">
<div id="ojs-cell-30" data-nodetype="expression">

</div>
</div>
</div>
<section id="improving-the-map" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="improving-the-map">Improving the map</h3>
<p>We have a choropleth! But this is hardly publication worthy. We need to fix a bunch of issues with it.</p>
<p>First, countries that don’t receive aid don’t appear in the map. Let’s add borders to all the countries:</p>
<div class="cell page-columns page-full" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb36" data-startfrom="851" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="10,11,12,13"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 850;"><span id="cb36-851"><a href="#cb36-851" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb36-852"><a href="#cb36-852" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb36-853"><a href="#cb36-853" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb36-854"><a href="#cb36-854" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb36-855"><a href="#cb36-855" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb36-856"><a href="#cb36-856" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span>} )<span class="op">,</span></span>
<span id="cb36-857"><a href="#cb36-857" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb36-858"><a href="#cb36-858" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> country_totals<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span>)</span>
<span id="cb36-859"><a href="#cb36-859" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb36-860"><a href="#cb36-860" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {  </span>
<span id="cb36-861"><a href="#cb36-861" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span>  </span>
<span id="cb36-862"><a href="#cb36-862" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span>  </span>
<span id="cb36-863"><a href="#cb36-863" aria-hidden="true" tabindex="-1"></a>    })  </span>
<span id="cb36-864"><a href="#cb36-864" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb36-865"><a href="#cb36-865" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display column-body-outset">
<div id="ojs-cell-31" data-nodetype="expression">

</div>
</div>
</div>
<p>The coloring here is gross because of some huge outliers (Ukraine) that make most countries black/dark blue. There’s also no legend to show what these values are. We can address all of this by <a href="https://observablehq.com/plot/features/legends#legend-options">adjusting the legend options</a>. We’ll log total aid, include the legend, add a nice label, and use a <a href="https://observablehq.com/plot/features/scales#color-scales">single-hue coloring scheme</a> with gray for countries without aid:</p>
<div class="cell page-columns page-full" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb37" data-startfrom="874" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="15,16,17,18,19,20,21"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 873;"><span id="cb37-874"><a href="#cb37-874" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb37-875"><a href="#cb37-875" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb37-876"><a href="#cb37-876" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb37-877"><a href="#cb37-877" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb37-878"><a href="#cb37-878" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb37-879"><a href="#cb37-879" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span>} )<span class="op">,</span></span>
<span id="cb37-880"><a href="#cb37-880" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb37-881"><a href="#cb37-881" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> country_totals<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span>)</span>
<span id="cb37-882"><a href="#cb37-882" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb37-883"><a href="#cb37-883" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb37-884"><a href="#cb37-884" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb37-885"><a href="#cb37-885" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb37-886"><a href="#cb37-886" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb37-887"><a href="#cb37-887" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb37-888"><a href="#cb37-888" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> {  </span>
<span id="cb37-889"><a href="#cb37-889" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scheme</span><span class="op">:</span> <span class="st">"blues"</span><span class="op">,</span>  </span>
<span id="cb37-890"><a href="#cb37-890" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unknown</span><span class="op">:</span> <span class="st">"#f2f2f2"</span><span class="op">,</span>  </span>
<span id="cb37-891"><a href="#cb37-891" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span>   </span>
<span id="cb37-892"><a href="#cb37-892" aria-hidden="true" tabindex="-1"></a>    <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>  </span>
<span id="cb37-893"><a href="#cb37-893" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Total obligations"</span><span class="op">,</span>  </span>
<span id="cb37-894"><a href="#cb37-894" aria-hidden="true" tabindex="-1"></a>  }  </span>
<span id="cb37-895"><a href="#cb37-895" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display column-body-outset">
<div id="ojs-cell-32" data-nodetype="expression">

</div>
</div>
</div>
<p>Next, let’s make this interactive by turning on <a href="https://observablehq.com/plot/marks/tip">hovering tooltips</a>:</p>
<div class="cell page-columns page-full" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb38" data-startfrom="904" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="9"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 903;"><span id="cb38-904"><a href="#cb38-904" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb38-905"><a href="#cb38-905" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb38-906"><a href="#cb38-906" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb38-907"><a href="#cb38-907" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb38-908"><a href="#cb38-908" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb38-909"><a href="#cb38-909" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span>} )<span class="op">,</span></span>
<span id="cb38-910"><a href="#cb38-910" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb38-911"><a href="#cb38-911" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> country_totals<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span>)<span class="op">,</span></span>
<span id="cb38-912"><a href="#cb38-912" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span> </span>
<span id="cb38-913"><a href="#cb38-913" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb38-914"><a href="#cb38-914" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb38-915"><a href="#cb38-915" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb38-916"><a href="#cb38-916" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb38-917"><a href="#cb38-917" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb38-918"><a href="#cb38-918" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb38-919"><a href="#cb38-919" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb38-920"><a href="#cb38-920" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scheme</span><span class="op">:</span> <span class="st">"blues"</span><span class="op">,</span></span>
<span id="cb38-921"><a href="#cb38-921" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unknown</span><span class="op">:</span> <span class="st">"#f2f2f2"</span><span class="op">,</span></span>
<span id="cb38-922"><a href="#cb38-922" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> </span>
<span id="cb38-923"><a href="#cb38-923" aria-hidden="true" tabindex="-1"></a>    <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb38-924"><a href="#cb38-924" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Total obligations"</span><span class="op">,</span></span>
<span id="cb38-925"><a href="#cb38-925" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-926"><a href="#cb38-926" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display column-body-outset">
<div id="ojs-cell-33" data-nodetype="expression">

</div>
</div>
</div>
<p>That’s so cool. Hover over Mexico and you’ll see “<strong>Total obligations</strong> 232,214,023”.</p>
<p>We can make this tooltip more informative by including the country name and formatting the amount to show dollars. Instead of using <code>tip: true</code>, we can add the country name as a channel (Observable Plot’s version of a ggplot aesthetic), and format the tip so that the country name comes first and the total amount is <a href="https://observablehq.com/plot/features/formats">formatted</a> with <a href="https://d3js.org/d3-format"><code>d3.format()</code></a>:</p>
<div class="cell page-columns page-full" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb39" data-startfrom="937" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="9,10,11,12,13,14,15,16,17"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 936;"><span id="cb39-937"><a href="#cb39-937" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb39-938"><a href="#cb39-938" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb39-939"><a href="#cb39-939" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb39-940"><a href="#cb39-940" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb39-941"><a href="#cb39-941" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb39-942"><a href="#cb39-942" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span>} )<span class="op">,</span></span>
<span id="cb39-943"><a href="#cb39-943" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb39-944"><a href="#cb39-944" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> country_totals<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span>)<span class="op">,</span></span>
<span id="cb39-945"><a href="#cb39-945" aria-hidden="true" tabindex="-1"></a>      <span class="dt">channels</span><span class="op">:</span> { </span>
<span id="cb39-946"><a href="#cb39-946" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Country</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name</span><span class="op">,</span> </span>
<span id="cb39-947"><a href="#cb39-947" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> </span>
<span id="cb39-948"><a href="#cb39-948" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tip</span><span class="op">:</span> { </span>
<span id="cb39-949"><a href="#cb39-949" aria-hidden="true" tabindex="-1"></a>        <span class="dt">format</span><span class="op">:</span> { </span>
<span id="cb39-950"><a href="#cb39-950" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Country</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> </span>
<span id="cb39-951"><a href="#cb39-951" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"$,d"</span>) </span>
<span id="cb39-952"><a href="#cb39-952" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb39-953"><a href="#cb39-953" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb39-954"><a href="#cb39-954" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb39-955"><a href="#cb39-955" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb39-956"><a href="#cb39-956" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb39-957"><a href="#cb39-957" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb39-958"><a href="#cb39-958" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb39-959"><a href="#cb39-959" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb39-960"><a href="#cb39-960" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb39-961"><a href="#cb39-961" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scheme</span><span class="op">:</span> <span class="st">"blues"</span><span class="op">,</span></span>
<span id="cb39-962"><a href="#cb39-962" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unknown</span><span class="op">:</span> <span class="st">"#f2f2f2"</span><span class="op">,</span></span>
<span id="cb39-963"><a href="#cb39-963" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> </span>
<span id="cb39-964"><a href="#cb39-964" aria-hidden="true" tabindex="-1"></a>    <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb39-965"><a href="#cb39-965" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Total obligations"</span><span class="op">,</span></span>
<span id="cb39-966"><a href="#cb39-966" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-967"><a href="#cb39-967" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display column-body-outset">
<div id="ojs-cell-34" data-nodetype="expression">

</div>
</div>
</div>
<p>Now hover over Mexico and you’ll see the country name and the amount of aid in dollars.</p>
</section><section id="fixing-labelling-issues" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="fixing-labelling-issues">Fixing labelling issues</h3>
<p>We have two final super minor issues to address.</p>
<p>First hover over a country that didn’t receive aid, like the United States or Australia. The total reported aid displays as “$NaN”. That’s gross. It’d be nicer if it said something else, like “$0” or “No aid” or something more informative.</p>
<p>To fix this, we can make a little function that formats the given value as a dollar amount if it’s an actual value, and formats it as something else if it’s missing or not a number (like <code>log(0)</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40" data-startfrom="982" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 981;"><span id="cb40-982"><a href="#cb40-982" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">format_aid_total</span>(value) {</span>
<span id="cb40-983"><a href="#cb40-983" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> value <span class="op">?</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"$,d"</span>)(value) <span class="op">:</span> <span class="st">"No aid"</span><span class="op">;</span></span>
<span id="cb40-984"><a href="#cb40-984" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-35" data-nodetype="declaration">

</div>
</div>
</div>
<p>That works nicely:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" data-startfrom="991" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 990;"><span id="cb41-991"><a href="#cb41-991" aria-hidden="true" tabindex="-1"></a><span class="fu">format_aid_total</span>(<span class="dv">394023</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-36-1" data-nodetype="expression">

</div>
</div>
</div>
<div class="sourceCode cell-code" id="cb42" data-startfrom="992" data-source-offset="-25" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 991;"><span id="cb42-992"><a href="#cb42-992" aria-hidden="true" tabindex="-1"></a><span class="fu">format_aid_total</span>(<span class="kw">NaN</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-36-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>The other problem is in the legend, which uses a logarithmic scale and includes breaks for 10k, 1M, 100M, and 10G, representing $10,000, $1 million, $100 million, and $10 billion in aid.</p>
<p>The issue is the $10 billion, which is abbreviated with “G”.</p>
<p>This is happening because <code>d3.format()</code> uses SI (<a href="https://en.wikipedia.org/wiki/International_System_of_Units">Système international d’unités, or International System of Units</a>) values for its numeric formats, which means that it uses <a href="https://en.wikipedia.org/wiki/Metric_prefix">SI metric prefixes</a>. Those legend breaks, therefore, actually technically mean this:</p>
<ul>
<li>10k: 10 kilodollars</li>
<li>1M: 1 megadollar</li>
<li>100M: 100 megadollars</li>
<li>10G: 10 gigadollars</li>
</ul>
<p>lol, I should start talking about big dollar amounts with these values (“the 2022 US federal budget deficit was <a href="https://www.cbo.gov/publication/58888">1.4 teradollars</a>”)</p>
<p>The first letters of many of these SI prefixes happen to line up with US-style large numbers:</p>
<ul>
<li>In the US we already commonly use “k” for thousand</li>
<li>The initial “m” in “mega” aligns with “million”</li>
<li>The initial “t” in tera aligns with “trillion”</li>
</ul>
<p>But “giga” doesn’t align with “billion”, hence the strange “G” here for dollar amounts.</p>
<p><a href="https://github.com/d3/d3-format/issues/71">People have requested</a> that <code>d3-format</code> include an option for switching the abbreviation from G to B, but the developers haven’t added it (<a href="https://github.com/d3/d3-format/issues/71#issuecomment-515074256">and probably won’t</a>). Instead, <a href="https://talk.observablehq.com/t/how-do-i-make-the-billions-unit-show-as-b-instead-of-g-in-observable-plot/7560/2">a common recommended fix</a> is to replace all “G”s with “B”s:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43" data-startfrom="1019" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1018;"><span id="cb43-1019"><a href="#cb43-1019" aria-hidden="true" tabindex="-1"></a>number_in_billions <span class="op">=</span> <span class="dv">13840918291</span>  <span class="co">// A big number I randomly typed</span></span>
<span id="cb43-1020"><a href="#cb43-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-1021"><a href="#cb43-1021" aria-hidden="true" tabindex="-1"></a><span class="co">// Billions of dollars instead of SI-style gigadollars</span></span>
<span id="cb43-1022"><a href="#cb43-1022" aria-hidden="true" tabindex="-1"></a>d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"$.4s"</span>)(number_in_billions)<span class="op">.</span><span class="fu">replace</span>(<span class="st">"G"</span><span class="op">,</span> <span class="st">"B"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-37-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-37-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>We can add <code>format_aid_total()</code> and the <code>.replace("G", "B")</code> tweak and fix the labels in our interactive map:</p>
<div class="cell page-columns page-full" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb44" data-startfrom="1029" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="15,30"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1028;"><span id="cb44-1029"><a href="#cb44-1029" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb44-1030"><a href="#cb44-1030" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb44-1031"><a href="#cb44-1031" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb44-1032"><a href="#cb44-1032" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb44-1033"><a href="#cb44-1033" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb44-1034"><a href="#cb44-1034" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span>} )<span class="op">,</span></span>
<span id="cb44-1035"><a href="#cb44-1035" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb44-1036"><a href="#cb44-1036" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> country_totals<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span>)<span class="op">,</span></span>
<span id="cb44-1037"><a href="#cb44-1037" aria-hidden="true" tabindex="-1"></a>      <span class="dt">channels</span><span class="op">:</span> {</span>
<span id="cb44-1038"><a href="#cb44-1038" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Country</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb44-1039"><a href="#cb44-1039" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb44-1040"><a href="#cb44-1040" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tip</span><span class="op">:</span> {</span>
<span id="cb44-1041"><a href="#cb44-1041" aria-hidden="true" tabindex="-1"></a>        <span class="dt">format</span><span class="op">:</span> {</span>
<span id="cb44-1042"><a href="#cb44-1042" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Country</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb44-1043"><a href="#cb44-1043" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> <span class="fu">format_aid_total</span>(d) </span>
<span id="cb44-1044"><a href="#cb44-1044" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb44-1045"><a href="#cb44-1045" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb44-1046"><a href="#cb44-1046" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb44-1047"><a href="#cb44-1047" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb44-1048"><a href="#cb44-1048" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb44-1049"><a href="#cb44-1049" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb44-1050"><a href="#cb44-1050" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb44-1051"><a href="#cb44-1051" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb44-1052"><a href="#cb44-1052" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb44-1053"><a href="#cb44-1053" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scheme</span><span class="op">:</span> <span class="st">"blues"</span><span class="op">,</span></span>
<span id="cb44-1054"><a href="#cb44-1054" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unknown</span><span class="op">:</span> <span class="st">"#f2f2f2"</span><span class="op">,</span></span>
<span id="cb44-1055"><a href="#cb44-1055" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> </span>
<span id="cb44-1056"><a href="#cb44-1056" aria-hidden="true" tabindex="-1"></a>    <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb44-1057"><a href="#cb44-1057" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Total obligations"</span><span class="op">,</span></span>
<span id="cb44-1058"><a href="#cb44-1058" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tickFormat</span><span class="op">:</span> d <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"$0.2s"</span>)(d)<span class="op">.</span><span class="fu">replace</span>(<span class="st">"G"</span><span class="op">,</span> <span class="st">"B"</span>) </span>
<span id="cb44-1059"><a href="#cb44-1059" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-1060"><a href="#cb44-1060" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display column-body-outset">
<div id="ojs-cell-38" data-nodetype="expression">

</div>
</div>
</div>
</section><section id="some-final-tweaks" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="some-final-tweaks">Some final tweaks</h3>
<p>We’re so close! Just a couple final incredibly minor changes:</p>
<ol type="1">
<li>We’ll boost the font size of the tooltip a little and increase the font size of the legend</li>
<li>We’ll switch from the built-in ColorBrewer <code>blues</code> palette to show how to use custom gradients, like <a href="https://carto.com/carto-colors/">CARTOColors’s PurpOr</a> sequential palette</li>
</ol>
<div class="cell page-columns page-full" data-ht-pattern="//<<">
<div class="sourceCode cell-code" id="cb45" data-startfrom="1074" data-source-offset="0" data-source-line-numbers="nil" data-ht-pattern="//<<" data-code-line-numbers="13,26,27,33,34,35"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1073;"><span id="cb45-1074"><a href="#cb45-1074" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb45-1075"><a href="#cb45-1075" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb45-1076"><a href="#cb45-1076" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb45-1077"><a href="#cb45-1077" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb45-1078"><a href="#cb45-1078" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb45-1079"><a href="#cb45-1079" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span>} )<span class="op">,</span></span>
<span id="cb45-1080"><a href="#cb45-1080" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb45-1081"><a href="#cb45-1081" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> country_totals<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span>)<span class="op">,</span></span>
<span id="cb45-1082"><a href="#cb45-1082" aria-hidden="true" tabindex="-1"></a>      <span class="dt">channels</span><span class="op">:</span> {</span>
<span id="cb45-1083"><a href="#cb45-1083" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Country</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb45-1084"><a href="#cb45-1084" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb45-1085"><a href="#cb45-1085" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tip</span><span class="op">:</span> {</span>
<span id="cb45-1086"><a href="#cb45-1086" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span> </span>
<span id="cb45-1087"><a href="#cb45-1087" aria-hidden="true" tabindex="-1"></a>        <span class="dt">format</span><span class="op">:</span> {</span>
<span id="cb45-1088"><a href="#cb45-1088" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Country</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb45-1089"><a href="#cb45-1089" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> <span class="fu">format_aid_total</span>(d)</span>
<span id="cb45-1090"><a href="#cb45-1090" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb45-1091"><a href="#cb45-1091" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb45-1092"><a href="#cb45-1092" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb45-1093"><a href="#cb45-1093" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb45-1094"><a href="#cb45-1094" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb45-1095"><a href="#cb45-1095" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.15</span></span>
<span id="cb45-1096"><a href="#cb45-1096" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb45-1097"><a href="#cb45-1097" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb45-1098"><a href="#cb45-1098" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb45-1099"><a href="#cb45-1099" aria-hidden="true" tabindex="-1"></a>    <span class="co">// scheme: "blues", </span></span>
<span id="cb45-1100"><a href="#cb45-1100" aria-hidden="true" tabindex="-1"></a>    <span class="dt">range</span><span class="op">:</span> [<span class="st">"#f9ddda"</span><span class="op">,</span> <span class="st">"#f2b9c4"</span><span class="op">,</span> <span class="st">"#e597b9"</span><span class="op">,</span> <span class="st">"#ce78b3"</span><span class="op">,</span> <span class="st">"#ad5fad"</span><span class="op">,</span> <span class="st">"#834ba0"</span><span class="op">,</span> <span class="st">"#573b88"</span>]<span class="op">,</span> </span>
<span id="cb45-1101"><a href="#cb45-1101" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unknown</span><span class="op">:</span> <span class="st">"#f2f2f2"</span><span class="op">,</span></span>
<span id="cb45-1102"><a href="#cb45-1102" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> </span>
<span id="cb45-1103"><a href="#cb45-1103" aria-hidden="true" tabindex="-1"></a>    <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb45-1104"><a href="#cb45-1104" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Total obligations"</span><span class="op">,</span></span>
<span id="cb45-1105"><a href="#cb45-1105" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tickFormat</span><span class="op">:</span> d <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"$0.2s"</span>)(d)<span class="op">.</span><span class="fu">replace</span>(<span class="st">"G"</span><span class="op">,</span> <span class="st">"B"</span>)<span class="op">,</span></span>
<span id="cb45-1106"><a href="#cb45-1106" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> { </span>
<span id="cb45-1107"><a href="#cb45-1107" aria-hidden="true" tabindex="-1"></a>      <span class="st">"font-size"</span><span class="op">:</span> <span class="st">"14px"</span> </span>
<span id="cb45-1108"><a href="#cb45-1108" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb45-1109"><a href="#cb45-1109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-1110"><a href="#cb45-1110" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display column-body-outset">
<div id="ojs-cell-39" data-nodetype="expression">

</div>
</div>
</div>
</section></section><section id="the-full-game-complete-final-code" class="level2"><h2 class="anchored" data-anchor-id="the-full-game-complete-final-code">The full game: Complete final code</h2>
<p>That final interactive map looks great! We could be even fancier with it by adding dropdowns for dynamically grabbing data for different years or different types of amounts (appropriations, allocations, etc.), or even filter by specific regions or countries. But we won’t.</p>
<p>The different colors and data sources we’ve used are scattered throughout this post. To simplify things, here’s the complete code all in one location. (This chunk doesn’t actually run, since Observable gets mad if you create a new variable with the same name as one that already exists.)</p>
<div class="cell" data-eval="false">
<div class="sourceCode cell-code" id="cb46" data-startfrom="1125" data-source-offset="-1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1124;"><span id="cb46-1125"><a href="#cb46-1125" aria-hidden="true" tabindex="-1"></a>d3_geo <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3-geo"</span>)</span>
<span id="cb46-1126"><a href="#cb46-1126" aria-hidden="true" tabindex="-1"></a>d3_geo_projection <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3-geo-projection"</span>)</span>
<span id="cb46-1127"><a href="#cb46-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1128"><a href="#cb46-1128" aria-hidden="true" tabindex="-1"></a><span class="co">// ----------------------------------------------------------------------</span></span>
<span id="cb46-1129"><a href="#cb46-1129" aria-hidden="true" tabindex="-1"></a><span class="co">// Map stuff</span></span>
<span id="cb46-1130"><a href="#cb46-1130" aria-hidden="true" tabindex="-1"></a><span class="co">// ----------------------------------------------------------------------</span></span>
<span id="cb46-1131"><a href="#cb46-1131" aria-hidden="true" tabindex="-1"></a>world <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"ne_110m_admin_0_countries.geojson"</span>)<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb46-1132"><a href="#cb46-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1133"><a href="#cb46-1133" aria-hidden="true" tabindex="-1"></a><span class="co">// Antarctica's ISO3 code is ATA</span></span>
<span id="cb46-1134"><a href="#cb46-1134" aria-hidden="true" tabindex="-1"></a>world_sans_penguins <span class="op">=</span> ({</span>
<span id="cb46-1135"><a href="#cb46-1135" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">"FeatureCollection"</span><span class="op">,</span></span>
<span id="cb46-1136"><a href="#cb46-1136" aria-hidden="true" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> world<span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span> <span class="op">!==</span> <span class="st">"ATA"</span>)</span>
<span id="cb46-1137"><a href="#cb46-1137" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-1138"><a href="#cb46-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1139"><a href="#cb46-1139" aria-hidden="true" tabindex="-1"></a>inset_world <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb46-1140"><a href="#cb46-1140" aria-hidden="true" tabindex="-1"></a>world_map_width <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb46-1141"><a href="#cb46-1141" aria-hidden="true" tabindex="-1"></a>world_map_height <span class="op">=</span> <span class="dv">450</span></span>
<span id="cb46-1142"><a href="#cb46-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1143"><a href="#cb46-1143" aria-hidden="true" tabindex="-1"></a>world_sans_penguins_robinson <span class="op">=</span> d3_geo_projection<span class="op">.</span><span class="fu">geoRobinson</span>()</span>
<span id="cb46-1144"><a href="#cb46-1144" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">fitExtent</span>(</span>
<span id="cb46-1145"><a href="#cb46-1145" aria-hidden="true" tabindex="-1"></a>    [[inset_world<span class="op">,</span> inset_world]<span class="op">,</span></span>
<span id="cb46-1146"><a href="#cb46-1146" aria-hidden="true" tabindex="-1"></a>     [world_map_width <span class="op">-</span> inset_world<span class="op">,</span> world_map_height <span class="op">-</span> inset_world]]<span class="op">,</span></span>
<span id="cb46-1147"><a href="#cb46-1147" aria-hidden="true" tabindex="-1"></a>    world_sans_penguins</span>
<span id="cb46-1148"><a href="#cb46-1148" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-1149"><a href="#cb46-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1150"><a href="#cb46-1150" aria-hidden="true" tabindex="-1"></a><span class="co">// ----------------------------------------------------------------------</span></span>
<span id="cb46-1151"><a href="#cb46-1151" aria-hidden="true" tabindex="-1"></a><span class="co">// Data stuff</span></span>
<span id="cb46-1152"><a href="#cb46-1152" aria-hidden="true" tabindex="-1"></a><span class="co">// ----------------------------------------------------------------------</span></span>
<span id="cb46-1153"><a href="#cb46-1153" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { DatasetteClient } <span class="im">from</span> <span class="st">"@ambassadors/datasette-client"</span></span>
<span id="cb46-1154"><a href="#cb46-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1155"><a href="#cb46-1155" aria-hidden="true" tabindex="-1"></a>aid_db <span class="op">=</span> <span class="kw">new</span> <span class="fu">DatasetteClient</span>(</span>
<span id="cb46-1156"><a href="#cb46-1156" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance"</span></span>
<span id="cb46-1157"><a href="#cb46-1157" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-1158"><a href="#cb46-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1159"><a href="#cb46-1159" aria-hidden="true" tabindex="-1"></a>recipient_countries <span class="op">=</span> <span class="cf">await</span> aid_db<span class="op">.</span><span class="fu">sql</span><span class="vs">`</span></span>
<span id="cb46-1160"><a href="#cb46-1160" aria-hidden="true" tabindex="-1"></a><span class="vs">  SELECT "Country Code", "Country Name", "Region Name", SUM("constant_amount") AS total_constant_amount</span></span>
<span id="cb46-1161"><a href="#cb46-1161" aria-hidden="true" tabindex="-1"></a><span class="vs">  FROM "./us_foreign_aid_country"</span></span>
<span id="cb46-1162"><a href="#cb46-1162" aria-hidden="true" tabindex="-1"></a><span class="vs">  WHERE </span></span>
<span id="cb46-1163"><a href="#cb46-1163" aria-hidden="true" tabindex="-1"></a><span class="vs">    "Fiscal Year" = '2023' </span></span>
<span id="cb46-1164"><a href="#cb46-1164" aria-hidden="true" tabindex="-1"></a><span class="vs">    AND "Transaction Type Name" = 'Obligations' </span></span>
<span id="cb46-1165"><a href="#cb46-1165" aria-hidden="true" tabindex="-1"></a><span class="vs">    AND "Country Name" NOT LIKE '%Region%' </span></span>
<span id="cb46-1166"><a href="#cb46-1166" aria-hidden="true" tabindex="-1"></a><span class="vs">    AND "Country Name" != "World"</span></span>
<span id="cb46-1167"><a href="#cb46-1167" aria-hidden="true" tabindex="-1"></a><span class="vs">  GROUP BY "Country Code", "Country Name", "Region Name"</span></span>
<span id="cb46-1168"><a href="#cb46-1168" aria-hidden="true" tabindex="-1"></a><span class="vs">  ORDER BY total_constant_amount DESC;</span></span>
<span id="cb46-1169"><a href="#cb46-1169" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span>
<span id="cb46-1170"><a href="#cb46-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1171"><a href="#cb46-1171" aria-hidden="true" tabindex="-1"></a>country_totals <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(recipient_countries<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> [d[<span class="st">"Country Code"</span>]<span class="op">,</span> d<span class="op">.</span><span class="at">total_constant_amount</span>]))</span>
<span id="cb46-1172"><a href="#cb46-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1173"><a href="#cb46-1173" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">format_aid_total</span>(value) {</span>
<span id="cb46-1174"><a href="#cb46-1174" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> value <span class="op">?</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"$,d"</span>)(value) <span class="op">:</span> <span class="st">"No aid"</span><span class="op">;</span></span>
<span id="cb46-1175"><a href="#cb46-1175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-1176"><a href="#cb46-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-1177"><a href="#cb46-1177" aria-hidden="true" tabindex="-1"></a><span class="co">// ----------------------------------------------------------------------</span></span>
<span id="cb46-1178"><a href="#cb46-1178" aria-hidden="true" tabindex="-1"></a><span class="co">// Plot stuff</span></span>
<span id="cb46-1179"><a href="#cb46-1179" aria-hidden="true" tabindex="-1"></a><span class="co">// ----------------------------------------------------------------------</span></span>
<span id="cb46-1180"><a href="#cb46-1180" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb46-1181"><a href="#cb46-1181" aria-hidden="true" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> world_sans_penguins_robinson<span class="op">,</span></span>
<span id="cb46-1182"><a href="#cb46-1182" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> world_map_width<span class="op">,</span></span>
<span id="cb46-1183"><a href="#cb46-1183" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> world_map_height<span class="op">,</span></span>
<span id="cb46-1184"><a href="#cb46-1184" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb46-1185"><a href="#cb46-1185" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">frame</span>({ <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span>} )<span class="op">,</span></span>
<span id="cb46-1186"><a href="#cb46-1186" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb46-1187"><a href="#cb46-1187" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> country_totals<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">iso_a3</span>)<span class="op">,</span></span>
<span id="cb46-1188"><a href="#cb46-1188" aria-hidden="true" tabindex="-1"></a>      <span class="dt">channels</span><span class="op">:</span> {</span>
<span id="cb46-1189"><a href="#cb46-1189" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Country</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb46-1190"><a href="#cb46-1190" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb46-1191"><a href="#cb46-1191" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tip</span><span class="op">:</span> {</span>
<span id="cb46-1192"><a href="#cb46-1192" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb46-1193"><a href="#cb46-1193" aria-hidden="true" tabindex="-1"></a>        <span class="dt">format</span><span class="op">:</span> {</span>
<span id="cb46-1194"><a href="#cb46-1194" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Country</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb46-1195"><a href="#cb46-1195" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> <span class="fu">format_aid_total</span>(d)</span>
<span id="cb46-1196"><a href="#cb46-1196" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb46-1197"><a href="#cb46-1197" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb46-1198"><a href="#cb46-1198" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">,</span></span>
<span id="cb46-1199"><a href="#cb46-1199" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">geo</span>(world_sans_penguins<span class="op">,</span> {</span>
<span id="cb46-1200"><a href="#cb46-1200" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb46-1201"><a href="#cb46-1201" aria-hidden="true" tabindex="-1"></a>      <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.15</span></span>
<span id="cb46-1202"><a href="#cb46-1202" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb46-1203"><a href="#cb46-1203" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb46-1204"><a href="#cb46-1204" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb46-1205"><a href="#cb46-1205" aria-hidden="true" tabindex="-1"></a>    <span class="dt">range</span><span class="op">:</span> [<span class="st">"#f9ddda"</span><span class="op">,</span> <span class="st">"#f2b9c4"</span><span class="op">,</span> <span class="st">"#e597b9"</span><span class="op">,</span> <span class="st">"#ce78b3"</span><span class="op">,</span> <span class="st">"#ad5fad"</span><span class="op">,</span> <span class="st">"#834ba0"</span><span class="op">,</span> <span class="st">"#573b88"</span>]<span class="op">,</span></span>
<span id="cb46-1206"><a href="#cb46-1206" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unknown</span><span class="op">:</span> <span class="st">"#f2f2f2"</span><span class="op">,</span></span>
<span id="cb46-1207"><a href="#cb46-1207" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> </span>
<span id="cb46-1208"><a href="#cb46-1208" aria-hidden="true" tabindex="-1"></a>    <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb46-1209"><a href="#cb46-1209" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Total obligations"</span><span class="op">,</span></span>
<span id="cb46-1210"><a href="#cb46-1210" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tickFormat</span><span class="op">:</span> d <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"$0.2s"</span>)(d)<span class="op">.</span><span class="fu">replace</span>(<span class="st">"G"</span><span class="op">,</span> <span class="st">"B"</span>)<span class="op">,</span></span>
<span id="cb46-1211"><a href="#cb46-1211" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb46-1212"><a href="#cb46-1212" aria-hidden="true" tabindex="-1"></a>      <span class="st">"font-size"</span><span class="op">:</span> <span class="st">"14px"</span> </span>
<span id="cb46-1213"><a href="#cb46-1213" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-1214"><a href="#cb46-1214" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-1215"><a href="#cb46-1215" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-10" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-11" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-12" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-13" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-40-14" data-nodetype="expression">

</div>
</div>
</div>
</div>


<!-- -->

</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2025,
  author = {Heiss, Andrew},
  title = {Using {USAID} Data to Make Fancy World Maps with {Observable}
    {Plot}},
  date = {2025-02-10},
  url = {https://www.bradleyrentz.com/blog/2025/02/10/usaid-ojs-maps/},
  doi = {10.59350/c0aep-hp989},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2025. <span>“Using USAID Data to Make Fancy World Maps
with Observable Plot.”</span> February 10, 2025. <a href="https://doi.org/10.59350/c0aep-hp989">https://doi.org/10.59350/c0aep-hp989</a>.
</div></div></section></div></main><!-- /main --><script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IndvcmxkID0gRmlsZUF0dGFjaG1lbnQoXCJuZV8xMTBtX2FkbWluXzBfY291bnRyaWVzLmdlb2pzb25cIikuanNvbigpXG53b3JsZF9tZWRpdW0gPSBGaWxlQXR0YWNobWVudChcIm5lXzUwbV9hZG1pbl8wX2NvdW50cmllcy5nZW9qc29uXCIpLmpzb24oKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoid29ybGRcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlBsb3QucGxvdCh7XG4gIG1hcmtzOiBbXG4gICAgUGxvdC5nZW8od29ybGQpXG4gIF1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBDQVJUT0NvbG9ycyBQcmlzbVxuY2FydG9fcHJpc20gPSBbXG4gIFwiIzVGNDY5MFwiLCBcIiMxRDY5OTZcIiwgXCIjMzhBNkE1XCIsIFwiIzBGODU1NFwiLCBcIiM3M0FGNDhcIiwgXCIjRURBRDA4XCIsIFxuICBcIiNFMTdDMDVcIiwgXCIjQ0M1MDNFXCIsIFwiIzk0MzQ2RVwiLCBcIiM2RjQwNzBcIiwgXCIjOTk0RTk1XCIsIFwiIzY2NjY2NlwiXG5dXG5cbi8vIEZyb20gUjpcbi8vIGNscl9vY2VhbiA8LSBjb2xvcnNwYWNlOjpsaWdodGVuKFwiIzg4Q0NFRVwiLCAwLjcpXG5jbHJfb2NlYW4gPSBcIiNEOUYwRkZcIlxuXG4vLyBGcm9tIENBUlRPQ29sb3JzIFBlYWNoIDJcbmNscl9sYW5kID0gXCIjZmFjYmE2XCJcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuUGxvdC5wbG90KHtcbiAgbWFya3M6IFtcbiAgICBQbG90LmZyYW1lKHsgZmlsbDogY2xyX29jZWFuIH0pLCAgLy88PFxuICAgIFBsb3QuZ2VvKHdvcmxkLCB7IC8vPDxcbiAgICAgIHN0cm9rZTogXCJibGFja1wiLCAvLzw8XG4gICAgICBzdHJva2VXaWR0aDogMC41LCAvLzw8XG4gICAgICBmaWxsOiBjbHJfbGFuZCAvLzw8XG4gICAgfSkgLy88PFxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC02IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiBcImVxdWFsLWVhcnRoXCIsIC8vPDxcbiAgd2lkdGg6IDEwMDAsIC8vPDxcbiAgbWFya3M6IFtcbiAgICBQbG90LnNwaGVyZSh7IGZpbGw6IGNscl9vY2VhbiB9KSwgLy88PFxuICAgIFBsb3QuZ2VvKHdvcmxkLCB7XG4gICAgICBzdHJva2U6IFwiYmxhY2tcIixcbiAgICAgIHN0cm9rZVdpZHRoOiAwLjUsXG4gICAgICBmaWxsOiBjbHJfbGFuZFxuICAgIH0pXG4gIF1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbnZpZXdvZiBwcm9qZWN0aW9uID0gSW5wdXRzLnNlbGVjdChcbiAgW1wiZXF1aXJlY3Rhbmd1bGFyXCIsIFwiZXF1YWwtZWFydGhcIiwgXCJtZXJjYXRvclwiLCBcInRyYW5zdmVyc2UtbWVyY2F0b3JcIiwgXCJhemltdXRoYWwtZXF1YWwtYXJlYVwiLCBcImdub21vbmljXCJdLFxuICB7dmFsdWU6IFwiYXppbXV0aGFsLWVxdWFsLWFyZWFcIiwgbGFiZWw6IFwiUHJvamVjdGlvblwifVxuKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC04IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiBwcm9qZWN0aW9uLFxuICAvLyB3aWR0aCxcbiAgbWFya3M6IFtcbiAgICBQbG90LnNwaGVyZSh7IGZpbGw6IGNscl9vY2VhbiB9KSxcbiAgICBQbG90Lmdlbyh3b3JsZCwge1xuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC41LFxuICAgICAgZmlsbDogY2xyX2xhbmRcbiAgICB9KVxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC05IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5kM19nZW9fcHJvamVjdGlvbiA9IHJlcXVpcmUoXCJkMy1nZW8tcHJvamVjdGlvblwiKSAvLzw8XG5cblBsb3QucGxvdCh7XG4gIHByb2plY3Rpb246IGQzX2dlb19wcm9qZWN0aW9uLmdlb1JvYmluc29uKCksIC8vPDxcbiAgd2lkdGg6IDEwMDAsXG4gIGhlaWdodDogNTAwLCAvLzw8XG4gIG1hcmtzOiBbXG4gICAgUGxvdC5zcGhlcmUoeyBmaWxsOiBjbHJfb2NlYW4gfSksXG4gICAgUGxvdC5nZW8od29ybGQsIHtcbiAgICAgIHN0cm9rZTogXCJibGFja1wiLFxuICAgICAgc3Ryb2tlV2lkdGg6IDAuNSxcbiAgICAgIGZpbGw6IGNscl9sYW5kXG4gICAgfSlcbiAgXVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTAiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJ3b3JsZC5mZWF0dXJlc1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuLy8gQW50YXJjdGljYSdzIElTTzMgY29kZSBpcyBBVEFcbndvcmxkX3NhbnNfcGVuZ3VpbnMgPSAoeyAvLzw8XG4gIHR5cGU6IFwiRmVhdHVyZUNvbGxlY3Rpb25cIiwgLy88PFxuICBmZWF0dXJlczogd29ybGQuZmVhdHVyZXMuZmlsdGVyKGQgPT4gZC5wcm9wZXJ0aWVzLmlzb19hMyAhPT0gXCJBVEFcIikgLy88PFxufSkgLy88PFxuXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiBkM19nZW9fcHJvamVjdGlvbi5nZW9Sb2JpbnNvbigpLFxuICB3aWR0aDogMTAwMCxcbiAgaGVpZ2h0OiA1MDAsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5zcGhlcmUoeyBmaWxsOiBjbHJfb2NlYW4gfSksXG4gICAgUGxvdC5nZW8od29ybGRfc2Fuc19wZW5ndWlucywgeyAvLzw8XG4gICAgICBzdHJva2U6IFwiYmxhY2tcIixcbiAgICAgIHN0cm9rZVdpZHRoOiAwLjUsXG4gICAgICBmaWxsOiBjbHJfbGFuZFxuICAgIH0pXG4gIF1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTEyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiBkM19nZW9fcHJvamVjdGlvbi5nZW9Sb2JpbnNvbigpLFxuICB3aWR0aDogMTAwMCxcbiAgaGVpZ2h0OiA1MDAsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IGZpbGw6IGNscl9vY2Vhbiwgc3Ryb2tlOiBcImJsYWNrXCIsIHN0cm9rZVdpZHRoOiAxIH0pLCAvLzw8XG4gICAgUGxvdC5nZW8od29ybGRfc2Fuc19wZW5ndWlucywge1xuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC41LFxuICAgICAgZmlsbDogY2xyX2xhbmRcbiAgICB9KVxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xMyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuUGxvdC5wbG90KHtcbiAgcHJvamVjdGlvbjogZDNfZ2VvX3Byb2plY3Rpb24uZ2VvUm9iaW5zb24oKSxcbiAgd2lkdGg6IDEwMDAsXG4gIGhlaWdodDogNDMwLCAvLzw8XG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IGZpbGw6IGNscl9vY2Vhbiwgc3Ryb2tlOiBcImJsYWNrXCIsIHN0cm9rZVdpZHRoOiAxIH0pLFxuICAgIFBsb3QuZ2VvKHdvcmxkX3NhbnNfcGVuZ3VpbnMsIHtcbiAgICAgIHN0cm9rZTogXCJibGFja1wiLFxuICAgICAgc3Ryb2tlV2lkdGg6IDAuNSxcbiAgICAgIGZpbGw6IGNscl9sYW5kXG4gICAgfSlcbiAgXVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcblBsb3QucGxvdCh7XG4gIHByb2plY3Rpb246IGQzX2dlb19wcm9qZWN0aW9uLmdlb1JvYmluc29uKCksXG4gIHdpZHRoOiAxMDAwLFxuICBoZWlnaHQ6IDIxNSwgLy88PFxuICBtYXJrczogW1xuICAgIFBsb3QuZnJhbWUoeyBmaWxsOiBjbHJfb2NlYW4sIHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMSB9KSxcbiAgICBQbG90Lmdlbyh3b3JsZF9zYW5zX3Blbmd1aW5zLCB7XG4gICAgICBzdHJva2U6IFwiYmxhY2tcIixcbiAgICAgIHN0cm9rZVdpZHRoOiAwLjUsXG4gICAgICBmaWxsOiBjbHJfbGFuZFxuICAgIH0pXG4gIF1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE1IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5qdXN0X2FmcmljYSA9ICh7IC8vPDxcbiAgICB0eXBlOiBcIkZlYXR1cmVDb2xsZWN0aW9uXCIsIC8vPDxcbiAgICBmZWF0dXJlczogd29ybGQuZmVhdHVyZXMuZmlsdGVyKGQgPT4gZC5wcm9wZXJ0aWVzLmNvbnRpbmVudCA9PSBcIkFmcmljYVwiKSAvLzw8XG59KSAvLzw8XG5cblBsb3QucGxvdCh7XG4gIHByb2plY3Rpb246IGQzX2dlb19wcm9qZWN0aW9uLmdlb1JvYmluc29uKCksXG4gIHdpZHRoOiAxMDAwLFxuICBoZWlnaHQ6IDQzMCwgLy88PFxuICBtYXJrczogW1xuICAgIFBsb3QuZnJhbWUoeyBmaWxsOiBjbHJfb2NlYW4sIHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMSB9KSxcbiAgICBQbG90LmdlbyhqdXN0X2FmcmljYSwge1xuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC41LFxuICAgICAgZmlsbDogY2xyX2xhbmRcbiAgICB9KVxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xNiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuUGxvdC5wbG90KHtcbiAgcHJvamVjdGlvbjogZDNfZ2VvX3Byb2plY3Rpb24uZ2VvUm9iaW5zb24oKSxcbiAgd2lkdGg6IDU1MCwgLy88PFxuICBoZWlnaHQ6IDIxNSwgLy88PFxuICBtYXJrczogW1xuICAgIFBsb3QuZnJhbWUoeyBmaWxsOiBjbHJfb2NlYW4sIHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMSB9KSxcbiAgICBQbG90LmdlbyhqdXN0X2FmcmljYSwge1xuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC41LFxuICAgICAgZmlsbDogY2xyX2xhbmRcbiAgICB9KVxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xNyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuUGxvdC5wbG90KHtcbiAgcHJvamVjdGlvbjogeyAvLzw8XG4gICAgdHlwZTogXCJlcXVhbC1lYXJ0aFwiLCAvLzw8XG4gICAgZG9tYWluOiB3b3JsZF9zYW5zX3Blbmd1aW5zLCAvLzw8XG4gICAgaW5zZXQ6IDEwIC8vPDxcbiAgfSwgLy88PFxuICB3aWR0aDogMTAwMCxcbiAgbWFya3M6IFtcbiAgICBQbG90LmZyYW1lKHsgZmlsbDogY2xyX29jZWFuLCBzdHJva2U6IFwiYmxhY2tcIiwgc3Ryb2tlV2lkdGg6IDEgfSksXG4gICAgUGxvdC5nZW8od29ybGRfc2Fuc19wZW5ndWlucywge1xuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC41LFxuICAgICAgZmlsbDogY2xyX2xhbmRcbiAgICB9KVxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xOCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuUGxvdC5wbG90KHtcbiAgcHJvamVjdGlvbjoge1xuICAgIHR5cGU6IFwiZXF1YWwtZWFydGhcIixcbiAgICBkb21haW46IHdvcmxkX3NhbnNfcGVuZ3VpbnMsIFxuICAgIGluc2V0OiAxMFxuICB9LFxuICB3aWR0aDogMTAwMCxcbiAgbWFya3M6IFtcbiAgICBQbG90LmZyYW1lKHsgc3Ryb2tlOiBcImJsYWNrXCIsIHN0cm9rZVdpZHRoOiAxIH0pLCAvLzw8XG4gICAgUGxvdC5zcGhlcmUoeyBmaWxsOiBjbHJfb2NlYW4gfSksIC8vPDxcbiAgICBQbG90Lmdlbyh3b3JsZF9zYW5zX3Blbmd1aW5zLCB7XG4gICAgICBzdHJva2U6IFwiYmxhY2tcIixcbiAgICAgIHN0cm9rZVdpZHRoOiAwLjUsXG4gICAgICBmaWxsOiBjbHJfbGFuZFxuICAgIH0pXG4gIF1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE5IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiB7XG4gICAgdHlwZTogXCJlcXVhbC1lYXJ0aFwiLFxuICAgIGRvbWFpbjoganVzdF9hZnJpY2EsIC8vPDxcbiAgICBpbnNldDogMTBcbiAgfSxcbiAgd2lkdGg6IDYwMCwgLy88PFxuICBoZWlnaHQ6IDYwMCwgLy88PFxuICBtYXJrczogW1xuICAgIFBsb3QuZnJhbWUoeyBmaWxsOiBjbHJfb2NlYW4sIHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMSB9KSxcbiAgICBQbG90Lmdlbyh3b3JsZF9tZWRpdW0sIHsgLy88PFxuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC41LFxuICAgICAgZmlsbDogY2xyX2xhbmRcbiAgICB9KVxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yMCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuanVzdF9hZnJpY2FfbWVkaXVtID0gKHsgLy88PFxuICAgIHR5cGU6IFwiRmVhdHVyZUNvbGxlY3Rpb25cIiwgLy88PFxuICAgIGZlYXR1cmVzOiB3b3JsZF9tZWRpdW0uZmVhdHVyZXMuZmlsdGVyKGQgPT4gZC5wcm9wZXJ0aWVzLmNvbnRpbmVudCA9PSBcIkFmcmljYVwiKSAvLzw8XG59KSAvLzw8XG5cblBsb3QucGxvdCh7XG4gIHByb2plY3Rpb246IHtcbiAgICB0eXBlOiBcImVxdWFsLWVhcnRoXCIsXG4gICAgZG9tYWluOiBqdXN0X2FmcmljYSxcbiAgICBpbnNldDogMTBcbiAgfSxcbiAgd2lkdGg6IDYwMCxcbiAgaGVpZ2h0OiA2MDAsXG4gIG1hcmtzOiBbXG4gICAgLy8gVXNlIGEgd2hpdGUgYmFja2dyb3VuZCBzaW5jZSB3ZSBkb24ndCB3YW50IHRvIG1ha2UgaXQgbG9vayBsaWtlICAvLzw8XG4gICAgLy8gdGhlIFNpbmFpIHBlbmluc3VsYSBoYXMgYSBjb2FzdGxpbmUgIC8vPDxcbiAgICBQbG90LmZyYW1lKHsgZmlsbDogXCJ3aGl0ZVwiLCBzdHJva2U6IFwiYmxhY2tcIiwgc3Ryb2tlV2lkdGg6IDEgfSksIC8vPDxcbiAgICBQbG90LmdlbyhqdXN0X2FmcmljYV9tZWRpdW0sIHsgIC8vPDxcbiAgICAgIHN0cm9rZTogXCJibGFja1wiLFxuICAgICAgc3Ryb2tlV2lkdGg6IDAuNSxcbiAgICAgIGZpbGw6IGNscl9sYW5kXG4gICAgfSlcbiAgXVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjEiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJpbnNldF9hZnJpY2EgPSAzMFxuYWZyaWNhX21hcF93aWR0aCA9IDYwMFxuYWZyaWNhX21hcF9oZWlnaHQgPSA2MDBcblxuYWZyaWNhX3JvYmluc29uID0gZDNfZ2VvX3Byb2plY3Rpb24uZ2VvUm9iaW5zb24oKVxuICAuZml0RXh0ZW50KFxuICAgIFtbaW5zZXRfYWZyaWNhLCBpbnNldF9hZnJpY2FdLCAgLy8gVG9wIGxlZnRcbiAgICAgW2FmcmljYV9tYXBfd2lkdGggLSBpbnNldF9hZnJpY2EsIGFmcmljYV9tYXBfaGVpZ2h0IC0gaW5zZXRfYWZyaWNhXV0sICAvLyBCb3R0b20gcmlnaHQgXG4gICAganVzdF9hZnJpY2FcbiAgKVxuXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiBhZnJpY2Ffcm9iaW5zb24sXG4gIHdpZHRoOiBhZnJpY2FfbWFwX3dpZHRoLFxuICBoZWlnaHQ6IGFmcmljYV9tYXBfaGVpZ2h0LFxuICBtYXJrczogW1xuICAgIFBsb3QuZnJhbWUoeyBmaWxsOiBjbHJfb2NlYW4sIHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMSB9KSxcbiAgICBQbG90Lmdlbyh3b3JsZF9zYW5zX3Blbmd1aW5zLCB7XG4gICAgICBzdHJva2U6IFwiYmxhY2tcIixcbiAgICAgIHN0cm9rZVdpZHRoOiAwLjUsXG4gICAgICBmaWxsOiBjbHJfbGFuZFxuICAgIH0pXG4gIF1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTIyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiZWd5cHQgPSB3b3JsZF9tZWRpdW0uZmVhdHVyZXMuZmluZChkID0+IGQucHJvcGVydGllcy5uYW1lID09PSBcIkVneXB0XCIpXG5cbmluc2V0X2VneXB0ID0gNzVcbmVneXB0X21hcF93aWR0aCA9IDYwMFxuZWd5cHRfbWFwX2hlaWdodCA9IDYwMFxuXG5yb2JpbnNvbl9lZ3lwdCA9IGQzX2dlb19wcm9qZWN0aW9uLmdlb1JvYmluc29uKClcbiAgLmZpdEV4dGVudChcbiAgICBbW2luc2V0X2VneXB0LCBpbnNldF9lZ3lwdF0sICAvLyBUb3AgbGVmdFxuICAgICBbZWd5cHRfbWFwX3dpZHRoIC0gaW5zZXRfZWd5cHQsIGVneXB0X21hcF9oZWlnaHQgLSBpbnNldF9lZ3lwdF1dLCAgLy8gQm90dG9tIHJpZ2h0XG4gICAgZWd5cHRcbiAgKVxuXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiByb2JpbnNvbl9lZ3lwdCxcbiAgd2lkdGg6IGVneXB0X21hcF93aWR0aCxcbiAgaGVpZ2h0OiBlZ3lwdF9tYXBfaGVpZ2h0LFxuICBtYXJrczogW1xuICAgIFBsb3QuZnJhbWUoeyBmaWxsOiBjbHJfb2NlYW4sIHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMSB9KSxcbiAgICBQbG90Lmdlbyh3b3JsZF9tZWRpdW0sIFBsb3QuY2VudHJvaWQoe1xuICAgICAgZmlsbDogZCA9PiBkLnByb3BlcnRpZXMubWFwY29sb3I3LFxuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsIFxuICAgICAgc3Ryb2tlV2lkdGg6IDAuNVxuICAgIH0pKSxcbiAgICBQbG90LmdlbyhlZ3lwdCwgeyBzdHJva2U6IFwieWVsbG93XCIsIHN0cm9rZVdpZHRoOiAzIH0pLFxuICAgIFBsb3QudGlwKHdvcmxkX21lZGl1bS5mZWF0dXJlcywgUGxvdC5jZW50cm9pZCh7XG4gICAgICB0aXRsZTogZCA9PiBkLnByb3BlcnRpZXMubmFtZSwgXG4gICAgICBhbmNob3I6IFwidG9wXCIsXG4gICAgICBmb250U2l6ZTogMTMsXG4gICAgICBmb250V2VpZ2h0OiBcImJvbGRcIixcbiAgICAgIHRleHRQYWRkaW5nOiAzXG4gICAgfSkpXG4gIF0sXG4gIGNvbG9yOiB7XG4gICAgcmFuZ2U6IGNhcnRvX3ByaXNtXG4gIH1cbn0pXG5cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJpbnNldF93b3JsZCA9IDEwXG53b3JsZF9tYXBfd2lkdGggPSAxMDAwXG53b3JsZF9tYXBfaGVpZ2h0ID0gNDUwXG5cbndvcmxkX3NhbnNfcGVuZ3VpbnNfcm9iaW5zb24gPSBkM19nZW9fcHJvamVjdGlvbi5nZW9Sb2JpbnNvbigpXG4gIC5maXRFeHRlbnQoXG4gICAgW1tpbnNldF93b3JsZCwgaW5zZXRfd29ybGRdLFxuICAgICBbd29ybGRfbWFwX3dpZHRoIC0gaW5zZXRfd29ybGQsIHdvcmxkX21hcF9oZWlnaHQgLSBpbnNldF93b3JsZF1dLFxuICAgIHdvcmxkX3NhbnNfcGVuZ3VpbnNcbiAgKVxuXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiB3b3JsZF9zYW5zX3Blbmd1aW5zX3JvYmluc29uLFxuICB3aWR0aDogd29ybGRfbWFwX3dpZHRoLFxuICBoZWlnaHQ6IHdvcmxkX21hcF9oZWlnaHQsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IGZpbGw6IGNscl9vY2Vhbiwgc3Ryb2tlOiBcImJsYWNrXCIsIHN0cm9rZVdpZHRoOiAxIH0pLFxuICAgIFBsb3QuZ2VvKHdvcmxkX3NhbnNfcGVuZ3VpbnMsIHtcbiAgICAgIHN0cm9rZTogXCJibGFja1wiLFxuICAgICAgc3Ryb2tlV2lkdGg6IDAuNSxcbiAgICAgIGZpbGw6IGNscl9sYW5kXG4gICAgfSlcbiAgXVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJpbnNldF9ldXJvcGUgPSAxMFxuZXVyb3BlX21hcF93aWR0aCA9IDgwMFxuZXVyb3BlX21hcF9oZWlnaHQgPSA4MDBcblxuZXVyb3BlX2JveCA9ICh7XG4gIHR5cGU6IFwiRmVhdHVyZVwiLFxuICBnZW9tZXRyeToge1xuICAgIHR5cGU6IFwiTXVsdGlQb2ludFwiLFxuICAgIGNvb3JkaW5hdGVzOiBbXG4gICAgICBbLTEzLCAzNV0sICAvLyBbbGVmdC93ZXN0LCBib3R0b20vc291dGhdIChvciBib3R0b20gbGVmdCBjb3JuZXIpXG4gICAgICBbMjEsIDYwXSAgICAvLyBbcmlnaHQvZWFzdCwgdG9wL25vcnRoXSAgIChvciB0b3AgcmlnaHQgY29ybmVyKVxuICAgIF1cbiAgfVxufSlcblxuZXVyb3BlX3JvYmluc29uID0gZDNfZ2VvX3Byb2plY3Rpb24uZ2VvUm9iaW5zb24oKVxuICAuZml0RXh0ZW50KFxuICAgIFtbaW5zZXRfZXVyb3BlLCBpbnNldF9ldXJvcGVdLFxuICAgICBbZXVyb3BlX21hcF93aWR0aCAtIGluc2V0X2V1cm9wZSwgZXVyb3BlX21hcF9oZWlnaHQgLSBpbnNldF9ldXJvcGVdXSwgXG4gICAgZXVyb3BlX2JveFxuICApXG5cblBsb3QucGxvdCh7XG4gIHByb2plY3Rpb246IGV1cm9wZV9yb2JpbnNvbixcbiAgd2lkdGg6IGV1cm9wZV9tYXBfd2lkdGgsXG4gIGhlaWdodDogZXVyb3BlX21hcF9oZWlnaHQsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IGZpbGw6IGNscl9vY2Vhbiwgc3Ryb2tlOiBcImJsYWNrXCIsIHN0cm9rZVdpZHRoOiAxIH0pLFxuICAgIFBsb3QuZ2VvKHdvcmxkX21lZGl1bSwgUGxvdC5jZW50cm9pZCh7XG4gICAgICBmaWxsOiBkID0+IGQucHJvcGVydGllcy5tYXBjb2xvcjksXG4gICAgICBzdHJva2U6IFwid2hpdGVcIiwgXG4gICAgICBzdHJva2VXaWR0aDogMC4yNVxuICAgIH0pKSxcbiAgICBQbG90LnRpcCh3b3JsZC5mZWF0dXJlcywgUGxvdC5jZW50cm9pZCh7XG4gICAgICB0aXRsZTogZCA9PiBkLnByb3BlcnRpZXMubmFtZSwgXG4gICAgICBhbmNob3I6IFwiYm90dG9tXCIsXG4gICAgICBmb250U2l6ZTogMTMsXG4gICAgICBmb250V2VpZ2h0OiBcImJvbGRcIixcbiAgICAgIHRleHRQYWRkaW5nOiAzXG4gICAgfSkpXG4gIF0sXG4gIGNvbG9yOiB7XG4gICAgcmFuZ2U6IGNhcnRvX3ByaXNtXG4gIH1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTI2IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG4vLyBJIGRvbid0IHdhbnQgdG8ga2VlcCBoaXR0aW5nIHRoZSBEYXRhc2V0dGUgc2VydmVyIHdpdGggcmVxdWVzdHMsIHNvIEknbSBcbi8vIGNoZWF0aW5nIGFuZCBsb2FkaW5nIGEgQ1NWIGV4dHJhY3QgaW5zdGVhZC4gSXQgY29tZXMgZnJvbSB0aGlzIHF1ZXJ5OiBcbi8vIGh0dHBzOi8vZm9yZWlnbmFzc2lzdGFuY2UtZGF0YS5hbmRyZXdoZWlzcy5jb20vMjAyNS0wMi0wM19mb3JlaWduLWFzc2lzdGFuY2UuY3N2P3NxbD1TRUxFQ1QrJTIyQ291bnRyeStDb2RlJTIyJTJDKyUyMkNvdW50cnkrTmFtZSUyMiUyQyslMjJSZWdpb24rTmFtZSUyMiUyQytTVU0lMjglMjJjb25zdGFudF9hbW91bnQlMjIlMjkrQVMrdG90YWxfY29uc3RhbnRfYW1vdW50JTBEJTBBKytGUk9NKyUyMi4lMkZ1c19mb3JlaWduX2FpZF9jb3VudHJ5JTIyJTBEJTBBKytXSEVSRSslMjJGaXNjYWwrWWVhciUyMislM0QrJTI3MjAyMyUyNyslMEQlMEErKysrQU5EKyUyMlRyYW5zYWN0aW9uK1R5cGUrTmFtZSUyMislM0QrJTI3T2JsaWdhdGlvbnMlMjcrJTBEJTBBKysrK0FORCslMjJDb3VudHJ5K05hbWUlMjIrTk9UK0xJS0UrJTI3JTI1UmVnaW9uJTI1JTI3KyUwRCUwQSsrKytBTkQrJTIyQ291bnRyeStOYW1lJTIyKyUyMSUzRCslMjJXb3JsZCUyMiUwRCUwQSsrR1JPVVArQlkrJTIyQ291bnRyeStDb2RlJTIyJTJDKyUyMkNvdW50cnkrTmFtZSUyMiUyQyslMjJSZWdpb24rTmFtZSUyMiUwRCUwQSsrT1JERVIrQlkrdG90YWxfY29uc3RhbnRfYW1vdW50K0RFU0MlM0ImX3NpemU9bWF4XG5yZWNpcGllbnRfY291bnRyaWVzID0gYXdhaXQgRmlsZUF0dGFjaG1lbnQoXCJyZWNpcGllbnRfY291bnRyaWVzLmNzdlwiKS5jc3YoeyB0eXBlZDogdHJ1ZSB9KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yNyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InJlY2lwaWVudF9jb3VudHJpZXNcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjgiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJjb3VudHJ5X3RvdGFscyA9IG5ldyBNYXAocmVjaXBpZW50X2NvdW50cmllcy5tYXAoZCA9PiBbZFtcIkNvdW50cnkgQ29kZVwiXSwgZC50b3RhbF9jb25zdGFudF9hbW91bnRdKSlcbmNvdW50cnlfdG90YWxzXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTI5IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiY291bnRyeV90b3RhbHMuZ2V0KFwiVUtSXCIpXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTMwIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiB3b3JsZF9zYW5zX3Blbmd1aW5zX3JvYmluc29uLFxuICB3aWR0aDogd29ybGRfbWFwX3dpZHRoLFxuICBoZWlnaHQ6IHdvcmxkX21hcF9oZWlnaHQsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMX0gKSxcbiAgICBQbG90Lmdlbyh3b3JsZF9zYW5zX3Blbmd1aW5zLCBQbG90LmNlbnRyb2lkKHtcbiAgICAgIGZpbGw6IGQgPT4gY291bnRyeV90b3RhbHMuZ2V0KGQucHJvcGVydGllcy5pc29fYTMpXG4gICAgfSkpXG4gIF1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTMxIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiB3b3JsZF9zYW5zX3Blbmd1aW5zX3JvYmluc29uLFxuICB3aWR0aDogd29ybGRfbWFwX3dpZHRoLFxuICBoZWlnaHQ6IHdvcmxkX21hcF9oZWlnaHQsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMX0gKSxcbiAgICBQbG90Lmdlbyh3b3JsZF9zYW5zX3Blbmd1aW5zLCBQbG90LmNlbnRyb2lkKHtcbiAgICAgIGZpbGw6IGQgPT4gY291bnRyeV90b3RhbHMuZ2V0KGQucHJvcGVydGllcy5pc29fYTMpXG4gICAgfSkpLFxuICAgIFBsb3QuZ2VvKHdvcmxkX3NhbnNfcGVuZ3VpbnMsIHsgIC8vPDxcbiAgICAgIHN0cm9rZTogXCJibGFja1wiLCAgLy88PFxuICAgICAgc3Ryb2tlV2lkdGg6IDAuNSAgLy88PFxuICAgIH0pICAvLzw8XG4gIF1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTMyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiB3b3JsZF9zYW5zX3Blbmd1aW5zX3JvYmluc29uLFxuICB3aWR0aDogd29ybGRfbWFwX3dpZHRoLFxuICBoZWlnaHQ6IHdvcmxkX21hcF9oZWlnaHQsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMX0gKSxcbiAgICBQbG90Lmdlbyh3b3JsZF9zYW5zX3Blbmd1aW5zLCBQbG90LmNlbnRyb2lkKHtcbiAgICAgIGZpbGw6IGQgPT4gY291bnRyeV90b3RhbHMuZ2V0KGQucHJvcGVydGllcy5pc29fYTMpXG4gICAgfSkpLFxuICAgIFBsb3QuZ2VvKHdvcmxkX3NhbnNfcGVuZ3VpbnMsIHtcbiAgICAgIHN0cm9rZTogXCJibGFja1wiLFxuICAgICAgc3Ryb2tlV2lkdGg6IDAuNVxuICAgIH0pXG4gIF0sXG4gIGNvbG9yOiB7ICAvLzw8XG4gICAgc2NoZW1lOiBcImJsdWVzXCIsICAvLzw8XG4gICAgdW5rbm93bjogXCIjZjJmMmYyXCIsICAvLzw8XG4gICAgdHlwZTogXCJsb2dcIiwgICAvLzw8XG4gICAgbGVnZW5kOiB0cnVlLCAgLy88PFxuICAgIGxhYmVsOiBcIlRvdGFsIG9ibGlnYXRpb25zXCIsICAvLzw8XG4gIH0gIC8vPDxcbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTMzIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiB3b3JsZF9zYW5zX3Blbmd1aW5zX3JvYmluc29uLFxuICB3aWR0aDogd29ybGRfbWFwX3dpZHRoLFxuICBoZWlnaHQ6IHdvcmxkX21hcF9oZWlnaHQsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMX0gKSxcbiAgICBQbG90Lmdlbyh3b3JsZF9zYW5zX3Blbmd1aW5zLCBQbG90LmNlbnRyb2lkKHtcbiAgICAgIGZpbGw6IGQgPT4gY291bnRyeV90b3RhbHMuZ2V0KGQucHJvcGVydGllcy5pc29fYTMpLFxuICAgICAgdGlwOiB0cnVlIC8vPDxcbiAgICB9KSksXG4gICAgUGxvdC5nZW8od29ybGRfc2Fuc19wZW5ndWlucywge1xuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC41XG4gICAgfSlcbiAgXSxcbiAgY29sb3I6IHtcbiAgICBzY2hlbWU6IFwiYmx1ZXNcIixcbiAgICB1bmtub3duOiBcIiNmMmYyZjJcIixcbiAgICB0eXBlOiBcImxvZ1wiLCBcbiAgICBsZWdlbmQ6IHRydWUsXG4gICAgbGFiZWw6IFwiVG90YWwgb2JsaWdhdGlvbnNcIixcbiAgfVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMzQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcblBsb3QucGxvdCh7XG4gIHByb2plY3Rpb246IHdvcmxkX3NhbnNfcGVuZ3VpbnNfcm9iaW5zb24sXG4gIHdpZHRoOiB3b3JsZF9tYXBfd2lkdGgsXG4gIGhlaWdodDogd29ybGRfbWFwX2hlaWdodCxcbiAgbWFya3M6IFtcbiAgICBQbG90LmZyYW1lKHsgc3Ryb2tlOiBcImJsYWNrXCIsIHN0cm9rZVdpZHRoOiAxfSApLFxuICAgIFBsb3QuZ2VvKHdvcmxkX3NhbnNfcGVuZ3VpbnMsIFBsb3QuY2VudHJvaWQoe1xuICAgICAgZmlsbDogZCA9PiBjb3VudHJ5X3RvdGFscy5nZXQoZC5wcm9wZXJ0aWVzLmlzb19hMyksXG4gICAgICBjaGFubmVsczogeyAvLzw8XG4gICAgICAgIENvdW50cnk6IGQgPT4gZC5wcm9wZXJ0aWVzLm5hbWUsIC8vPDxcbiAgICAgIH0sIC8vPDxcbiAgICAgIHRpcDogeyAvLzw8XG4gICAgICAgIGZvcm1hdDogeyAvLzw8XG4gICAgICAgICAgQ291bnRyeTogdHJ1ZSwgLy88PFxuICAgICAgICAgIGZpbGw6IGQzLmZvcm1hdChcIiQsZFwiKSAvLzw8XG4gICAgICAgIH0gLy88PFxuICAgICAgfSAvLzw8XG4gICAgfSkpLFxuICAgIFBsb3QuZ2VvKHdvcmxkX3NhbnNfcGVuZ3VpbnMsIHtcbiAgICAgIHN0cm9rZTogXCJibGFja1wiLFxuICAgICAgc3Ryb2tlV2lkdGg6IDAuNVxuICAgIH0pXG4gIF0sXG4gIGNvbG9yOiB7XG4gICAgc2NoZW1lOiBcImJsdWVzXCIsXG4gICAgdW5rbm93bjogXCIjZjJmMmYyXCIsXG4gICAgdHlwZTogXCJsb2dcIiwgXG4gICAgbGVnZW5kOiB0cnVlLFxuICAgIGxhYmVsOiBcIlRvdGFsIG9ibGlnYXRpb25zXCIsXG4gIH1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTM1IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiZnVuY3Rpb24gZm9ybWF0X2FpZF90b3RhbCh2YWx1ZSkge1xuICByZXR1cm4gdmFsdWUgPyBkMy5mb3JtYXQoXCIkLGRcIikodmFsdWUpIDogXCJObyBhaWRcIjtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMzYiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJmb3JtYXRfYWlkX3RvdGFsKDM5NDAyMylcbmZvcm1hdF9haWRfdG90YWwoTmFOKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zNyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Im51bWJlcl9pbl9iaWxsaW9ucyA9IDEzODQwOTE4MjkxICAvLyBBIGJpZyBudW1iZXIgSSByYW5kb21seSB0eXBlZFxuXG4vLyBCaWxsaW9ucyBvZiBkb2xsYXJzIGluc3RlYWQgb2YgU0ktc3R5bGUgZ2lnYWRvbGxhcnNcbmQzLmZvcm1hdChcIiQuNHNcIikobnVtYmVyX2luX2JpbGxpb25zKS5yZXBsYWNlKFwiR1wiLCBcIkJcIilcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMzgiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcblBsb3QucGxvdCh7XG4gIHByb2plY3Rpb246IHdvcmxkX3NhbnNfcGVuZ3VpbnNfcm9iaW5zb24sXG4gIHdpZHRoOiB3b3JsZF9tYXBfd2lkdGgsXG4gIGhlaWdodDogd29ybGRfbWFwX2hlaWdodCxcbiAgbWFya3M6IFtcbiAgICBQbG90LmZyYW1lKHsgc3Ryb2tlOiBcImJsYWNrXCIsIHN0cm9rZVdpZHRoOiAxfSApLFxuICAgIFBsb3QuZ2VvKHdvcmxkX3NhbnNfcGVuZ3VpbnMsIFBsb3QuY2VudHJvaWQoe1xuICAgICAgZmlsbDogZCA9PiBjb3VudHJ5X3RvdGFscy5nZXQoZC5wcm9wZXJ0aWVzLmlzb19hMyksXG4gICAgICBjaGFubmVsczoge1xuICAgICAgICBDb3VudHJ5OiBkID0+IGQucHJvcGVydGllcy5uYW1lLFxuICAgICAgfSxcbiAgICAgIHRpcDoge1xuICAgICAgICBmb3JtYXQ6IHtcbiAgICAgICAgICBDb3VudHJ5OiB0cnVlLFxuICAgICAgICAgIGZpbGw6IGQgPT4gZm9ybWF0X2FpZF90b3RhbChkKSAvLzw8XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KSksXG4gICAgUGxvdC5nZW8od29ybGRfc2Fuc19wZW5ndWlucywge1xuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC41XG4gICAgfSlcbiAgXSxcbiAgY29sb3I6IHtcbiAgICBzY2hlbWU6IFwiYmx1ZXNcIixcbiAgICB1bmtub3duOiBcIiNmMmYyZjJcIixcbiAgICB0eXBlOiBcImxvZ1wiLCBcbiAgICBsZWdlbmQ6IHRydWUsXG4gICAgbGFiZWw6IFwiVG90YWwgb2JsaWdhdGlvbnNcIixcbiAgICB0aWNrRm9ybWF0OiBkID0+IGQzLmZvcm1hdChcIiQwLjJzXCIpKGQpLnJlcGxhY2UoXCJHXCIsIFwiQlwiKSAvLzw8XG4gIH1cbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTM5IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5QbG90LnBsb3Qoe1xuICBwcm9qZWN0aW9uOiB3b3JsZF9zYW5zX3Blbmd1aW5zX3JvYmluc29uLFxuICB3aWR0aDogd29ybGRfbWFwX3dpZHRoLFxuICBoZWlnaHQ6IHdvcmxkX21hcF9oZWlnaHQsXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5mcmFtZSh7IHN0cm9rZTogXCJibGFja1wiLCBzdHJva2VXaWR0aDogMX0gKSxcbiAgICBQbG90Lmdlbyh3b3JsZF9zYW5zX3Blbmd1aW5zLCBQbG90LmNlbnRyb2lkKHtcbiAgICAgIGZpbGw6IGQgPT4gY291bnRyeV90b3RhbHMuZ2V0KGQucHJvcGVydGllcy5pc29fYTMpLFxuICAgICAgY2hhbm5lbHM6IHtcbiAgICAgICAgQ291bnRyeTogZCA9PiBkLnByb3BlcnRpZXMubmFtZSxcbiAgICAgIH0sXG4gICAgICB0aXA6IHtcbiAgICAgICAgZm9udFNpemU6IDEyLCAvLzw8XG4gICAgICAgIGZvcm1hdDoge1xuICAgICAgICAgIENvdW50cnk6IHRydWUsXG4gICAgICAgICAgZmlsbDogZCA9PiBmb3JtYXRfYWlkX3RvdGFsKGQpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KSksXG4gICAgUGxvdC5nZW8od29ybGRfc2Fuc19wZW5ndWlucywge1xuICAgICAgc3Ryb2tlOiBcImJsYWNrXCIsXG4gICAgICBzdHJva2VXaWR0aDogMC4xNVxuICAgIH0pXG4gIF0sXG4gIGNvbG9yOiB7XG4gICAgLy8gc2NoZW1lOiBcImJsdWVzXCIsIC8vPDxcbiAgICByYW5nZTogW1wiI2Y5ZGRkYVwiLCBcIiNmMmI5YzRcIiwgXCIjZTU5N2I5XCIsIFwiI2NlNzhiM1wiLCBcIiNhZDVmYWRcIiwgXCIjODM0YmEwXCIsIFwiIzU3M2I4OFwiXSwgLy88PFxuICAgIHVua25vd246IFwiI2YyZjJmMlwiLFxuICAgIHR5cGU6IFwibG9nXCIsIFxuICAgIGxlZ2VuZDogdHJ1ZSxcbiAgICBsYWJlbDogXCJUb3RhbCBvYmxpZ2F0aW9uc1wiLFxuICAgIHRpY2tGb3JtYXQ6IGQgPT4gZDMuZm9ybWF0KFwiJDAuMnNcIikoZCkucmVwbGFjZShcIkdcIiwgXCJCXCIpLFxuICAgIHN0eWxlOiB7IC8vPDxcbiAgICAgIFwiZm9udC1zaXplXCI6IFwiMTRweFwiIC8vPDxcbiAgICB9IC8vPDxcbiAgfVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgncHJvamVjdGlvbicpIn1dfQ==
</script><script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../blog/2025/02/10/usaid-ojs-maps";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "../../../../..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.bradleyrentz\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb47" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Using USAID data to make fancy world maps with Observable Plot"</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-02-10</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Manipulate geographic data, change projections, get live data from a database, and make interactive plots with Observable JS"</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> img/final-plot.png</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="an">twitter-card:</span><span class="co"> </span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">    image: "img/final-plot.png"</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="an">open-graph:</span><span class="co"> </span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">    image: "img/final-plot.png"</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - ojs</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - observable plot</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - gis</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - maps</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - usaid</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="co">    shift-heading-level-by: 1</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 4</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: arrow</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="co">    include-in-header:</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co">      - text: |</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="co">          &lt;style type="text/css"&gt;</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="co">          div.sourceCode &gt; pre.sourceCode.js::before {</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="co">            content: 'Observable JS';</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="co">            display: block;</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="co">            text-align: left;</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="co">            font-size: 1em;</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="co">            margin-bottom: 7px;</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="co">            border-bottom: #dddddd 1px solid;</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="co">            padding-left: 4.25px;</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a><span class="co">            padding-bottom: 5px;</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="co">            color: #aaaaaa;</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="co">          }</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a><span class="co">          div.sourceCode &gt; pre.sourceCode.r::before {</span></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="co">            content: 'R';</span></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a><span class="co">            display: block;</span></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a><span class="co">            text-align: left;</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a><span class="co">            font-size: 1em;</span></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="co">            margin-bottom: 7px;</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a><span class="co">            border-bottom: #dddddd 1px solid;</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a><span class="co">            padding-left: 4.25px;</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="co">            padding-bottom: 5px;</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a><span class="co">            color: #aaaaaa;</span></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a><span class="co">          }</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a><span class="co">          div.sourceCode &gt; pre.sourceCode.sql::before {</span></span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a><span class="co">            content: 'SQL';</span></span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a><span class="co">            display: block;</span></span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a><span class="co">            text-align: left;</span></span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a><span class="co">            font-size: 1em;</span></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a><span class="co">            margin-bottom: 7px;</span></span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a><span class="co">            border-bottom: #dddddd 1px solid;</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a><span class="co">            padding-left: 4.25px;</span></span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a><span class="co">            padding-bottom: 5px;</span></span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a><span class="co">            color: #aaaaaa;</span></span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a><span class="co">          }</span></span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a><span class="co">          &lt;/style&gt;</span></span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a><span class="an">filters:</span></span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a><span class="co">  - line-highlight</span></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span></span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a><span class="co">  - "recipient_countries.csv"</span></span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/c0aep-hp989</span></span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>As part of Elon Musk's weird Department of Government Efficiency's unconstitutional rampage through the federal government, USAID's ForeignAssistance.gov was taken offline on January 31, 2025. It reappeared on February 3, but it's not clear how long it will be available, especially as USAID is gutted (despite court orders and injunctions to stop).</span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>I study civil society, human rights, and foreign aid and rely on USAID aid data for several of my <span class="co">[</span><span class="ot">research projects</span><span class="co">](https://www.andrewheiss.com/research/working-papers/chaudhry-heiss-ngos-aid/)</span>, so as a backup, I used <span class="co">[</span><span class="ot">Datasette</span><span class="co">](https://datasette.io/)</span> to create a mirror website/API of the entire ForeignAssistance.gov dataset at <span class="ot">&lt;https://foreignassistance-data.andrewheiss.com/&gt;</span>. Everything as of December 19, 2024 is available there, both as a queryable SQL database and as downloadable CSV files.</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>I also made <span class="co">[</span><span class="ot">a little frontend website</span><span class="co">](https://foreignassistance.andrewheiss.com/)</span> with links to each individual dataset. As I built that website, I decided to try recreating the ForeignAssistance.gov dashboard, which had neat interactive maps and tables.</span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a><span class="al">![ForeignAssistance.gov dashboard](img/foreign-assistance-gov.png)</span>{.border width="80%"}</span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>Since <span class="co">[</span><span class="ot">Quarto has native support</span><span class="co">](https://quarto.org/docs/interactive/ojs/)</span> for <span class="co">[</span><span class="ot">Observable JS</span><span class="co">](https://observablehq.com/@observablehq/observables-not-javascript)</span> for interactive work, and since I've meant to really dig into Observable and figure out how to make more interactive graphs, I figured I'd play around with the rescued USAID data.</span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a>So in this post, I show what I learned about working with geographic data and making pretty maps with <span class="co">[</span><span class="ot">Observable Plot</span><span class="co">](https://observablehq.com/plot/getting-started)</span>,</span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Caveat!</span></span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-90"><a href="#cb47-90" aria-hidden="true" tabindex="-1"></a>I'm really bad at Javascript! The code here is probably wildly inefficient and feels R-flavored.</span>
<span id="cb47-91"><a href="#cb47-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-92"><a href="#cb47-92" aria-hidden="true" tabindex="-1"></a>But it works, and that's all that matters :)</span>
<span id="cb47-93"><a href="#cb47-93" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb47-94"><a href="#cb47-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-95"><a href="#cb47-95" aria-hidden="true" tabindex="-1"></a><span class="fu"># Working with map data</span></span>
<span id="cb47-96"><a href="#cb47-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-97"><a href="#cb47-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## Get map data</span></span>
<span id="cb47-98"><a href="#cb47-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-99"><a href="#cb47-99" aria-hidden="true" tabindex="-1"></a>Observable Plot uses the <span class="co">[</span><span class="ot">`d3-geo`</span><span class="co">](https://github.com/d3/d3-geo)</span> module behind the scenes to parse and work with map data, and D3 typically works with data formatted as <span class="co">[</span><span class="ot">GeoJSON</span><span class="co">](https://en.wikipedia.org/wiki/GeoJSON)</span>. There are tons of high quality geographic data sources online, like the ~~US Census~~ (they've been removing those in the past few weeks), <span class="co">[</span><span class="ot">IPUMS NHGIS</span><span class="co">](https://www.nhgis.org/)</span>, <span class="co">[</span><span class="ot">IPUMS IHGIS</span><span class="co">](https://ihgis.ipums.org/)</span>, and the <span class="co">[</span><span class="ot">Natural Earth project</span><span class="co">](https://www.naturalearthdata.com/)</span>, and cities and states typically offer GIS data for public sector-related data. These data sources tend to be stored as <span class="co">[</span><span class="ot">shapefiles</span><span class="co">](https://en.wikipedia.org/wiki/Shapefile)</span>, which are a fairly complex (but standard) format for geographic data that involve multiple files.</span>
<span id="cb47-100"><a href="#cb47-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-101"><a href="#cb47-101" aria-hidden="true" tabindex="-1"></a>Observable Plot/D3 might be able to work with shapefiles directly, but it's nowhere in the documentation. They seem to expect GeoJSON instead. We could hunt around online for GeoJSON data, but—even better—we can use the {sf} package in R to convert any shapefile-based data into GeoJSON by setting <span class="in">`driver = "GeoJSON"`</span> in <span class="in">`sf::st_write()`</span>. Here we'll load two datasets from Natural Earth—(1) small scale low resolution 1:110m data for mapping the whole world and (2) medium scale 1:50m data for mapping specific regions and countries—and convert them to GeoJSON files.</span>
<span id="cb47-102"><a href="#cb47-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-105"><a href="#cb47-105" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb47-106"><a href="#cb47-106" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: save-geojson</span></span>
<span id="cb47-107"><a href="#cb47-107" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb47-108"><a href="#cb47-108" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb47-109"><a href="#cb47-109" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb47-110"><a href="#cb47-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-111"><a href="#cb47-111" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb47-112"><a href="#cb47-112" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb47-113"><a href="#cb47-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-114"><a href="#cb47-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Get low resolution Natural Earth data as map units instead of countries because of France</span></span>
<span id="cb47-115"><a href="#cb47-115" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="dv">110</span>, <span class="at">type =</span> <span class="st">"map_units"</span>)</span>
<span id="cb47-116"><a href="#cb47-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-117"><a href="#cb47-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Save as geojson for Observable Plot</span></span>
<span id="cb47-118"><a href="#cb47-118" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(</span>
<span id="cb47-119"><a href="#cb47-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">obj =</span> world, </span>
<span id="cb47-120"><a href="#cb47-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">dsn =</span> <span class="st">"ne_110m_admin_0_countries.geojson"</span>, </span>
<span id="cb47-121"><a href="#cb47-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">driver =</span> <span class="st">"GeoJSON"</span></span>
<span id="cb47-122"><a href="#cb47-122" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-123"><a href="#cb47-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-124"><a href="#cb47-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Save medium resolution geojson</span></span>
<span id="cb47-125"><a href="#cb47-125" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(</span>
<span id="cb47-126"><a href="#cb47-126" aria-hidden="true" tabindex="-1"></a>  <span class="at">obj =</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="dv">50</span>, <span class="at">type =</span> <span class="st">"countries"</span>), </span>
<span id="cb47-127"><a href="#cb47-127" aria-hidden="true" tabindex="-1"></a>  <span class="at">dsn =</span> <span class="st">"ne_50m_admin_0_countries.geojson"</span>, </span>
<span id="cb47-128"><a href="#cb47-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">driver =</span> <span class="st">"GeoJSON"</span></span>
<span id="cb47-129"><a href="#cb47-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-130"><a href="#cb47-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-131"><a href="#cb47-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-132"><a href="#cb47-132" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb47-133"><a href="#cb47-133" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Maybe skip intermediate saving?</span></span>
<span id="cb47-134"><a href="#cb47-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-135"><a href="#cb47-135" aria-hidden="true" tabindex="-1"></a>We could probably use <span class="co">[</span><span class="ot">Quarto's special R-to-OJS function `ojs_define()`</span><span class="co">](https://quarto.org/docs/interactive/ojs/data-sources.html#python-and-r)</span> and make these R objects directly accessible to OJS without needing to save intermediate files:</span>
<span id="cb47-136"><a href="#cb47-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-139"><a href="#cb47-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb47-140"><a href="#cb47-140" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb47-141"><a href="#cb47-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-142"><a href="#cb47-142" aria-hidden="true" tabindex="-1"></a><span class="fu">ojs_define</span>(<span class="at">world =</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="dv">110</span>, <span class="at">type =</span> <span class="st">"map_units"</span>))</span>
<span id="cb47-143"><a href="#cb47-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-144"><a href="#cb47-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-145"><a href="#cb47-145" aria-hidden="true" tabindex="-1"></a>…but geographic data is complex and I don't know how things like Observable Plot's <span class="in">`Plot.geo()`</span> handle data that's not read as GeoJSON. So to keep things simple, I ended up just saving these as GeoJSON. 🤷‍♂️</span>
<span id="cb47-146"><a href="#cb47-146" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb47-147"><a href="#cb47-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-148"><a href="#cb47-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-149"><a href="#cb47-149" aria-hidden="true" tabindex="-1"></a><span class="fu">## Maps and projections with Observable Plot</span></span>
<span id="cb47-150"><a href="#cb47-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-151"><a href="#cb47-151" aria-hidden="true" tabindex="-1"></a>We can load these into our document with OJS with <span class="in">`FileAttachment()`</span>:</span>
<span id="cb47-152"><a href="#cb47-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-155"><a href="#cb47-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-156"><a href="#cb47-156" aria-hidden="true" tabindex="-1"></a><span class="in">world = FileAttachment("ne_110m_admin_0_countries.geojson").json()</span></span>
<span id="cb47-157"><a href="#cb47-157" aria-hidden="true" tabindex="-1"></a><span class="in">world_medium = FileAttachment("ne_50m_admin_0_countries.geojson").json()</span></span>
<span id="cb47-158"><a href="#cb47-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-159"><a href="#cb47-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-160"><a href="#cb47-160" aria-hidden="true" tabindex="-1"></a>Check out the structure of <span class="in">`world`</span>. It's a <span class="in">`FeatureCollection`</span> with a slot named <span class="in">`crs`</span> with the projection information and a slot named <span class="in">`features`</span> with entries for each country. Each country <span class="in">`Feature`</span> has a slot named <span class="in">`properties`</span> with columns like <span class="in">`name`</span>, <span class="in">`iso_a3`</span>, <span class="in">`formal_en`</span>, <span class="in">`pop_est`</span>, and other details.</span>
<span id="cb47-161"><a href="#cb47-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-164"><a href="#cb47-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-165"><a href="#cb47-165" aria-hidden="true" tabindex="-1"></a><span class="in">world</span></span>
<span id="cb47-166"><a href="#cb47-166" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-167"><a href="#cb47-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-168"><a href="#cb47-168" aria-hidden="true" tabindex="-1"></a>To plot it, we can use <span class="co">[</span><span class="ot">the `Geo` mark</span><span class="co">](https://observablehq.com/plot/marks/geo)</span>:</span>
<span id="cb47-169"><a href="#cb47-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-172"><a href="#cb47-172" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-173"><a href="#cb47-173" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-174"><a href="#cb47-174" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-175"><a href="#cb47-175" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world)</span></span>
<span id="cb47-176"><a href="#cb47-176" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-177"><a href="#cb47-177" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-178"><a href="#cb47-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-179"><a href="#cb47-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-180"><a href="#cb47-180" aria-hidden="true" tabindex="-1"></a>To make things look nicer throughout this post, we'll define some nicer colors for countries and land and ocean from <span class="co">[</span><span class="ot">CARTOColors</span><span class="co">](https://carto.com/carto-colors/)</span>:</span>
<span id="cb47-181"><a href="#cb47-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-184"><a href="#cb47-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-185"><a href="#cb47-185" aria-hidden="true" tabindex="-1"></a><span class="in">// CARTOColors Prism</span></span>
<span id="cb47-186"><a href="#cb47-186" aria-hidden="true" tabindex="-1"></a><span class="in">carto_prism = [</span></span>
<span id="cb47-187"><a href="#cb47-187" aria-hidden="true" tabindex="-1"></a><span class="in">  "#5F4690", "#1D6996", "#38A6A5", "#0F8554", "#73AF48", "#EDAD08", </span></span>
<span id="cb47-188"><a href="#cb47-188" aria-hidden="true" tabindex="-1"></a><span class="in">  "#E17C05", "#CC503E", "#94346E", "#6F4070", "#994E95", "#666666"</span></span>
<span id="cb47-189"><a href="#cb47-189" aria-hidden="true" tabindex="-1"></a><span class="in">]</span></span>
<span id="cb47-190"><a href="#cb47-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-191"><a href="#cb47-191" aria-hidden="true" tabindex="-1"></a><span class="in">// From R:</span></span>
<span id="cb47-192"><a href="#cb47-192" aria-hidden="true" tabindex="-1"></a><span class="in">// clr_ocean &lt;- colorspace::lighten("#88CCEE", 0.7)</span></span>
<span id="cb47-193"><a href="#cb47-193" aria-hidden="true" tabindex="-1"></a><span class="in">clr_ocean = "#D9F0FF"</span></span>
<span id="cb47-194"><a href="#cb47-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-195"><a href="#cb47-195" aria-hidden="true" tabindex="-1"></a><span class="in">// From CARTOColors Peach 2</span></span>
<span id="cb47-196"><a href="#cb47-196" aria-hidden="true" tabindex="-1"></a><span class="in">clr_land = "#facba6"</span></span>
<span id="cb47-197"><a href="#cb47-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-198"><a href="#cb47-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-199"><a href="#cb47-199" aria-hidden="true" tabindex="-1"></a>We'll make the land be orange-ish, add some thin black borders around the countries, and include a blue background color with <span class="in">`Plot.frame()`</span>:</span>
<span id="cb47-200"><a href="#cb47-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-203"><a href="#cb47-203" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-204"><a href="#cb47-204" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-205"><a href="#cb47-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-206"><a href="#cb47-206" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-207"><a href="#cb47-207" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-208"><a href="#cb47-208" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean }),  //&lt;&lt;</span></span>
<span id="cb47-209"><a href="#cb47-209" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world, { //&lt;&lt;</span></span>
<span id="cb47-210"><a href="#cb47-210" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black", //&lt;&lt;</span></span>
<span id="cb47-211"><a href="#cb47-211" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5, //&lt;&lt;</span></span>
<span id="cb47-212"><a href="#cb47-212" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land //&lt;&lt;</span></span>
<span id="cb47-213"><a href="#cb47-213" aria-hidden="true" tabindex="-1"></a><span class="in">    }) //&lt;&lt;</span></span>
<span id="cb47-214"><a href="#cb47-214" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-215"><a href="#cb47-215" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-216"><a href="#cb47-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-217"><a href="#cb47-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-218"><a href="#cb47-218" aria-hidden="true" tabindex="-1"></a><span class="fu">### Built-in projections</span></span>
<span id="cb47-219"><a href="#cb47-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-220"><a href="#cb47-220" aria-hidden="true" tabindex="-1"></a>Taking a round globe and smashing it on a two-dimensional surface <span class="co">[</span><span class="ot">always requires geometric shenanigans to get things flat</span><span class="co">](https://datavizsp25.classes.andrewheiss.com/example/12-example.html#projections-and-coordinate-reference-systems)</span>. We can control how things get flattened by specifying the projection for the map. Here we'll use the <span class="co">[</span><span class="ot">Equal Earth projection</span><span class="co">](https://en.wikipedia.org/wiki/Equal_Earth_projection)</span> (invented in 2018 to show countries and continents at their true relative sizes to each other). Since projections contain relative height and width details, we need to specify a width for the plot now. I arbitrarily chose 1000 pixels here, which is the maximum width—it should autoshrink in smaller browser windows, and the height should be calculated automatically. Finally, instead of adding the background color with <span class="in">`Plot.frame()`</span>, we can use <span class="in">`Plot.sphere()`</span> to get a nicer background that uses the specified projection:</span>
<span id="cb47-221"><a href="#cb47-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-224"><a href="#cb47-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-225"><a href="#cb47-225" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-226"><a href="#cb47-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-227"><a href="#cb47-227" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-228"><a href="#cb47-228" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: "equal-earth", //&lt;&lt;</span></span>
<span id="cb47-229"><a href="#cb47-229" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000, //&lt;&lt;</span></span>
<span id="cb47-230"><a href="#cb47-230" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-231"><a href="#cb47-231" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.sphere({ fill: clr_ocean }), //&lt;&lt;</span></span>
<span id="cb47-232"><a href="#cb47-232" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world, {</span></span>
<span id="cb47-233"><a href="#cb47-233" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-234"><a href="#cb47-234" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-235"><a href="#cb47-235" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-236"><a href="#cb47-236" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-237"><a href="#cb47-237" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-238"><a href="#cb47-238" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-239"><a href="#cb47-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-240"><a href="#cb47-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-241"><a href="#cb47-241" aria-hidden="true" tabindex="-1"></a>The Observable Plot library <span class="co">[</span><span class="ot">includes a bunch of common built-in projections</span><span class="co">](https://observablehq.com/plot/features/projections#projection-options)</span>:</span>
<span id="cb47-242"><a href="#cb47-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-243"><a href="#cb47-243" aria-hidden="true" tabindex="-1"></a>:::{.column-body-outset}</span>
<span id="cb47-244"><a href="#cb47-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-247"><a href="#cb47-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-248"><a href="#cb47-248" aria-hidden="true" tabindex="-1"></a><span class="in">//| panel: sidebar</span></span>
<span id="cb47-249"><a href="#cb47-249" aria-hidden="true" tabindex="-1"></a><span class="in">//| echo: false</span></span>
<span id="cb47-250"><a href="#cb47-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-251"><a href="#cb47-251" aria-hidden="true" tabindex="-1"></a><span class="in">viewof projection = Inputs.select(</span></span>
<span id="cb47-252"><a href="#cb47-252" aria-hidden="true" tabindex="-1"></a><span class="in">  ["equirectangular", "equal-earth", "mercator", "transverse-mercator", "azimuthal-equal-area", "gnomonic"],</span></span>
<span id="cb47-253"><a href="#cb47-253" aria-hidden="true" tabindex="-1"></a><span class="in">  {value: "azimuthal-equal-area", label: "Projection"}</span></span>
<span id="cb47-254"><a href="#cb47-254" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb47-255"><a href="#cb47-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-256"><a href="#cb47-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-259"><a href="#cb47-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-260"><a href="#cb47-260" aria-hidden="true" tabindex="-1"></a><span class="in">//| panel: fill</span></span>
<span id="cb47-261"><a href="#cb47-261" aria-hidden="true" tabindex="-1"></a><span class="in">//| echo: false</span></span>
<span id="cb47-262"><a href="#cb47-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-263"><a href="#cb47-263" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-264"><a href="#cb47-264" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: projection,</span></span>
<span id="cb47-265"><a href="#cb47-265" aria-hidden="true" tabindex="-1"></a><span class="in">  // width,</span></span>
<span id="cb47-266"><a href="#cb47-266" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-267"><a href="#cb47-267" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.sphere({ fill: clr_ocean }),</span></span>
<span id="cb47-268"><a href="#cb47-268" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world, {</span></span>
<span id="cb47-269"><a href="#cb47-269" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-270"><a href="#cb47-270" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-271"><a href="#cb47-271" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-272"><a href="#cb47-272" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-273"><a href="#cb47-273" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-274"><a href="#cb47-274" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-275"><a href="#cb47-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-276"><a href="#cb47-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-277"><a href="#cb47-277" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb47-278"><a href="#cb47-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-279"><a href="#cb47-279" aria-hidden="true" tabindex="-1"></a><span class="fu">### Other projections</span></span>
<span id="cb47-280"><a href="#cb47-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-281"><a href="#cb47-281" aria-hidden="true" tabindex="-1"></a>Observable Plot can support any other D3 projection too. There are a whole bunch of projections in the <span class="co">[</span><span class="ot">main `d3-geo` module</span><span class="co">](https://github.com/d3/d3-geo)</span>, and there's a separate <span class="co">[</span><span class="ot">`d3-geo-projection`</span><span class="co">](https://github.com/d3/d3-geo-projection)</span> module for dozens of others. My favorite global projection is <span class="co">[</span><span class="ot">Robinson</span><span class="co">](https://en.wikipedia.org/wiki/Robinson_projection)</span> (the foundation for Equal Earth), which lives in <span class="in">`d3-geo-projection`</span>. To use it, we can import the module with <span class="in">`require()`</span> and then access it with <span class="in">`d3_geo_projection.geoRobinson()`</span>:</span>
<span id="cb47-282"><a href="#cb47-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-285"><a href="#cb47-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-286"><a href="#cb47-286" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-287"><a href="#cb47-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-288"><a href="#cb47-288" aria-hidden="true" tabindex="-1"></a><span class="in">d3_geo_projection = require("d3-geo-projection") //&lt;&lt;</span></span>
<span id="cb47-289"><a href="#cb47-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-290"><a href="#cb47-290" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-291"><a href="#cb47-291" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: d3_geo_projection.geoRobinson(), //&lt;&lt;</span></span>
<span id="cb47-292"><a href="#cb47-292" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000,</span></span>
<span id="cb47-293"><a href="#cb47-293" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 500, //&lt;&lt;</span></span>
<span id="cb47-294"><a href="#cb47-294" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-295"><a href="#cb47-295" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.sphere({ fill: clr_ocean }),</span></span>
<span id="cb47-296"><a href="#cb47-296" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world, {</span></span>
<span id="cb47-297"><a href="#cb47-297" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-298"><a href="#cb47-298" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-299"><a href="#cb47-299" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-300"><a href="#cb47-300" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-301"><a href="#cb47-301" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-302"><a href="#cb47-302" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-303"><a href="#cb47-303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-304"><a href="#cb47-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-305"><a href="#cb47-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-306"><a href="#cb47-306" aria-hidden="true" tabindex="-1"></a><span class="fu">## Filtering map data and adjusting projections</span></span>
<span id="cb47-307"><a href="#cb47-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-308"><a href="#cb47-308" aria-hidden="true" tabindex="-1"></a><span class="fu">### Removing elements</span></span>
<span id="cb47-309"><a href="#cb47-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-310"><a href="#cb47-310" aria-hidden="true" tabindex="-1"></a>Now that we have a nice projection, we can tweak the map a little. Antarctica is taking up a big proportion of the southern hemisphere, so we'll filter it out. The <span class="in">`world`</span> object that has all the map data keeps each country object inside a <span class="in">`features`</span> slot:</span>
<span id="cb47-311"><a href="#cb47-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-314"><a href="#cb47-314" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-315"><a href="#cb47-315" aria-hidden="true" tabindex="-1"></a><span class="in">world.features</span></span>
<span id="cb47-316"><a href="#cb47-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-317"><a href="#cb47-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-318"><a href="#cb47-318" aria-hidden="true" tabindex="-1"></a>We can filter it using Javascript's <span class="in">`.filter()`</span> function. To make sure that the resulting array keeps the geographic-ness of the data and is a <span class="in">`FeatureCollection`</span>, we need to create a similarly structured object, with <span class="in">`type`</span> and <span class="in">`features`</span> slots:</span>
<span id="cb47-319"><a href="#cb47-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-322"><a href="#cb47-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-323"><a href="#cb47-323" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-324"><a href="#cb47-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-325"><a href="#cb47-325" aria-hidden="true" tabindex="-1"></a><span class="in">// Antarctica's ISO3 code is ATA</span></span>
<span id="cb47-326"><a href="#cb47-326" aria-hidden="true" tabindex="-1"></a><span class="in">world_sans_penguins = ({ //&lt;&lt;</span></span>
<span id="cb47-327"><a href="#cb47-327" aria-hidden="true" tabindex="-1"></a><span class="in">  type: "FeatureCollection", //&lt;&lt;</span></span>
<span id="cb47-328"><a href="#cb47-328" aria-hidden="true" tabindex="-1"></a><span class="in">  features: world.features.filter(d =&gt; d.properties.iso_a3 !== "ATA") //&lt;&lt;</span></span>
<span id="cb47-329"><a href="#cb47-329" aria-hidden="true" tabindex="-1"></a><span class="in">}) //&lt;&lt;</span></span>
<span id="cb47-330"><a href="#cb47-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-331"><a href="#cb47-331" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-332"><a href="#cb47-332" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: d3_geo_projection.geoRobinson(),</span></span>
<span id="cb47-333"><a href="#cb47-333" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000,</span></span>
<span id="cb47-334"><a href="#cb47-334" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 500,</span></span>
<span id="cb47-335"><a href="#cb47-335" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-336"><a href="#cb47-336" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.sphere({ fill: clr_ocean }),</span></span>
<span id="cb47-337"><a href="#cb47-337" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, { //&lt;&lt;</span></span>
<span id="cb47-338"><a href="#cb47-338" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-339"><a href="#cb47-339" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-340"><a href="#cb47-340" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-341"><a href="#cb47-341" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-342"><a href="#cb47-342" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-343"><a href="#cb47-343" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-344"><a href="#cb47-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-345"><a href="#cb47-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-346"><a href="#cb47-346" aria-hidden="true" tabindex="-1"></a>That works and Antarctica is gone, as expected, but in reality the map didn't actually change that much. Even if we stop using the sphere background and just fill the plot frame, we can see that the area where Antarctica was is still there, it's just missing the land itself:</span>
<span id="cb47-347"><a href="#cb47-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-350"><a href="#cb47-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-351"><a href="#cb47-351" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-352"><a href="#cb47-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-353"><a href="#cb47-353" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-354"><a href="#cb47-354" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: d3_geo_projection.geoRobinson(),</span></span>
<span id="cb47-355"><a href="#cb47-355" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000,</span></span>
<span id="cb47-356"><a href="#cb47-356" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 500,</span></span>
<span id="cb47-357"><a href="#cb47-357" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-358"><a href="#cb47-358" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }), //&lt;&lt;</span></span>
<span id="cb47-359"><a href="#cb47-359" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-360"><a href="#cb47-360" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-361"><a href="#cb47-361" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-362"><a href="#cb47-362" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-363"><a href="#cb47-363" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-364"><a href="#cb47-364" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-365"><a href="#cb47-365" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-366"><a href="#cb47-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-367"><a href="#cb47-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-368"><a href="#cb47-368" aria-hidden="true" tabindex="-1"></a><span class="fu">### Quick and dirty cheating method: change the width or height</span></span>
<span id="cb47-369"><a href="#cb47-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-370"><a href="#cb47-370" aria-hidden="true" tabindex="-1"></a>One quick and dirty solution is to mess with the dimensions and shrink the height. After some trial and error, 430 pixels looks good:</span>
<span id="cb47-371"><a href="#cb47-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-374"><a href="#cb47-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-375"><a href="#cb47-375" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-376"><a href="#cb47-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-377"><a href="#cb47-377" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-378"><a href="#cb47-378" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: d3_geo_projection.geoRobinson(),</span></span>
<span id="cb47-379"><a href="#cb47-379" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000,</span></span>
<span id="cb47-380"><a href="#cb47-380" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 430, //&lt;&lt;</span></span>
<span id="cb47-381"><a href="#cb47-381" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-382"><a href="#cb47-382" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-383"><a href="#cb47-383" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-384"><a href="#cb47-384" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-385"><a href="#cb47-385" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-386"><a href="#cb47-386" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-387"><a href="#cb47-387" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-388"><a href="#cb47-388" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-389"><a href="#cb47-389" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-390"><a href="#cb47-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-391"><a href="#cb47-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-392"><a href="#cb47-392" aria-hidden="true" tabindex="-1"></a>While this works in this case, **it's not a universal solution**. The only reason this works is because Antarctica happens to be at the bottom of the map. When you adjust the height of the plot area, the map itself is *anchored to the top*. Like, if we set the height to 215, we'll get just the northern hemisphere:</span>
<span id="cb47-393"><a href="#cb47-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-396"><a href="#cb47-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-397"><a href="#cb47-397" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-398"><a href="#cb47-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-399"><a href="#cb47-399" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-400"><a href="#cb47-400" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: d3_geo_projection.geoRobinson(),</span></span>
<span id="cb47-401"><a href="#cb47-401" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000,</span></span>
<span id="cb47-402"><a href="#cb47-402" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 215, //&lt;&lt;</span></span>
<span id="cb47-403"><a href="#cb47-403" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-404"><a href="#cb47-404" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-405"><a href="#cb47-405" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-406"><a href="#cb47-406" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-407"><a href="#cb47-407" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-408"><a href="#cb47-408" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-409"><a href="#cb47-409" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-410"><a href="#cb47-410" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-411"><a href="#cb47-411" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-412"><a href="#cb47-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-413"><a href="#cb47-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-414"><a href="#cb47-414" aria-hidden="true" tabindex="-1"></a>As far as I can tell, there's no way to anchor the map in any other position. If we filter the map data to only look at one continent, there's no easy way to focus on just that continent by adjusting only the <span class="in">`width`</span> or <span class="in">`height`</span> options. Here's Africa all by itself in a big empty plot area:</span>
<span id="cb47-415"><a href="#cb47-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-418"><a href="#cb47-418" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-419"><a href="#cb47-419" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-420"><a href="#cb47-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-421"><a href="#cb47-421" aria-hidden="true" tabindex="-1"></a><span class="in">just_africa = ({ //&lt;&lt;</span></span>
<span id="cb47-422"><a href="#cb47-422" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "FeatureCollection", //&lt;&lt;</span></span>
<span id="cb47-423"><a href="#cb47-423" aria-hidden="true" tabindex="-1"></a><span class="in">    features: world.features.filter(d =&gt; d.properties.continent == "Africa") //&lt;&lt;</span></span>
<span id="cb47-424"><a href="#cb47-424" aria-hidden="true" tabindex="-1"></a><span class="in">}) //&lt;&lt;</span></span>
<span id="cb47-425"><a href="#cb47-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-426"><a href="#cb47-426" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-427"><a href="#cb47-427" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: d3_geo_projection.geoRobinson(),</span></span>
<span id="cb47-428"><a href="#cb47-428" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000,</span></span>
<span id="cb47-429"><a href="#cb47-429" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 430, //&lt;&lt;</span></span>
<span id="cb47-430"><a href="#cb47-430" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-431"><a href="#cb47-431" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-432"><a href="#cb47-432" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(just_africa, {</span></span>
<span id="cb47-433"><a href="#cb47-433" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-434"><a href="#cb47-434" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-435"><a href="#cb47-435" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-436"><a href="#cb47-436" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-437"><a href="#cb47-437" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-438"><a href="#cb47-438" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-439"><a href="#cb47-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-440"><a href="#cb47-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-441"><a href="#cb47-441" aria-hidden="true" tabindex="-1"></a>If we adjust the width or the height, the plot area will be resized with the map anchored in the top left corner so we're left with just the northwestern part of Africa (and big empty areas where North America, South America, and Europe would be):</span>
<span id="cb47-442"><a href="#cb47-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-445"><a href="#cb47-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-446"><a href="#cb47-446" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-447"><a href="#cb47-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-448"><a href="#cb47-448" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-449"><a href="#cb47-449" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: d3_geo_projection.geoRobinson(),</span></span>
<span id="cb47-450"><a href="#cb47-450" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 550, //&lt;&lt;</span></span>
<span id="cb47-451"><a href="#cb47-451" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 215, //&lt;&lt;</span></span>
<span id="cb47-452"><a href="#cb47-452" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-453"><a href="#cb47-453" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-454"><a href="#cb47-454" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(just_africa, {</span></span>
<span id="cb47-455"><a href="#cb47-455" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-456"><a href="#cb47-456" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-457"><a href="#cb47-457" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-458"><a href="#cb47-458" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-459"><a href="#cb47-459" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-460"><a href="#cb47-460" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-461"><a href="#cb47-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-462"><a href="#cb47-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-463"><a href="#cb47-463" aria-hidden="true" tabindex="-1"></a>That's not great, but there are better ways!</span>
<span id="cb47-464"><a href="#cb47-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-465"><a href="#cb47-465" aria-hidden="true" tabindex="-1"></a><span class="fu">### Built-in projections and domain settings</span></span>
<span id="cb47-466"><a href="#cb47-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-467"><a href="#cb47-467" aria-hidden="true" tabindex="-1"></a>The official Observable Plot method for fitting the plot window to a specific area of the map is to define a "domain" for one of the built-in projections to zoom in on specific areas. <span class="co">[</span><span class="ot">The documentation shows</span><span class="co">](https://observablehq.com/plot/features/projections#projections)</span> how to use special functions in <span class="in">`d3-geo`</span> to create a circle around a point, but you can also pass a GeoJSON object and Plot will use its boundaries for the domain. The built-in projection options also let us control the outside margin of the domain with <span class="in">`inset`</span>.</span>
<span id="cb47-468"><a href="#cb47-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-469"><a href="#cb47-469" aria-hidden="true" tabindex="-1"></a>Here's the world map without Antarctica with the Equal Earth projection, with the projection resized to fit within the bounds of <span class="in">`world_sans_penguins`</span>, with 10 pixels of padding around the landmass. Antarctica is gone now and the rest of the map is vertically centered within the plot area:</span>
<span id="cb47-470"><a href="#cb47-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-473"><a href="#cb47-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-474"><a href="#cb47-474" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-475"><a href="#cb47-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-476"><a href="#cb47-476" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-477"><a href="#cb47-477" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: { //&lt;&lt;</span></span>
<span id="cb47-478"><a href="#cb47-478" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "equal-earth", //&lt;&lt;</span></span>
<span id="cb47-479"><a href="#cb47-479" aria-hidden="true" tabindex="-1"></a><span class="in">    domain: world_sans_penguins, //&lt;&lt;</span></span>
<span id="cb47-480"><a href="#cb47-480" aria-hidden="true" tabindex="-1"></a><span class="in">    inset: 10 //&lt;&lt;</span></span>
<span id="cb47-481"><a href="#cb47-481" aria-hidden="true" tabindex="-1"></a><span class="in">  }, //&lt;&lt;</span></span>
<span id="cb47-482"><a href="#cb47-482" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000,</span></span>
<span id="cb47-483"><a href="#cb47-483" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-484"><a href="#cb47-484" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-485"><a href="#cb47-485" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-486"><a href="#cb47-486" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-487"><a href="#cb47-487" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-488"><a href="#cb47-488" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-489"><a href="#cb47-489" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-490"><a href="#cb47-490" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-491"><a href="#cb47-491" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-492"><a href="#cb47-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-493"><a href="#cb47-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-494"><a href="#cb47-494" aria-hidden="true" tabindex="-1"></a>We can see what's happening behind the scenes if we add <span class="in">`Plot.sphere()`</span> back in. The rounded globe area is still there, but it's shifted down and out of the frame. We're essentially panning around and zooming in on the Equal Earth projection:</span>
<span id="cb47-495"><a href="#cb47-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-498"><a href="#cb47-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-499"><a href="#cb47-499" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-500"><a href="#cb47-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-501"><a href="#cb47-501" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-502"><a href="#cb47-502" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: {</span></span>
<span id="cb47-503"><a href="#cb47-503" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "equal-earth",</span></span>
<span id="cb47-504"><a href="#cb47-504" aria-hidden="true" tabindex="-1"></a><span class="in">    domain: world_sans_penguins, </span></span>
<span id="cb47-505"><a href="#cb47-505" aria-hidden="true" tabindex="-1"></a><span class="in">    inset: 10</span></span>
<span id="cb47-506"><a href="#cb47-506" aria-hidden="true" tabindex="-1"></a><span class="in">  },</span></span>
<span id="cb47-507"><a href="#cb47-507" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 1000,</span></span>
<span id="cb47-508"><a href="#cb47-508" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-509"><a href="#cb47-509" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1 }), //&lt;&lt;</span></span>
<span id="cb47-510"><a href="#cb47-510" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.sphere({ fill: clr_ocean }), //&lt;&lt;</span></span>
<span id="cb47-511"><a href="#cb47-511" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-512"><a href="#cb47-512" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-513"><a href="#cb47-513" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-514"><a href="#cb47-514" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-515"><a href="#cb47-515" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-516"><a href="#cb47-516" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-517"><a href="#cb47-517" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-518"><a href="#cb47-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-519"><a href="#cb47-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-520"><a href="#cb47-520" aria-hidden="true" tabindex="-1"></a>Passing a GeoJSON object as the domain is really neat because it makes it straightforward to zoom in on specific areas. For instance, here's the complete medium resolution world map zoomed in around the <span class="in">`just_africa`</span> object, which keeps non-African countries in the Middle East and southern Europe:</span>
<span id="cb47-521"><a href="#cb47-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-524"><a href="#cb47-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-525"><a href="#cb47-525" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-526"><a href="#cb47-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-527"><a href="#cb47-527" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-528"><a href="#cb47-528" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: {</span></span>
<span id="cb47-529"><a href="#cb47-529" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "equal-earth",</span></span>
<span id="cb47-530"><a href="#cb47-530" aria-hidden="true" tabindex="-1"></a><span class="in">    domain: just_africa, //&lt;&lt;</span></span>
<span id="cb47-531"><a href="#cb47-531" aria-hidden="true" tabindex="-1"></a><span class="in">    inset: 10</span></span>
<span id="cb47-532"><a href="#cb47-532" aria-hidden="true" tabindex="-1"></a><span class="in">  },</span></span>
<span id="cb47-533"><a href="#cb47-533" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 600, //&lt;&lt;</span></span>
<span id="cb47-534"><a href="#cb47-534" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 600, //&lt;&lt;</span></span>
<span id="cb47-535"><a href="#cb47-535" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-536"><a href="#cb47-536" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-537"><a href="#cb47-537" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_medium, { //&lt;&lt;</span></span>
<span id="cb47-538"><a href="#cb47-538" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-539"><a href="#cb47-539" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-540"><a href="#cb47-540" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-541"><a href="#cb47-541" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-542"><a href="#cb47-542" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-543"><a href="#cb47-543" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-544"><a href="#cb47-544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-545"><a href="#cb47-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-546"><a href="#cb47-546" aria-hidden="true" tabindex="-1"></a>We could also extract Africa from the medium resolution world map and plot only that continent, omitting the Middle East and Europe:</span>
<span id="cb47-547"><a href="#cb47-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-550"><a href="#cb47-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-551"><a href="#cb47-551" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-552"><a href="#cb47-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-553"><a href="#cb47-553" aria-hidden="true" tabindex="-1"></a><span class="in">just_africa_medium = ({ //&lt;&lt;</span></span>
<span id="cb47-554"><a href="#cb47-554" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "FeatureCollection", //&lt;&lt;</span></span>
<span id="cb47-555"><a href="#cb47-555" aria-hidden="true" tabindex="-1"></a><span class="in">    features: world_medium.features.filter(d =&gt; d.properties.continent == "Africa") //&lt;&lt;</span></span>
<span id="cb47-556"><a href="#cb47-556" aria-hidden="true" tabindex="-1"></a><span class="in">}) //&lt;&lt;</span></span>
<span id="cb47-557"><a href="#cb47-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-558"><a href="#cb47-558" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-559"><a href="#cb47-559" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: {</span></span>
<span id="cb47-560"><a href="#cb47-560" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "equal-earth",</span></span>
<span id="cb47-561"><a href="#cb47-561" aria-hidden="true" tabindex="-1"></a><span class="in">    domain: just_africa,</span></span>
<span id="cb47-562"><a href="#cb47-562" aria-hidden="true" tabindex="-1"></a><span class="in">    inset: 10</span></span>
<span id="cb47-563"><a href="#cb47-563" aria-hidden="true" tabindex="-1"></a><span class="in">  },</span></span>
<span id="cb47-564"><a href="#cb47-564" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 600,</span></span>
<span id="cb47-565"><a href="#cb47-565" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 600,</span></span>
<span id="cb47-566"><a href="#cb47-566" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-567"><a href="#cb47-567" aria-hidden="true" tabindex="-1"></a><span class="in">    // Use a white background since we don't want to make it look like  //&lt;&lt;</span></span>
<span id="cb47-568"><a href="#cb47-568" aria-hidden="true" tabindex="-1"></a><span class="in">    // the Sinai peninsula has a coastline  //&lt;&lt;</span></span>
<span id="cb47-569"><a href="#cb47-569" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: "white", stroke: "black", strokeWidth: 1 }), //&lt;&lt;</span></span>
<span id="cb47-570"><a href="#cb47-570" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(just_africa_medium, {  //&lt;&lt;</span></span>
<span id="cb47-571"><a href="#cb47-571" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-572"><a href="#cb47-572" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-573"><a href="#cb47-573" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-574"><a href="#cb47-574" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-575"><a href="#cb47-575" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-576"><a href="#cb47-576" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-577"><a href="#cb47-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-578"><a href="#cb47-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-579"><a href="#cb47-579" aria-hidden="true" tabindex="-1"></a><span class="fu">### Other projections and `.fitExtent()`</span></span>
<span id="cb47-580"><a href="#cb47-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-581"><a href="#cb47-581" aria-hidden="true" tabindex="-1"></a>Unfortunately, it's a little bit trickier to set the domain and inset for projections that aren't built in to Plot. We *can't* do this:</span>
<span id="cb47-582"><a href="#cb47-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-583"><a href="#cb47-583" aria-hidden="true" tabindex="-1"></a><span class="in">```{.js}</span></span>
<span id="cb47-584"><a href="#cb47-584" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-585"><a href="#cb47-585" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: {</span></span>
<span id="cb47-586"><a href="#cb47-586" aria-hidden="true" tabindex="-1"></a><span class="in">    type: d3_geo_projection.geoRobinson(),</span></span>
<span id="cb47-587"><a href="#cb47-587" aria-hidden="true" tabindex="-1"></a><span class="in">    domain: world_sans_penguins,</span></span>
<span id="cb47-588"><a href="#cb47-588" aria-hidden="true" tabindex="-1"></a><span class="in">    inset: 10</span></span>
<span id="cb47-589"><a href="#cb47-589" aria-hidden="true" tabindex="-1"></a><span class="in">  },</span></span>
<span id="cb47-590"><a href="#cb47-590" aria-hidden="true" tabindex="-1"></a><span class="in">  ...</span></span>
<span id="cb47-591"><a href="#cb47-591" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-592"><a href="#cb47-592" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-593"><a href="#cb47-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-594"><a href="#cb47-594" aria-hidden="true" tabindex="-1"></a>Instead, we need to adjust the size of the projection window itself and build in the inset with <span class="co">[</span><span class="ot">`d3-geo`'s `.fitExtent()`</span><span class="co">](https://d3js.org/d3-geo/projection#projection_fitExtent)</span>. This function takes four arguments in an array like <span class="in">`[[x1, y1], [x2, y2]]`</span>, defining the top left and bottom right corners (in pixels) of a window that is centered in the middle of a given GeoJSON object. Here, for instance, we create a copy of the Robinson projection that has a window around <span class="in">`just_africa`</span> with a top left corner at (30, 30) and a bottom right corner at (570, 570):</span>
<span id="cb47-595"><a href="#cb47-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-598"><a href="#cb47-598" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-599"><a href="#cb47-599" aria-hidden="true" tabindex="-1"></a><span class="in">inset_africa = 30</span></span>
<span id="cb47-600"><a href="#cb47-600" aria-hidden="true" tabindex="-1"></a><span class="in">africa_map_width = 600</span></span>
<span id="cb47-601"><a href="#cb47-601" aria-hidden="true" tabindex="-1"></a><span class="in">africa_map_height = 600</span></span>
<span id="cb47-602"><a href="#cb47-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-603"><a href="#cb47-603" aria-hidden="true" tabindex="-1"></a><span class="in">africa_robinson = d3_geo_projection.geoRobinson()</span></span>
<span id="cb47-604"><a href="#cb47-604" aria-hidden="true" tabindex="-1"></a><span class="in">  .fitExtent(</span></span>
<span id="cb47-605"><a href="#cb47-605" aria-hidden="true" tabindex="-1"></a><span class="in">    [[inset_africa, inset_africa],  // Top left</span></span>
<span id="cb47-606"><a href="#cb47-606" aria-hidden="true" tabindex="-1"></a><span class="in">     [africa_map_width - inset_africa, africa_map_height - inset_africa]],  // Bottom right </span></span>
<span id="cb47-607"><a href="#cb47-607" aria-hidden="true" tabindex="-1"></a><span class="in">    just_africa</span></span>
<span id="cb47-608"><a href="#cb47-608" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb47-609"><a href="#cb47-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-610"><a href="#cb47-610" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-611"><a href="#cb47-611" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: africa_robinson,</span></span>
<span id="cb47-612"><a href="#cb47-612" aria-hidden="true" tabindex="-1"></a><span class="in">  width: africa_map_width,</span></span>
<span id="cb47-613"><a href="#cb47-613" aria-hidden="true" tabindex="-1"></a><span class="in">  height: africa_map_height,</span></span>
<span id="cb47-614"><a href="#cb47-614" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-615"><a href="#cb47-615" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-616"><a href="#cb47-616" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-617"><a href="#cb47-617" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-618"><a href="#cb47-618" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-619"><a href="#cb47-619" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-620"><a href="#cb47-620" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-621"><a href="#cb47-621" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-622"><a href="#cb47-622" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-623"><a href="#cb47-623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-624"><a href="#cb47-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-625"><a href="#cb47-625" aria-hidden="true" tabindex="-1"></a>We can use the same approach with individual countries. For extra fun, we'll fill these countries with distinct colors using Natural Earth's <span class="in">`mapcolor7`</span> column, which assigns countries one of 7 different colors that don't border other countries (so neighboring countries will never be the same color). We'll also add some labels in the middle of each country.</span>
<span id="cb47-626"><a href="#cb47-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-629"><a href="#cb47-629" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-630"><a href="#cb47-630" aria-hidden="true" tabindex="-1"></a><span class="in">egypt = world_medium.features.find(d =&gt; d.properties.name === "Egypt")</span></span>
<span id="cb47-631"><a href="#cb47-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-632"><a href="#cb47-632" aria-hidden="true" tabindex="-1"></a><span class="in">inset_egypt = 75</span></span>
<span id="cb47-633"><a href="#cb47-633" aria-hidden="true" tabindex="-1"></a><span class="in">egypt_map_width = 600</span></span>
<span id="cb47-634"><a href="#cb47-634" aria-hidden="true" tabindex="-1"></a><span class="in">egypt_map_height = 600</span></span>
<span id="cb47-635"><a href="#cb47-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-636"><a href="#cb47-636" aria-hidden="true" tabindex="-1"></a><span class="in">robinson_egypt = d3_geo_projection.geoRobinson()</span></span>
<span id="cb47-637"><a href="#cb47-637" aria-hidden="true" tabindex="-1"></a><span class="in">  .fitExtent(</span></span>
<span id="cb47-638"><a href="#cb47-638" aria-hidden="true" tabindex="-1"></a><span class="in">    [[inset_egypt, inset_egypt],  // Top left</span></span>
<span id="cb47-639"><a href="#cb47-639" aria-hidden="true" tabindex="-1"></a><span class="in">     [egypt_map_width - inset_egypt, egypt_map_height - inset_egypt]],  // Bottom right</span></span>
<span id="cb47-640"><a href="#cb47-640" aria-hidden="true" tabindex="-1"></a><span class="in">    egypt</span></span>
<span id="cb47-641"><a href="#cb47-641" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb47-642"><a href="#cb47-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-643"><a href="#cb47-643" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-644"><a href="#cb47-644" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: robinson_egypt,</span></span>
<span id="cb47-645"><a href="#cb47-645" aria-hidden="true" tabindex="-1"></a><span class="in">  width: egypt_map_width,</span></span>
<span id="cb47-646"><a href="#cb47-646" aria-hidden="true" tabindex="-1"></a><span class="in">  height: egypt_map_height,</span></span>
<span id="cb47-647"><a href="#cb47-647" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-648"><a href="#cb47-648" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-649"><a href="#cb47-649" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_medium, Plot.centroid({</span></span>
<span id="cb47-650"><a href="#cb47-650" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; d.properties.mapcolor7,</span></span>
<span id="cb47-651"><a href="#cb47-651" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black", </span></span>
<span id="cb47-652"><a href="#cb47-652" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5</span></span>
<span id="cb47-653"><a href="#cb47-653" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-654"><a href="#cb47-654" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(egypt, { stroke: "yellow", strokeWidth: 3 }),</span></span>
<span id="cb47-655"><a href="#cb47-655" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.tip(world_medium.features, Plot.centroid({</span></span>
<span id="cb47-656"><a href="#cb47-656" aria-hidden="true" tabindex="-1"></a><span class="in">      title: d =&gt; d.properties.name, </span></span>
<span id="cb47-657"><a href="#cb47-657" aria-hidden="true" tabindex="-1"></a><span class="in">      anchor: "top",</span></span>
<span id="cb47-658"><a href="#cb47-658" aria-hidden="true" tabindex="-1"></a><span class="in">      fontSize: 13,</span></span>
<span id="cb47-659"><a href="#cb47-659" aria-hidden="true" tabindex="-1"></a><span class="in">      fontWeight: "bold",</span></span>
<span id="cb47-660"><a href="#cb47-660" aria-hidden="true" tabindex="-1"></a><span class="in">      textPadding: 3</span></span>
<span id="cb47-661"><a href="#cb47-661" aria-hidden="true" tabindex="-1"></a><span class="in">    }))</span></span>
<span id="cb47-662"><a href="#cb47-662" aria-hidden="true" tabindex="-1"></a><span class="in">  ],</span></span>
<span id="cb47-663"><a href="#cb47-663" aria-hidden="true" tabindex="-1"></a><span class="in">  color: {</span></span>
<span id="cb47-664"><a href="#cb47-664" aria-hidden="true" tabindex="-1"></a><span class="in">    range: carto_prism</span></span>
<span id="cb47-665"><a href="#cb47-665" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb47-666"><a href="#cb47-666" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-667"><a href="#cb47-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-668"><a href="#cb47-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-669"><a href="#cb47-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-670"><a href="#cb47-670" aria-hidden="true" tabindex="-1"></a>The approach works for the whole <span class="in">`world_sans_penguins`</span> object as well. This addresses our original problem—here's a world map with the Robinson projection *without* Antarctica that fills the plot area correctly:</span>
<span id="cb47-671"><a href="#cb47-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-674"><a href="#cb47-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-675"><a href="#cb47-675" aria-hidden="true" tabindex="-1"></a><span class="in">inset_world = 10</span></span>
<span id="cb47-676"><a href="#cb47-676" aria-hidden="true" tabindex="-1"></a><span class="in">world_map_width = 1000</span></span>
<span id="cb47-677"><a href="#cb47-677" aria-hidden="true" tabindex="-1"></a><span class="in">world_map_height = 450</span></span>
<span id="cb47-678"><a href="#cb47-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-679"><a href="#cb47-679" aria-hidden="true" tabindex="-1"></a><span class="in">world_sans_penguins_robinson = d3_geo_projection.geoRobinson()</span></span>
<span id="cb47-680"><a href="#cb47-680" aria-hidden="true" tabindex="-1"></a><span class="in">  .fitExtent(</span></span>
<span id="cb47-681"><a href="#cb47-681" aria-hidden="true" tabindex="-1"></a><span class="in">    [[inset_world, inset_world],</span></span>
<span id="cb47-682"><a href="#cb47-682" aria-hidden="true" tabindex="-1"></a><span class="in">     [world_map_width - inset_world, world_map_height - inset_world]],</span></span>
<span id="cb47-683"><a href="#cb47-683" aria-hidden="true" tabindex="-1"></a><span class="in">    world_sans_penguins</span></span>
<span id="cb47-684"><a href="#cb47-684" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb47-685"><a href="#cb47-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-686"><a href="#cb47-686" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-687"><a href="#cb47-687" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-688"><a href="#cb47-688" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-689"><a href="#cb47-689" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-690"><a href="#cb47-690" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-691"><a href="#cb47-691" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-692"><a href="#cb47-692" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-693"><a href="#cb47-693" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-694"><a href="#cb47-694" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5,</span></span>
<span id="cb47-695"><a href="#cb47-695" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: clr_land</span></span>
<span id="cb47-696"><a href="#cb47-696" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-697"><a href="#cb47-697" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-698"><a href="#cb47-698" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-699"><a href="#cb47-699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-700"><a href="#cb47-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-701"><a href="#cb47-701" aria-hidden="true" tabindex="-1"></a><span class="fu">### Arbitrary areas and `.fitExtent()`</span></span>
<span id="cb47-702"><a href="#cb47-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-703"><a href="#cb47-703" aria-hidden="true" tabindex="-1"></a>For bonus fun, this approach also works for any arbitrary rectangles. For example, we can use <span class="co">[</span><span class="ot">OpenStreetMap's neat Export tool</span><span class="co">](https://www.openstreetmap.org/export#map=4/49.07/4.00)</span> to pick the top, bottom, left, and right edges of a box that focuses on Western Europe.</span>
<span id="cb47-704"><a href="#cb47-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-705"><a href="#cb47-705" aria-hidden="true" tabindex="-1"></a><span class="al">![Rectangle around western Europe with OpenStreetMap's Export tool](img/osm-export.png)</span>{width="80%"}</span>
<span id="cb47-706"><a href="#cb47-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-707"><a href="#cb47-707" aria-hidden="true" tabindex="-1"></a>We can then use those coordinates to create a <span class="in">`MultiPoint`</span> geometric feature/object, which essentially acts like a rectangular fake country/region that can be used as the domain or extent of the map:</span>
<span id="cb47-708"><a href="#cb47-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-711"><a href="#cb47-711" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-712"><a href="#cb47-712" aria-hidden="true" tabindex="-1"></a><span class="in">inset_europe = 10</span></span>
<span id="cb47-713"><a href="#cb47-713" aria-hidden="true" tabindex="-1"></a><span class="in">europe_map_width = 800</span></span>
<span id="cb47-714"><a href="#cb47-714" aria-hidden="true" tabindex="-1"></a><span class="in">europe_map_height = 800</span></span>
<span id="cb47-715"><a href="#cb47-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-716"><a href="#cb47-716" aria-hidden="true" tabindex="-1"></a><span class="in">europe_box = ({</span></span>
<span id="cb47-717"><a href="#cb47-717" aria-hidden="true" tabindex="-1"></a><span class="in">  type: "Feature",</span></span>
<span id="cb47-718"><a href="#cb47-718" aria-hidden="true" tabindex="-1"></a><span class="in">  geometry: {</span></span>
<span id="cb47-719"><a href="#cb47-719" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "MultiPoint",</span></span>
<span id="cb47-720"><a href="#cb47-720" aria-hidden="true" tabindex="-1"></a><span class="in">    coordinates: [</span></span>
<span id="cb47-721"><a href="#cb47-721" aria-hidden="true" tabindex="-1"></a><span class="in">      [-13, 35],  // [left/west, bottom/south] (or bottom left corner)</span></span>
<span id="cb47-722"><a href="#cb47-722" aria-hidden="true" tabindex="-1"></a><span class="in">      [21, 60]    // [right/east, top/north]   (or top right corner)</span></span>
<span id="cb47-723"><a href="#cb47-723" aria-hidden="true" tabindex="-1"></a><span class="in">    ]</span></span>
<span id="cb47-724"><a href="#cb47-724" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb47-725"><a href="#cb47-725" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-726"><a href="#cb47-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-727"><a href="#cb47-727" aria-hidden="true" tabindex="-1"></a><span class="in">europe_robinson = d3_geo_projection.geoRobinson()</span></span>
<span id="cb47-728"><a href="#cb47-728" aria-hidden="true" tabindex="-1"></a><span class="in">  .fitExtent(</span></span>
<span id="cb47-729"><a href="#cb47-729" aria-hidden="true" tabindex="-1"></a><span class="in">    [[inset_europe, inset_europe],</span></span>
<span id="cb47-730"><a href="#cb47-730" aria-hidden="true" tabindex="-1"></a><span class="in">     [europe_map_width - inset_europe, europe_map_height - inset_europe]], </span></span>
<span id="cb47-731"><a href="#cb47-731" aria-hidden="true" tabindex="-1"></a><span class="in">    europe_box</span></span>
<span id="cb47-732"><a href="#cb47-732" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb47-733"><a href="#cb47-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-734"><a href="#cb47-734" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-735"><a href="#cb47-735" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: europe_robinson,</span></span>
<span id="cb47-736"><a href="#cb47-736" aria-hidden="true" tabindex="-1"></a><span class="in">  width: europe_map_width,</span></span>
<span id="cb47-737"><a href="#cb47-737" aria-hidden="true" tabindex="-1"></a><span class="in">  height: europe_map_height,</span></span>
<span id="cb47-738"><a href="#cb47-738" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-739"><a href="#cb47-739" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ fill: clr_ocean, stroke: "black", strokeWidth: 1 }),</span></span>
<span id="cb47-740"><a href="#cb47-740" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_medium, Plot.centroid({</span></span>
<span id="cb47-741"><a href="#cb47-741" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; d.properties.mapcolor9,</span></span>
<span id="cb47-742"><a href="#cb47-742" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "white", </span></span>
<span id="cb47-743"><a href="#cb47-743" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.25</span></span>
<span id="cb47-744"><a href="#cb47-744" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-745"><a href="#cb47-745" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.tip(world.features, Plot.centroid({</span></span>
<span id="cb47-746"><a href="#cb47-746" aria-hidden="true" tabindex="-1"></a><span class="in">      title: d =&gt; d.properties.name, </span></span>
<span id="cb47-747"><a href="#cb47-747" aria-hidden="true" tabindex="-1"></a><span class="in">      anchor: "bottom",</span></span>
<span id="cb47-748"><a href="#cb47-748" aria-hidden="true" tabindex="-1"></a><span class="in">      fontSize: 13,</span></span>
<span id="cb47-749"><a href="#cb47-749" aria-hidden="true" tabindex="-1"></a><span class="in">      fontWeight: "bold",</span></span>
<span id="cb47-750"><a href="#cb47-750" aria-hidden="true" tabindex="-1"></a><span class="in">      textPadding: 3</span></span>
<span id="cb47-751"><a href="#cb47-751" aria-hidden="true" tabindex="-1"></a><span class="in">    }))</span></span>
<span id="cb47-752"><a href="#cb47-752" aria-hidden="true" tabindex="-1"></a><span class="in">  ],</span></span>
<span id="cb47-753"><a href="#cb47-753" aria-hidden="true" tabindex="-1"></a><span class="in">  color: {</span></span>
<span id="cb47-754"><a href="#cb47-754" aria-hidden="true" tabindex="-1"></a><span class="in">    range: carto_prism</span></span>
<span id="cb47-755"><a href="#cb47-755" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb47-756"><a href="#cb47-756" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-757"><a href="#cb47-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-758"><a href="#cb47-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-759"><a href="#cb47-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-760"><a href="#cb47-760" aria-hidden="true" tabindex="-1"></a><span class="fu"># Working with USAID data</span></span>
<span id="cb47-761"><a href="#cb47-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-762"><a href="#cb47-762" aria-hidden="true" tabindex="-1"></a><span class="fu">## Get USAID data</span></span>
<span id="cb47-763"><a href="#cb47-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-764"><a href="#cb47-764" aria-hidden="true" tabindex="-1"></a>To make it easier to access and filter and manipulate things, I put the rescued data on a <span class="co">[</span><span class="ot">Datasette</span><span class="co">](https://datasette.io/)</span> instance, which is nice front-end for an SQLite database. This makes it possible to run SQL queries directly in the browser and generate custom datasets without needing to load the full massive CSV files into R or Python or Stata or whatever.</span>
<span id="cb47-765"><a href="#cb47-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-766"><a href="#cb47-766" aria-hidden="true" tabindex="-1"></a>For example, one of the rescued USAID datasets is named <span class="co">[</span><span class="ot">`us_foreign_aid_country`</span><span class="co">](https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance/~2E~2Fus_foreign_aid_country)</span> and it contains 22,000+ rows, with data on aid obligations, appropriations, and disbursements starting in 1999.</span>
<span id="cb47-767"><a href="#cb47-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-768"><a href="#cb47-768" aria-hidden="true" tabindex="-1"></a>If we want to get a total of all constant USD aid obligations by country in 2023, omitting regional and world totals, we could do something like this with R and {dplyr}:</span>
<span id="cb47-769"><a href="#cb47-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-772"><a href="#cb47-772" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb47-773"><a href="#cb47-773" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb47-774"><a href="#cb47-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-775"><a href="#cb47-775" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb47-776"><a href="#cb47-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-777"><a href="#cb47-777" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the raw CSV and put it somewhere</span></span>
<span id="cb47-778"><a href="#cb47-778" aria-hidden="true" tabindex="-1"></a>us_foreign_aid_country <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"us_foreign_aid_country.csv"</span>)</span>
<span id="cb47-779"><a href="#cb47-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-780"><a href="#cb47-780" aria-hidden="true" tabindex="-1"></a>us_foreign_aid_country <span class="sc">|&gt;</span></span>
<span id="cb47-781"><a href="#cb47-781" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb47-782"><a href="#cb47-782" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fiscal Year</span><span class="st">`</span> <span class="sc">==</span> <span class="dv">2023</span>, </span>
<span id="cb47-783"><a href="#cb47-783" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Transaction Type Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Obligations"</span>,</span>
<span id="cb47-784"><a href="#cb47-784" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">str_detect</span>(<span class="st">`</span><span class="at">Country Name</span><span class="st">`</span>, <span class="st">"Region"</span>),</span>
<span id="cb47-785"><a href="#cb47-785" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Country Name</span><span class="st">`</span> <span class="sc">!=</span> <span class="st">"World"</span></span>
<span id="cb47-786"><a href="#cb47-786" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb47-787"><a href="#cb47-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="st">`</span><span class="at">Country Code</span><span class="st">`</span>, <span class="st">`</span><span class="at">Country Name</span><span class="st">`</span>, <span class="st">`</span><span class="at">Region Name</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb47-788"><a href="#cb47-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">total_constant_amount =</span> <span class="fu">sum</span>(constant_amount)) <span class="sc">|&gt;</span></span>
<span id="cb47-789"><a href="#cb47-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_constant_amount))</span>
<span id="cb47-790"><a href="#cb47-790" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  A tibble: 176 × 4</span></span>
<span id="cb47-791"><a href="#cb47-791" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  Groups:   Country Code, Country Name [176]</span></span>
<span id="cb47-792"><a href="#cb47-792" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   `Country Code` `Country Name`   `Region Name`                total_constant_amount</span></span>
<span id="cb47-793"><a href="#cb47-793" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt;            &lt;chr&gt;                                        &lt;dbl&gt;</span></span>
<span id="cb47-794"><a href="#cb47-794" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 UKR            Ukraine          Europe and Eurasia                     17193710403</span></span>
<span id="cb47-795"><a href="#cb47-795" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 ISR            Israel           Middle East and North Africa            3302860882</span></span>
<span id="cb47-796"><a href="#cb47-796" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 JOR            Jordan           Middle East and North Africa            1686862605</span></span>
<span id="cb47-797"><a href="#cb47-797" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 EGY            Egypt            Middle East and North Africa            1503609426</span></span>
<span id="cb47-798"><a href="#cb47-798" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5 ETH            Ethiopia         Sub-Saharan Africa                      1457374911</span></span>
<span id="cb47-799"><a href="#cb47-799" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6 SOM            Somalia          Sub-Saharan Africa                      1181033990</span></span>
<span id="cb47-800"><a href="#cb47-800" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7 NGA            Nigeria          Sub-Saharan Africa                      1019947490</span></span>
<span id="cb47-801"><a href="#cb47-801" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8 COD            Congo (Kinshasa) Sub-Saharan Africa                       990456757</span></span>
<span id="cb47-802"><a href="#cb47-802" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9 AFG            Afghanistan      South and Central Asia                   886536741</span></span>
<span id="cb47-803"><a href="#cb47-803" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 0 KEN            Kenya            Sub-Saharan Africa                       846303488</span></span>
<span id="cb47-804"><a href="#cb47-804" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  ℹ 166 more rows</span></span>
<span id="cb47-805"><a href="#cb47-805" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  ℹ Use `print(n = ...)` to see more rows</span></span>
<span id="cb47-806"><a href="#cb47-806" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-807"><a href="#cb47-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-808"><a href="#cb47-808" aria-hidden="true" tabindex="-1"></a>Or we could get that data extract directly from the database without needing to load the huge original CSV file. We can run <span class="co">[</span><span class="ot">an SQL query like this</span><span class="co">](https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance?sql=SELECT+%22Country+Code%22%2C+%22Country+Name%22%2C+%22Region+Name%22%2C+SUM%28%22constant_amount%22%29+AS+total_constant_amount%0D%0A++FROM+%22.%2Fus_foreign_aid_country%22%0D%0A++WHERE+%22Fiscal+Year%22+%3D+%272023%27+%0D%0A++++AND+%22Transaction+Type+Name%22+%3D+%27Obligations%27+%0D%0A++++AND+%22Country+Name%22+NOT+LIKE+%27%25Region%25%27+%0D%0A++++AND+%22Country+Name%22+%21%3D+%22World%22%0D%0A++GROUP+BY+%22Country+Code%22%2C+%22Country+Name%22%2C+%22Region+Name%22%0D%0A++ORDER+BY+total_constant_amount+DESC%3B)</span> at the Datasette website: </span>
<span id="cb47-809"><a href="#cb47-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-810"><a href="#cb47-810" aria-hidden="true" tabindex="-1"></a><span class="in">```{.sql}</span></span>
<span id="cb47-811"><a href="#cb47-811" aria-hidden="true" tabindex="-1"></a><span class="in">SELECT "Country Code", "Country Name", "Region Name", SUM("constant_amount") AS total_constant_amount</span></span>
<span id="cb47-812"><a href="#cb47-812" aria-hidden="true" tabindex="-1"></a><span class="in">  FROM "./us_foreign_aid_country"</span></span>
<span id="cb47-813"><a href="#cb47-813" aria-hidden="true" tabindex="-1"></a><span class="in">  WHERE </span></span>
<span id="cb47-814"><a href="#cb47-814" aria-hidden="true" tabindex="-1"></a><span class="in">    "Fiscal Year" = '2023' </span></span>
<span id="cb47-815"><a href="#cb47-815" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Transaction Type Name" = 'Obligations' </span></span>
<span id="cb47-816"><a href="#cb47-816" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Country Name" NOT LIKE '%Region%' </span></span>
<span id="cb47-817"><a href="#cb47-817" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Country Name" != "World"</span></span>
<span id="cb47-818"><a href="#cb47-818" aria-hidden="true" tabindex="-1"></a><span class="in">  GROUP BY "Country Code", "Country Name", "Region Name"</span></span>
<span id="cb47-819"><a href="#cb47-819" aria-hidden="true" tabindex="-1"></a><span class="in">  ORDER BY total_constant_amount DESC;</span></span>
<span id="cb47-820"><a href="#cb47-820" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-821"><a href="#cb47-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-822"><a href="#cb47-822" aria-hidden="true" tabindex="-1"></a><span class="al">![SQL query and results](img/datasette-query.png)</span>{.border width="80%"}</span>
<span id="cb47-823"><a href="#cb47-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-824"><a href="#cb47-824" aria-hidden="true" tabindex="-1"></a>Since we're working with interactive Observable Javascript, we can load that data directly into the browser instead of downloading intermediate CSV files. There's a neat <span class="co">[</span><span class="ot">Datasette database client</span><span class="co">](https://observablehq.com/@ambassadors/datasette-client)</span> for Observable that lets us run SQL queries (there are <span class="co">[</span><span class="ot">lots of other clients too</span><span class="co">](https://observablehq.com/documentation/data/databases/database-clients)</span>, if you want to connect to things like DuckDB, SQLite, MySQL, Snowflake, and so on).</span>
<span id="cb47-825"><a href="#cb47-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-828"><a href="#cb47-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-829"><a href="#cb47-829" aria-hidden="true" tabindex="-1"></a><span class="in">//| eval: false</span></span>
<span id="cb47-830"><a href="#cb47-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-831"><a href="#cb47-831" aria-hidden="true" tabindex="-1"></a><span class="in">// https://observablehq.com/@ambassadors/datasette-client</span></span>
<span id="cb47-832"><a href="#cb47-832" aria-hidden="true" tabindex="-1"></a><span class="in">import { DatasetteClient } from "@ambassadors/datasette-client"</span></span>
<span id="cb47-833"><a href="#cb47-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-834"><a href="#cb47-834" aria-hidden="true" tabindex="-1"></a><span class="in">aid_db = new DatasetteClient(</span></span>
<span id="cb47-835"><a href="#cb47-835" aria-hidden="true" tabindex="-1"></a><span class="in">  "https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance"</span></span>
<span id="cb47-836"><a href="#cb47-836" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb47-837"><a href="#cb47-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-838"><a href="#cb47-838" aria-hidden="true" tabindex="-1"></a><span class="in">recipient_countries = await aid_db.sql`</span></span>
<span id="cb47-839"><a href="#cb47-839" aria-hidden="true" tabindex="-1"></a><span class="in">  SELECT "Country Code", "Country Name", "Region Name", SUM("constant_amount") AS total_constant_amount</span></span>
<span id="cb47-840"><a href="#cb47-840" aria-hidden="true" tabindex="-1"></a><span class="in">  FROM "./us_foreign_aid_country"</span></span>
<span id="cb47-841"><a href="#cb47-841" aria-hidden="true" tabindex="-1"></a><span class="in">  WHERE </span></span>
<span id="cb47-842"><a href="#cb47-842" aria-hidden="true" tabindex="-1"></a><span class="in">    "Fiscal Year" = '2023' </span></span>
<span id="cb47-843"><a href="#cb47-843" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Transaction Type Name" = 'Obligations' </span></span>
<span id="cb47-844"><a href="#cb47-844" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Country Name" NOT LIKE '%Region%' </span></span>
<span id="cb47-845"><a href="#cb47-845" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Country Name" != "World"</span></span>
<span id="cb47-846"><a href="#cb47-846" aria-hidden="true" tabindex="-1"></a><span class="in">  GROUP BY "Country Code", "Country Name", "Region Name"</span></span>
<span id="cb47-847"><a href="#cb47-847" aria-hidden="true" tabindex="-1"></a><span class="in">  ORDER BY total_constant_amount DESC;</span></span>
<span id="cb47-848"><a href="#cb47-848" aria-hidden="true" tabindex="-1"></a><span class="in">`</span></span>
<span id="cb47-849"><a href="#cb47-849" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-850"><a href="#cb47-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-851"><a href="#cb47-851" aria-hidden="true" tabindex="-1"></a>Through the magic of this Datasette client, we now have a pre-summarized dataset to work with!</span>
<span id="cb47-852"><a href="#cb47-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-855"><a href="#cb47-855" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-856"><a href="#cb47-856" aria-hidden="true" tabindex="-1"></a><span class="in">//| echo: false</span></span>
<span id="cb47-857"><a href="#cb47-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-858"><a href="#cb47-858" aria-hidden="true" tabindex="-1"></a><span class="in">// I don't want to keep hitting the Datasette server with requests, so I'm </span></span>
<span id="cb47-859"><a href="#cb47-859" aria-hidden="true" tabindex="-1"></a><span class="in">// cheating and loading a CSV extract instead. It comes from this query: </span></span>
<span id="cb47-860"><a href="#cb47-860" aria-hidden="true" tabindex="-1"></a><span class="in">// https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance.csv?sql=SELECT+%22Country+Code%22%2C+%22Country+Name%22%2C+%22Region+Name%22%2C+SUM%28%22constant_amount%22%29+AS+total_constant_amount%0D%0A++FROM+%22.%2Fus_foreign_aid_country%22%0D%0A++WHERE+%22Fiscal+Year%22+%3D+%272023%27+%0D%0A++++AND+%22Transaction+Type+Name%22+%3D+%27Obligations%27+%0D%0A++++AND+%22Country+Name%22+NOT+LIKE+%27%25Region%25%27+%0D%0A++++AND+%22Country+Name%22+%21%3D+%22World%22%0D%0A++GROUP+BY+%22Country+Code%22%2C+%22Country+Name%22%2C+%22Region+Name%22%0D%0A++ORDER+BY+total_constant_amount+DESC%3B&amp;_size=max</span></span>
<span id="cb47-861"><a href="#cb47-861" aria-hidden="true" tabindex="-1"></a><span class="in">recipient_countries = await FileAttachment("recipient_countries.csv").csv({ typed: true })</span></span>
<span id="cb47-862"><a href="#cb47-862" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-863"><a href="#cb47-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-866"><a href="#cb47-866" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-867"><a href="#cb47-867" aria-hidden="true" tabindex="-1"></a><span class="in">recipient_countries</span></span>
<span id="cb47-868"><a href="#cb47-868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-869"><a href="#cb47-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-870"><a href="#cb47-870" aria-hidden="true" tabindex="-1"></a><span class="fu"># Connect USAID data to the map data</span></span>
<span id="cb47-871"><a href="#cb47-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-872"><a href="#cb47-872" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Following Observable Plot's choropleth tutorial</span><span class="co">](https://observablehq.com/@observablehq/build-your-first-choropleth-map-with-observable-plot#cell-434)</span>, to show these totals on a map, we need to create a <span class="in">`Map`</span> object,^<span class="co">[</span><span class="ot">This term is admittedly confusing because it has nothing to do with geographic maps and is [instead related to functional programming](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map).</span><span class="co">]</span> which is like a Python dictionary or an R data frame with two columns, where we have (1) a name that shares a name with something in the geographic data, like an ISO3 country code, and (2) a value with the thing we want to plot.</span>
<span id="cb47-873"><a href="#cb47-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-876"><a href="#cb47-876" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-877"><a href="#cb47-877" aria-hidden="true" tabindex="-1"></a><span class="in">country_totals = new Map(recipient_countries.map(d =&gt; [d["Country Code"], d.total_constant_amount]))</span></span>
<span id="cb47-878"><a href="#cb47-878" aria-hidden="true" tabindex="-1"></a><span class="in">country_totals</span></span>
<span id="cb47-879"><a href="#cb47-879" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-880"><a href="#cb47-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-881"><a href="#cb47-881" aria-hidden="true" tabindex="-1"></a>This lets us get specific totals with the <span class="in">`.get()`</span> method. Here's Ukraine, for example:</span>
<span id="cb47-882"><a href="#cb47-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-885"><a href="#cb47-885" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-886"><a href="#cb47-886" aria-hidden="true" tabindex="-1"></a><span class="in">country_totals.get("UKR")</span></span>
<span id="cb47-887"><a href="#cb47-887" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-888"><a href="#cb47-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-889"><a href="#cb47-889" aria-hidden="true" tabindex="-1"></a>We can feed the ISO3 code of each country-level geographic shape into this <span class="in">`country_totals`</span> object to extract the total amount of aid for each country. We'll use the Antarctica-free Robinson projection we made earlier, and we'll remove the ocean fill since we'll ultimately make this interactive and hoverable:</span>
<span id="cb47-890"><a href="#cb47-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-893"><a href="#cb47-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-894"><a href="#cb47-894" aria-hidden="true" tabindex="-1"></a><span class="in">//| column: body-outset</span></span>
<span id="cb47-895"><a href="#cb47-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-896"><a href="#cb47-896" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-897"><a href="#cb47-897" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-898"><a href="#cb47-898" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-899"><a href="#cb47-899" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-900"><a href="#cb47-900" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-901"><a href="#cb47-901" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1} ),</span></span>
<span id="cb47-902"><a href="#cb47-902" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, Plot.centroid({</span></span>
<span id="cb47-903"><a href="#cb47-903" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; country_totals.get(d.properties.iso_a3)</span></span>
<span id="cb47-904"><a href="#cb47-904" aria-hidden="true" tabindex="-1"></a><span class="in">    }))</span></span>
<span id="cb47-905"><a href="#cb47-905" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-906"><a href="#cb47-906" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-907"><a href="#cb47-907" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-908"><a href="#cb47-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-909"><a href="#cb47-909" aria-hidden="true" tabindex="-1"></a><span class="fu">## Improving the map</span></span>
<span id="cb47-910"><a href="#cb47-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-911"><a href="#cb47-911" aria-hidden="true" tabindex="-1"></a>We have a choropleth! But this is hardly publication worthy. We need to fix a bunch of issues with it.</span>
<span id="cb47-912"><a href="#cb47-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-913"><a href="#cb47-913" aria-hidden="true" tabindex="-1"></a>First, countries that don't receive aid don't appear in the map. Let's add borders to all the countries:</span>
<span id="cb47-914"><a href="#cb47-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-917"><a href="#cb47-917" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-918"><a href="#cb47-918" aria-hidden="true" tabindex="-1"></a><span class="in">//| column: body-outset</span></span>
<span id="cb47-919"><a href="#cb47-919" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-920"><a href="#cb47-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-921"><a href="#cb47-921" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-922"><a href="#cb47-922" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-923"><a href="#cb47-923" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-924"><a href="#cb47-924" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-925"><a href="#cb47-925" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-926"><a href="#cb47-926" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1} ),</span></span>
<span id="cb47-927"><a href="#cb47-927" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, Plot.centroid({</span></span>
<span id="cb47-928"><a href="#cb47-928" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; country_totals.get(d.properties.iso_a3)</span></span>
<span id="cb47-929"><a href="#cb47-929" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-930"><a href="#cb47-930" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {  //&lt;&lt;</span></span>
<span id="cb47-931"><a href="#cb47-931" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",  //&lt;&lt;</span></span>
<span id="cb47-932"><a href="#cb47-932" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5  //&lt;&lt;</span></span>
<span id="cb47-933"><a href="#cb47-933" aria-hidden="true" tabindex="-1"></a><span class="in">    })  //&lt;&lt;</span></span>
<span id="cb47-934"><a href="#cb47-934" aria-hidden="true" tabindex="-1"></a><span class="in">  ]</span></span>
<span id="cb47-935"><a href="#cb47-935" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-936"><a href="#cb47-936" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-937"><a href="#cb47-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-938"><a href="#cb47-938" aria-hidden="true" tabindex="-1"></a>The coloring here is gross because of some huge outliers (Ukraine) that make most countries black/dark blue. There's also no legend to show what these values are. We can address all of this by <span class="co">[</span><span class="ot">adjusting the legend options</span><span class="co">](https://observablehq.com/plot/features/legends#legend-options)</span>. We'll log total aid, include the legend, add a nice label, and use a <span class="co">[</span><span class="ot">single-hue coloring scheme</span><span class="co">](https://observablehq.com/plot/features/scales#color-scales)</span> with gray for countries without aid:</span>
<span id="cb47-939"><a href="#cb47-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-942"><a href="#cb47-942" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-943"><a href="#cb47-943" aria-hidden="true" tabindex="-1"></a><span class="in">//| column: body-outset</span></span>
<span id="cb47-944"><a href="#cb47-944" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-945"><a href="#cb47-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-946"><a href="#cb47-946" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-947"><a href="#cb47-947" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-948"><a href="#cb47-948" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-949"><a href="#cb47-949" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-950"><a href="#cb47-950" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-951"><a href="#cb47-951" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1} ),</span></span>
<span id="cb47-952"><a href="#cb47-952" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, Plot.centroid({</span></span>
<span id="cb47-953"><a href="#cb47-953" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; country_totals.get(d.properties.iso_a3)</span></span>
<span id="cb47-954"><a href="#cb47-954" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-955"><a href="#cb47-955" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-956"><a href="#cb47-956" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-957"><a href="#cb47-957" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5</span></span>
<span id="cb47-958"><a href="#cb47-958" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-959"><a href="#cb47-959" aria-hidden="true" tabindex="-1"></a><span class="in">  ],</span></span>
<span id="cb47-960"><a href="#cb47-960" aria-hidden="true" tabindex="-1"></a><span class="in">  color: {  //&lt;&lt;</span></span>
<span id="cb47-961"><a href="#cb47-961" aria-hidden="true" tabindex="-1"></a><span class="in">    scheme: "blues",  //&lt;&lt;</span></span>
<span id="cb47-962"><a href="#cb47-962" aria-hidden="true" tabindex="-1"></a><span class="in">    unknown: "#f2f2f2",  //&lt;&lt;</span></span>
<span id="cb47-963"><a href="#cb47-963" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "log",   //&lt;&lt;</span></span>
<span id="cb47-964"><a href="#cb47-964" aria-hidden="true" tabindex="-1"></a><span class="in">    legend: true,  //&lt;&lt;</span></span>
<span id="cb47-965"><a href="#cb47-965" aria-hidden="true" tabindex="-1"></a><span class="in">    label: "Total obligations",  //&lt;&lt;</span></span>
<span id="cb47-966"><a href="#cb47-966" aria-hidden="true" tabindex="-1"></a><span class="in">  }  //&lt;&lt;</span></span>
<span id="cb47-967"><a href="#cb47-967" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-968"><a href="#cb47-968" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-969"><a href="#cb47-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-970"><a href="#cb47-970" aria-hidden="true" tabindex="-1"></a>Next, let's make this interactive by turning on <span class="co">[</span><span class="ot">hovering tooltips</span><span class="co">](https://observablehq.com/plot/marks/tip)</span>:</span>
<span id="cb47-971"><a href="#cb47-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-974"><a href="#cb47-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-975"><a href="#cb47-975" aria-hidden="true" tabindex="-1"></a><span class="in">//| column: body-outset</span></span>
<span id="cb47-976"><a href="#cb47-976" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-977"><a href="#cb47-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-978"><a href="#cb47-978" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-979"><a href="#cb47-979" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-980"><a href="#cb47-980" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-981"><a href="#cb47-981" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-982"><a href="#cb47-982" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-983"><a href="#cb47-983" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1} ),</span></span>
<span id="cb47-984"><a href="#cb47-984" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, Plot.centroid({</span></span>
<span id="cb47-985"><a href="#cb47-985" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; country_totals.get(d.properties.iso_a3),</span></span>
<span id="cb47-986"><a href="#cb47-986" aria-hidden="true" tabindex="-1"></a><span class="in">      tip: true //&lt;&lt;</span></span>
<span id="cb47-987"><a href="#cb47-987" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-988"><a href="#cb47-988" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-989"><a href="#cb47-989" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-990"><a href="#cb47-990" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5</span></span>
<span id="cb47-991"><a href="#cb47-991" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-992"><a href="#cb47-992" aria-hidden="true" tabindex="-1"></a><span class="in">  ],</span></span>
<span id="cb47-993"><a href="#cb47-993" aria-hidden="true" tabindex="-1"></a><span class="in">  color: {</span></span>
<span id="cb47-994"><a href="#cb47-994" aria-hidden="true" tabindex="-1"></a><span class="in">    scheme: "blues",</span></span>
<span id="cb47-995"><a href="#cb47-995" aria-hidden="true" tabindex="-1"></a><span class="in">    unknown: "#f2f2f2",</span></span>
<span id="cb47-996"><a href="#cb47-996" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "log", </span></span>
<span id="cb47-997"><a href="#cb47-997" aria-hidden="true" tabindex="-1"></a><span class="in">    legend: true,</span></span>
<span id="cb47-998"><a href="#cb47-998" aria-hidden="true" tabindex="-1"></a><span class="in">    label: "Total obligations",</span></span>
<span id="cb47-999"><a href="#cb47-999" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb47-1000"><a href="#cb47-1000" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-1001"><a href="#cb47-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-1002"><a href="#cb47-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1003"><a href="#cb47-1003" aria-hidden="true" tabindex="-1"></a>That's so cool. Hover over Mexico and you'll see "**Total obligations** 232,214,023".</span>
<span id="cb47-1004"><a href="#cb47-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1005"><a href="#cb47-1005" aria-hidden="true" tabindex="-1"></a>We can make this tooltip more informative by including the country name and formatting the amount to show dollars. Instead of using <span class="in">`tip: true`</span>, we can add the country name as a channel (Observable Plot's version of a ggplot aesthetic), and format the tip so that the country name comes first and the total amount is <span class="co">[</span><span class="ot">formatted</span><span class="co">](https://observablehq.com/plot/features/formats)</span> with <span class="co">[</span><span class="ot">`d3.format()`</span><span class="co">](https://d3js.org/d3-format)</span>:</span>
<span id="cb47-1006"><a href="#cb47-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1009"><a href="#cb47-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-1010"><a href="#cb47-1010" aria-hidden="true" tabindex="-1"></a><span class="in">//| column: body-outset</span></span>
<span id="cb47-1011"><a href="#cb47-1011" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-1012"><a href="#cb47-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1013"><a href="#cb47-1013" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-1014"><a href="#cb47-1014" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-1015"><a href="#cb47-1015" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-1016"><a href="#cb47-1016" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-1017"><a href="#cb47-1017" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-1018"><a href="#cb47-1018" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1} ),</span></span>
<span id="cb47-1019"><a href="#cb47-1019" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, Plot.centroid({</span></span>
<span id="cb47-1020"><a href="#cb47-1020" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; country_totals.get(d.properties.iso_a3),</span></span>
<span id="cb47-1021"><a href="#cb47-1021" aria-hidden="true" tabindex="-1"></a><span class="in">      channels: { //&lt;&lt;</span></span>
<span id="cb47-1022"><a href="#cb47-1022" aria-hidden="true" tabindex="-1"></a><span class="in">        Country: d =&gt; d.properties.name, //&lt;&lt;</span></span>
<span id="cb47-1023"><a href="#cb47-1023" aria-hidden="true" tabindex="-1"></a><span class="in">      }, //&lt;&lt;</span></span>
<span id="cb47-1024"><a href="#cb47-1024" aria-hidden="true" tabindex="-1"></a><span class="in">      tip: { //&lt;&lt;</span></span>
<span id="cb47-1025"><a href="#cb47-1025" aria-hidden="true" tabindex="-1"></a><span class="in">        format: { //&lt;&lt;</span></span>
<span id="cb47-1026"><a href="#cb47-1026" aria-hidden="true" tabindex="-1"></a><span class="in">          Country: true, //&lt;&lt;</span></span>
<span id="cb47-1027"><a href="#cb47-1027" aria-hidden="true" tabindex="-1"></a><span class="in">          fill: d3.format("$,d") //&lt;&lt;</span></span>
<span id="cb47-1028"><a href="#cb47-1028" aria-hidden="true" tabindex="-1"></a><span class="in">        } //&lt;&lt;</span></span>
<span id="cb47-1029"><a href="#cb47-1029" aria-hidden="true" tabindex="-1"></a><span class="in">      } //&lt;&lt;</span></span>
<span id="cb47-1030"><a href="#cb47-1030" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-1031"><a href="#cb47-1031" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-1032"><a href="#cb47-1032" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-1033"><a href="#cb47-1033" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5</span></span>
<span id="cb47-1034"><a href="#cb47-1034" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-1035"><a href="#cb47-1035" aria-hidden="true" tabindex="-1"></a><span class="in">  ],</span></span>
<span id="cb47-1036"><a href="#cb47-1036" aria-hidden="true" tabindex="-1"></a><span class="in">  color: {</span></span>
<span id="cb47-1037"><a href="#cb47-1037" aria-hidden="true" tabindex="-1"></a><span class="in">    scheme: "blues",</span></span>
<span id="cb47-1038"><a href="#cb47-1038" aria-hidden="true" tabindex="-1"></a><span class="in">    unknown: "#f2f2f2",</span></span>
<span id="cb47-1039"><a href="#cb47-1039" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "log", </span></span>
<span id="cb47-1040"><a href="#cb47-1040" aria-hidden="true" tabindex="-1"></a><span class="in">    legend: true,</span></span>
<span id="cb47-1041"><a href="#cb47-1041" aria-hidden="true" tabindex="-1"></a><span class="in">    label: "Total obligations",</span></span>
<span id="cb47-1042"><a href="#cb47-1042" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb47-1043"><a href="#cb47-1043" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-1044"><a href="#cb47-1044" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-1045"><a href="#cb47-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1046"><a href="#cb47-1046" aria-hidden="true" tabindex="-1"></a>Now hover over Mexico and you'll see the country name and the amount of aid in dollars.</span>
<span id="cb47-1047"><a href="#cb47-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1048"><a href="#cb47-1048" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fixing labelling issues</span></span>
<span id="cb47-1049"><a href="#cb47-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1050"><a href="#cb47-1050" aria-hidden="true" tabindex="-1"></a>We have two final super minor issues to address. </span>
<span id="cb47-1051"><a href="#cb47-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1052"><a href="#cb47-1052" aria-hidden="true" tabindex="-1"></a>First hover over a country that didn't receive aid, like the United States or Australia. The total reported aid displays as "$NaN". That's gross. It'd be nicer if it said something else, like "$0" or "No aid" or something more informative.</span>
<span id="cb47-1053"><a href="#cb47-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1054"><a href="#cb47-1054" aria-hidden="true" tabindex="-1"></a>To fix this, we can make a little function that formats the given value as a dollar amount if it's an actual value, and formats it as something else if it's missing or not a number (like <span class="in">`log(0)`</span>):</span>
<span id="cb47-1055"><a href="#cb47-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1058"><a href="#cb47-1058" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-1059"><a href="#cb47-1059" aria-hidden="true" tabindex="-1"></a><span class="in">function format_aid_total(value) {</span></span>
<span id="cb47-1060"><a href="#cb47-1060" aria-hidden="true" tabindex="-1"></a><span class="in">  return value ? d3.format("$,d")(value) : "No aid";</span></span>
<span id="cb47-1061"><a href="#cb47-1061" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb47-1062"><a href="#cb47-1062" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-1063"><a href="#cb47-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1064"><a href="#cb47-1064" aria-hidden="true" tabindex="-1"></a>That works nicely:</span>
<span id="cb47-1065"><a href="#cb47-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1068"><a href="#cb47-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-1069"><a href="#cb47-1069" aria-hidden="true" tabindex="-1"></a><span class="in">format_aid_total(394023)</span></span>
<span id="cb47-1070"><a href="#cb47-1070" aria-hidden="true" tabindex="-1"></a><span class="in">format_aid_total(NaN)</span></span>
<span id="cb47-1071"><a href="#cb47-1071" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-1072"><a href="#cb47-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1073"><a href="#cb47-1073" aria-hidden="true" tabindex="-1"></a>The other problem is in the legend, which uses a logarithmic scale and includes breaks for 10k, 1M, 100M, and 10G, representing \$10,000, \$1 million, \$100 million, and \$10 billion in aid.</span>
<span id="cb47-1074"><a href="#cb47-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1075"><a href="#cb47-1075" aria-hidden="true" tabindex="-1"></a>The issue is the \$10 billion, which is abbreviated with "G".</span>
<span id="cb47-1076"><a href="#cb47-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1077"><a href="#cb47-1077" aria-hidden="true" tabindex="-1"></a>This is happening because <span class="in">`d3.format()`</span> uses SI (<span class="co">[</span><span class="ot">Système international d'unités, or International System of Units</span><span class="co">](https://en.wikipedia.org/wiki/International_System_of_Units)</span>) values for its numeric formats, which means that it uses <span class="co">[</span><span class="ot">SI metric prefixes</span><span class="co">](https://en.wikipedia.org/wiki/Metric_prefix)</span>. Those legend breaks, therefore, actually technically mean this: </span>
<span id="cb47-1078"><a href="#cb47-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1079"><a href="#cb47-1079" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>10k: 10 kilodollars</span>
<span id="cb47-1080"><a href="#cb47-1080" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>1M: 1 megadollar</span>
<span id="cb47-1081"><a href="#cb47-1081" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>100M: 100 megadollars</span>
<span id="cb47-1082"><a href="#cb47-1082" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>10G: 10 gigadollars</span>
<span id="cb47-1083"><a href="#cb47-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1084"><a href="#cb47-1084" aria-hidden="true" tabindex="-1"></a>lol, I should start talking about big dollar amounts with these values ("the 2022 US federal budget deficit was <span class="co">[</span><span class="ot">1.4 teradollars</span><span class="co">](https://www.cbo.gov/publication/58888)</span>")</span>
<span id="cb47-1085"><a href="#cb47-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1086"><a href="#cb47-1086" aria-hidden="true" tabindex="-1"></a>The first letters of many of these SI prefixes happen to line up with US-style large numbers:</span>
<span id="cb47-1087"><a href="#cb47-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1088"><a href="#cb47-1088" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In the US we already commonly use "k" for thousand</span>
<span id="cb47-1089"><a href="#cb47-1089" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The initial "m" in "mega" aligns with "million"</span>
<span id="cb47-1090"><a href="#cb47-1090" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The initial "t" in tera aligns with "trillion"</span>
<span id="cb47-1091"><a href="#cb47-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1092"><a href="#cb47-1092" aria-hidden="true" tabindex="-1"></a>But "giga" doesn't align with "billion", hence the strange "G" here for dollar amounts.</span>
<span id="cb47-1093"><a href="#cb47-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1094"><a href="#cb47-1094" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">People have requested</span><span class="co">](https://github.com/d3/d3-format/issues/71)</span> that <span class="in">`d3-format`</span> include an option for switching the abbreviation from G to B, but the developers haven't added it (<span class="co">[</span><span class="ot">and probably won't</span><span class="co">](https://github.com/d3/d3-format/issues/71#issuecomment-515074256)</span>). Instead, <span class="co">[</span><span class="ot">a common recommended fix</span><span class="co">](https://talk.observablehq.com/t/how-do-i-make-the-billions-unit-show-as-b-instead-of-g-in-observable-plot/7560/2)</span> is to replace all "G"s with "B"s:</span>
<span id="cb47-1095"><a href="#cb47-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1098"><a href="#cb47-1098" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-1099"><a href="#cb47-1099" aria-hidden="true" tabindex="-1"></a><span class="in">number_in_billions = 13840918291  // A big number I randomly typed</span></span>
<span id="cb47-1100"><a href="#cb47-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1101"><a href="#cb47-1101" aria-hidden="true" tabindex="-1"></a><span class="in">// Billions of dollars instead of SI-style gigadollars</span></span>
<span id="cb47-1102"><a href="#cb47-1102" aria-hidden="true" tabindex="-1"></a><span class="in">d3.format("$.4s")(number_in_billions).replace("G", "B")</span></span>
<span id="cb47-1103"><a href="#cb47-1103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-1104"><a href="#cb47-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1105"><a href="#cb47-1105" aria-hidden="true" tabindex="-1"></a>We can add <span class="in">`format_aid_total()`</span> and the <span class="in">`.replace("G", "B")`</span> tweak and fix the labels in our interactive map:</span>
<span id="cb47-1106"><a href="#cb47-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1109"><a href="#cb47-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-1110"><a href="#cb47-1110" aria-hidden="true" tabindex="-1"></a><span class="in">//| column: body-outset</span></span>
<span id="cb47-1111"><a href="#cb47-1111" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-1112"><a href="#cb47-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1113"><a href="#cb47-1113" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-1114"><a href="#cb47-1114" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-1115"><a href="#cb47-1115" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-1116"><a href="#cb47-1116" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-1117"><a href="#cb47-1117" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-1118"><a href="#cb47-1118" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1} ),</span></span>
<span id="cb47-1119"><a href="#cb47-1119" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, Plot.centroid({</span></span>
<span id="cb47-1120"><a href="#cb47-1120" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; country_totals.get(d.properties.iso_a3),</span></span>
<span id="cb47-1121"><a href="#cb47-1121" aria-hidden="true" tabindex="-1"></a><span class="in">      channels: {</span></span>
<span id="cb47-1122"><a href="#cb47-1122" aria-hidden="true" tabindex="-1"></a><span class="in">        Country: d =&gt; d.properties.name,</span></span>
<span id="cb47-1123"><a href="#cb47-1123" aria-hidden="true" tabindex="-1"></a><span class="in">      },</span></span>
<span id="cb47-1124"><a href="#cb47-1124" aria-hidden="true" tabindex="-1"></a><span class="in">      tip: {</span></span>
<span id="cb47-1125"><a href="#cb47-1125" aria-hidden="true" tabindex="-1"></a><span class="in">        format: {</span></span>
<span id="cb47-1126"><a href="#cb47-1126" aria-hidden="true" tabindex="-1"></a><span class="in">          Country: true,</span></span>
<span id="cb47-1127"><a href="#cb47-1127" aria-hidden="true" tabindex="-1"></a><span class="in">          fill: d =&gt; format_aid_total(d) //&lt;&lt;</span></span>
<span id="cb47-1128"><a href="#cb47-1128" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb47-1129"><a href="#cb47-1129" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb47-1130"><a href="#cb47-1130" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-1131"><a href="#cb47-1131" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-1132"><a href="#cb47-1132" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-1133"><a href="#cb47-1133" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.5</span></span>
<span id="cb47-1134"><a href="#cb47-1134" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-1135"><a href="#cb47-1135" aria-hidden="true" tabindex="-1"></a><span class="in">  ],</span></span>
<span id="cb47-1136"><a href="#cb47-1136" aria-hidden="true" tabindex="-1"></a><span class="in">  color: {</span></span>
<span id="cb47-1137"><a href="#cb47-1137" aria-hidden="true" tabindex="-1"></a><span class="in">    scheme: "blues",</span></span>
<span id="cb47-1138"><a href="#cb47-1138" aria-hidden="true" tabindex="-1"></a><span class="in">    unknown: "#f2f2f2",</span></span>
<span id="cb47-1139"><a href="#cb47-1139" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "log", </span></span>
<span id="cb47-1140"><a href="#cb47-1140" aria-hidden="true" tabindex="-1"></a><span class="in">    legend: true,</span></span>
<span id="cb47-1141"><a href="#cb47-1141" aria-hidden="true" tabindex="-1"></a><span class="in">    label: "Total obligations",</span></span>
<span id="cb47-1142"><a href="#cb47-1142" aria-hidden="true" tabindex="-1"></a><span class="in">    tickFormat: d =&gt; d3.format("$0.2s")(d).replace("G", "B") //&lt;&lt;</span></span>
<span id="cb47-1143"><a href="#cb47-1143" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb47-1144"><a href="#cb47-1144" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-1145"><a href="#cb47-1145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-1146"><a href="#cb47-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1147"><a href="#cb47-1147" aria-hidden="true" tabindex="-1"></a><span class="fu">## Some final tweaks</span></span>
<span id="cb47-1148"><a href="#cb47-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1149"><a href="#cb47-1149" aria-hidden="true" tabindex="-1"></a>We're so close! Just a couple final incredibly minor changes:</span>
<span id="cb47-1150"><a href="#cb47-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1151"><a href="#cb47-1151" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>We'll boost the font size of the tooltip a little and increase the font size of the legend</span>
<span id="cb47-1152"><a href="#cb47-1152" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>We'll switch from the built-in ColorBrewer <span class="in">`blues`</span> palette to show how to use custom gradients, like <span class="co">[</span><span class="ot">CARTOColors's PurpOr</span><span class="co">](https://carto.com/carto-colors/)</span> sequential palette</span>
<span id="cb47-1153"><a href="#cb47-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1156"><a href="#cb47-1156" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-1157"><a href="#cb47-1157" aria-hidden="true" tabindex="-1"></a><span class="in">//| column: body-outset</span></span>
<span id="cb47-1158"><a href="#cb47-1158" aria-hidden="true" tabindex="-1"></a><span class="in">//| ht-pattern: "//&lt;&lt;"</span></span>
<span id="cb47-1159"><a href="#cb47-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1160"><a href="#cb47-1160" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-1161"><a href="#cb47-1161" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-1162"><a href="#cb47-1162" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-1163"><a href="#cb47-1163" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-1164"><a href="#cb47-1164" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-1165"><a href="#cb47-1165" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1} ),</span></span>
<span id="cb47-1166"><a href="#cb47-1166" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, Plot.centroid({</span></span>
<span id="cb47-1167"><a href="#cb47-1167" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; country_totals.get(d.properties.iso_a3),</span></span>
<span id="cb47-1168"><a href="#cb47-1168" aria-hidden="true" tabindex="-1"></a><span class="in">      channels: {</span></span>
<span id="cb47-1169"><a href="#cb47-1169" aria-hidden="true" tabindex="-1"></a><span class="in">        Country: d =&gt; d.properties.name,</span></span>
<span id="cb47-1170"><a href="#cb47-1170" aria-hidden="true" tabindex="-1"></a><span class="in">      },</span></span>
<span id="cb47-1171"><a href="#cb47-1171" aria-hidden="true" tabindex="-1"></a><span class="in">      tip: {</span></span>
<span id="cb47-1172"><a href="#cb47-1172" aria-hidden="true" tabindex="-1"></a><span class="in">        fontSize: 12, //&lt;&lt;</span></span>
<span id="cb47-1173"><a href="#cb47-1173" aria-hidden="true" tabindex="-1"></a><span class="in">        format: {</span></span>
<span id="cb47-1174"><a href="#cb47-1174" aria-hidden="true" tabindex="-1"></a><span class="in">          Country: true,</span></span>
<span id="cb47-1175"><a href="#cb47-1175" aria-hidden="true" tabindex="-1"></a><span class="in">          fill: d =&gt; format_aid_total(d)</span></span>
<span id="cb47-1176"><a href="#cb47-1176" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb47-1177"><a href="#cb47-1177" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb47-1178"><a href="#cb47-1178" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-1179"><a href="#cb47-1179" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-1180"><a href="#cb47-1180" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-1181"><a href="#cb47-1181" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.15</span></span>
<span id="cb47-1182"><a href="#cb47-1182" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-1183"><a href="#cb47-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  ],</span></span>
<span id="cb47-1184"><a href="#cb47-1184" aria-hidden="true" tabindex="-1"></a><span class="in">  color: {</span></span>
<span id="cb47-1185"><a href="#cb47-1185" aria-hidden="true" tabindex="-1"></a><span class="in">    // scheme: "blues", //&lt;&lt;</span></span>
<span id="cb47-1186"><a href="#cb47-1186" aria-hidden="true" tabindex="-1"></a><span class="in">    range: ["#f9ddda", "#f2b9c4", "#e597b9", "#ce78b3", "#ad5fad", "#834ba0", "#573b88"], //&lt;&lt;</span></span>
<span id="cb47-1187"><a href="#cb47-1187" aria-hidden="true" tabindex="-1"></a><span class="in">    unknown: "#f2f2f2",</span></span>
<span id="cb47-1188"><a href="#cb47-1188" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "log", </span></span>
<span id="cb47-1189"><a href="#cb47-1189" aria-hidden="true" tabindex="-1"></a><span class="in">    legend: true,</span></span>
<span id="cb47-1190"><a href="#cb47-1190" aria-hidden="true" tabindex="-1"></a><span class="in">    label: "Total obligations",</span></span>
<span id="cb47-1191"><a href="#cb47-1191" aria-hidden="true" tabindex="-1"></a><span class="in">    tickFormat: d =&gt; d3.format("$0.2s")(d).replace("G", "B"),</span></span>
<span id="cb47-1192"><a href="#cb47-1192" aria-hidden="true" tabindex="-1"></a><span class="in">    style: { //&lt;&lt;</span></span>
<span id="cb47-1193"><a href="#cb47-1193" aria-hidden="true" tabindex="-1"></a><span class="in">      "font-size": "14px" //&lt;&lt;</span></span>
<span id="cb47-1194"><a href="#cb47-1194" aria-hidden="true" tabindex="-1"></a><span class="in">    } //&lt;&lt;</span></span>
<span id="cb47-1195"><a href="#cb47-1195" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb47-1196"><a href="#cb47-1196" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-1197"><a href="#cb47-1197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb47-1198"><a href="#cb47-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1199"><a href="#cb47-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1200"><a href="#cb47-1200" aria-hidden="true" tabindex="-1"></a><span class="fu"># The full game: Complete final code</span></span>
<span id="cb47-1201"><a href="#cb47-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1202"><a href="#cb47-1202" aria-hidden="true" tabindex="-1"></a>That final interactive map looks great! We could be even fancier with it by adding dropdowns for dynamically grabbing data for different years or different types of amounts (appropriations, allocations, etc.), or even filter by specific regions or countries. But we won't.</span>
<span id="cb47-1203"><a href="#cb47-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1204"><a href="#cb47-1204" aria-hidden="true" tabindex="-1"></a>The different colors and data sources we've used are scattered throughout this post. To simplify things, here's the complete code all in one location. (This chunk doesn't actually run, since Observable gets mad if you create a new variable with the same name as one that already exists.)</span>
<span id="cb47-1205"><a href="#cb47-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1208"><a href="#cb47-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb47-1209"><a href="#cb47-1209" aria-hidden="true" tabindex="-1"></a><span class="in">//| eval: false</span></span>
<span id="cb47-1210"><a href="#cb47-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1211"><a href="#cb47-1211" aria-hidden="true" tabindex="-1"></a><span class="in">d3_geo = require("d3-geo")</span></span>
<span id="cb47-1212"><a href="#cb47-1212" aria-hidden="true" tabindex="-1"></a><span class="in">d3_geo_projection = require("d3-geo-projection")</span></span>
<span id="cb47-1213"><a href="#cb47-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1214"><a href="#cb47-1214" aria-hidden="true" tabindex="-1"></a><span class="in">// ----------------------------------------------------------------------</span></span>
<span id="cb47-1215"><a href="#cb47-1215" aria-hidden="true" tabindex="-1"></a><span class="in">// Map stuff</span></span>
<span id="cb47-1216"><a href="#cb47-1216" aria-hidden="true" tabindex="-1"></a><span class="in">// ----------------------------------------------------------------------</span></span>
<span id="cb47-1217"><a href="#cb47-1217" aria-hidden="true" tabindex="-1"></a><span class="in">world = FileAttachment("ne_110m_admin_0_countries.geojson").json()</span></span>
<span id="cb47-1218"><a href="#cb47-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1219"><a href="#cb47-1219" aria-hidden="true" tabindex="-1"></a><span class="in">// Antarctica's ISO3 code is ATA</span></span>
<span id="cb47-1220"><a href="#cb47-1220" aria-hidden="true" tabindex="-1"></a><span class="in">world_sans_penguins = ({</span></span>
<span id="cb47-1221"><a href="#cb47-1221" aria-hidden="true" tabindex="-1"></a><span class="in">  type: "FeatureCollection",</span></span>
<span id="cb47-1222"><a href="#cb47-1222" aria-hidden="true" tabindex="-1"></a><span class="in">  features: world.features.filter(d =&gt; d.properties.iso_a3 !== "ATA")</span></span>
<span id="cb47-1223"><a href="#cb47-1223" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-1224"><a href="#cb47-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1225"><a href="#cb47-1225" aria-hidden="true" tabindex="-1"></a><span class="in">inset_world = 10</span></span>
<span id="cb47-1226"><a href="#cb47-1226" aria-hidden="true" tabindex="-1"></a><span class="in">world_map_width = 1000</span></span>
<span id="cb47-1227"><a href="#cb47-1227" aria-hidden="true" tabindex="-1"></a><span class="in">world_map_height = 450</span></span>
<span id="cb47-1228"><a href="#cb47-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1229"><a href="#cb47-1229" aria-hidden="true" tabindex="-1"></a><span class="in">world_sans_penguins_robinson = d3_geo_projection.geoRobinson()</span></span>
<span id="cb47-1230"><a href="#cb47-1230" aria-hidden="true" tabindex="-1"></a><span class="in">  .fitExtent(</span></span>
<span id="cb47-1231"><a href="#cb47-1231" aria-hidden="true" tabindex="-1"></a><span class="in">    [[inset_world, inset_world],</span></span>
<span id="cb47-1232"><a href="#cb47-1232" aria-hidden="true" tabindex="-1"></a><span class="in">     [world_map_width - inset_world, world_map_height - inset_world]],</span></span>
<span id="cb47-1233"><a href="#cb47-1233" aria-hidden="true" tabindex="-1"></a><span class="in">    world_sans_penguins</span></span>
<span id="cb47-1234"><a href="#cb47-1234" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb47-1235"><a href="#cb47-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1236"><a href="#cb47-1236" aria-hidden="true" tabindex="-1"></a><span class="in">// ----------------------------------------------------------------------</span></span>
<span id="cb47-1237"><a href="#cb47-1237" aria-hidden="true" tabindex="-1"></a><span class="in">// Data stuff</span></span>
<span id="cb47-1238"><a href="#cb47-1238" aria-hidden="true" tabindex="-1"></a><span class="in">// ----------------------------------------------------------------------</span></span>
<span id="cb47-1239"><a href="#cb47-1239" aria-hidden="true" tabindex="-1"></a><span class="in">import { DatasetteClient } from "@ambassadors/datasette-client"</span></span>
<span id="cb47-1240"><a href="#cb47-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1241"><a href="#cb47-1241" aria-hidden="true" tabindex="-1"></a><span class="in">aid_db = new DatasetteClient(</span></span>
<span id="cb47-1242"><a href="#cb47-1242" aria-hidden="true" tabindex="-1"></a><span class="in">  "https://foreignassistance-data.andrewheiss.com/2025-02-03_foreign-assistance"</span></span>
<span id="cb47-1243"><a href="#cb47-1243" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb47-1244"><a href="#cb47-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1245"><a href="#cb47-1245" aria-hidden="true" tabindex="-1"></a><span class="in">recipient_countries = await aid_db.sql`</span></span>
<span id="cb47-1246"><a href="#cb47-1246" aria-hidden="true" tabindex="-1"></a><span class="in">  SELECT "Country Code", "Country Name", "Region Name", SUM("constant_amount") AS total_constant_amount</span></span>
<span id="cb47-1247"><a href="#cb47-1247" aria-hidden="true" tabindex="-1"></a><span class="in">  FROM "./us_foreign_aid_country"</span></span>
<span id="cb47-1248"><a href="#cb47-1248" aria-hidden="true" tabindex="-1"></a><span class="in">  WHERE </span></span>
<span id="cb47-1249"><a href="#cb47-1249" aria-hidden="true" tabindex="-1"></a><span class="in">    "Fiscal Year" = '2023' </span></span>
<span id="cb47-1250"><a href="#cb47-1250" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Transaction Type Name" = 'Obligations' </span></span>
<span id="cb47-1251"><a href="#cb47-1251" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Country Name" NOT LIKE '%Region%' </span></span>
<span id="cb47-1252"><a href="#cb47-1252" aria-hidden="true" tabindex="-1"></a><span class="in">    AND "Country Name" != "World"</span></span>
<span id="cb47-1253"><a href="#cb47-1253" aria-hidden="true" tabindex="-1"></a><span class="in">  GROUP BY "Country Code", "Country Name", "Region Name"</span></span>
<span id="cb47-1254"><a href="#cb47-1254" aria-hidden="true" tabindex="-1"></a><span class="in">  ORDER BY total_constant_amount DESC;</span></span>
<span id="cb47-1255"><a href="#cb47-1255" aria-hidden="true" tabindex="-1"></a><span class="in">`</span></span>
<span id="cb47-1256"><a href="#cb47-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1257"><a href="#cb47-1257" aria-hidden="true" tabindex="-1"></a><span class="in">country_totals = new Map(recipient_countries.map(d =&gt; [d["Country Code"], d.total_constant_amount]))</span></span>
<span id="cb47-1258"><a href="#cb47-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1259"><a href="#cb47-1259" aria-hidden="true" tabindex="-1"></a><span class="in">function format_aid_total(value) {</span></span>
<span id="cb47-1260"><a href="#cb47-1260" aria-hidden="true" tabindex="-1"></a><span class="in">  return value ? d3.format("$,d")(value) : "No aid";</span></span>
<span id="cb47-1261"><a href="#cb47-1261" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb47-1262"><a href="#cb47-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-1263"><a href="#cb47-1263" aria-hidden="true" tabindex="-1"></a><span class="in">// ----------------------------------------------------------------------</span></span>
<span id="cb47-1264"><a href="#cb47-1264" aria-hidden="true" tabindex="-1"></a><span class="in">// Plot stuff</span></span>
<span id="cb47-1265"><a href="#cb47-1265" aria-hidden="true" tabindex="-1"></a><span class="in">// ----------------------------------------------------------------------</span></span>
<span id="cb47-1266"><a href="#cb47-1266" aria-hidden="true" tabindex="-1"></a><span class="in">Plot.plot({</span></span>
<span id="cb47-1267"><a href="#cb47-1267" aria-hidden="true" tabindex="-1"></a><span class="in">  projection: world_sans_penguins_robinson,</span></span>
<span id="cb47-1268"><a href="#cb47-1268" aria-hidden="true" tabindex="-1"></a><span class="in">  width: world_map_width,</span></span>
<span id="cb47-1269"><a href="#cb47-1269" aria-hidden="true" tabindex="-1"></a><span class="in">  height: world_map_height,</span></span>
<span id="cb47-1270"><a href="#cb47-1270" aria-hidden="true" tabindex="-1"></a><span class="in">  marks: [</span></span>
<span id="cb47-1271"><a href="#cb47-1271" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.frame({ stroke: "black", strokeWidth: 1} ),</span></span>
<span id="cb47-1272"><a href="#cb47-1272" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, Plot.centroid({</span></span>
<span id="cb47-1273"><a href="#cb47-1273" aria-hidden="true" tabindex="-1"></a><span class="in">      fill: d =&gt; country_totals.get(d.properties.iso_a3),</span></span>
<span id="cb47-1274"><a href="#cb47-1274" aria-hidden="true" tabindex="-1"></a><span class="in">      channels: {</span></span>
<span id="cb47-1275"><a href="#cb47-1275" aria-hidden="true" tabindex="-1"></a><span class="in">        Country: d =&gt; d.properties.name,</span></span>
<span id="cb47-1276"><a href="#cb47-1276" aria-hidden="true" tabindex="-1"></a><span class="in">      },</span></span>
<span id="cb47-1277"><a href="#cb47-1277" aria-hidden="true" tabindex="-1"></a><span class="in">      tip: {</span></span>
<span id="cb47-1278"><a href="#cb47-1278" aria-hidden="true" tabindex="-1"></a><span class="in">        fontSize: 12,</span></span>
<span id="cb47-1279"><a href="#cb47-1279" aria-hidden="true" tabindex="-1"></a><span class="in">        format: {</span></span>
<span id="cb47-1280"><a href="#cb47-1280" aria-hidden="true" tabindex="-1"></a><span class="in">          Country: true,</span></span>
<span id="cb47-1281"><a href="#cb47-1281" aria-hidden="true" tabindex="-1"></a><span class="in">          fill: d =&gt; format_aid_total(d)</span></span>
<span id="cb47-1282"><a href="#cb47-1282" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb47-1283"><a href="#cb47-1283" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb47-1284"><a href="#cb47-1284" aria-hidden="true" tabindex="-1"></a><span class="in">    })),</span></span>
<span id="cb47-1285"><a href="#cb47-1285" aria-hidden="true" tabindex="-1"></a><span class="in">    Plot.geo(world_sans_penguins, {</span></span>
<span id="cb47-1286"><a href="#cb47-1286" aria-hidden="true" tabindex="-1"></a><span class="in">      stroke: "black",</span></span>
<span id="cb47-1287"><a href="#cb47-1287" aria-hidden="true" tabindex="-1"></a><span class="in">      strokeWidth: 0.15</span></span>
<span id="cb47-1288"><a href="#cb47-1288" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb47-1289"><a href="#cb47-1289" aria-hidden="true" tabindex="-1"></a><span class="in">  ],</span></span>
<span id="cb47-1290"><a href="#cb47-1290" aria-hidden="true" tabindex="-1"></a><span class="in">  color: {</span></span>
<span id="cb47-1291"><a href="#cb47-1291" aria-hidden="true" tabindex="-1"></a><span class="in">    range: ["#f9ddda", "#f2b9c4", "#e597b9", "#ce78b3", "#ad5fad", "#834ba0", "#573b88"],</span></span>
<span id="cb47-1292"><a href="#cb47-1292" aria-hidden="true" tabindex="-1"></a><span class="in">    unknown: "#f2f2f2",</span></span>
<span id="cb47-1293"><a href="#cb47-1293" aria-hidden="true" tabindex="-1"></a><span class="in">    type: "log", </span></span>
<span id="cb47-1294"><a href="#cb47-1294" aria-hidden="true" tabindex="-1"></a><span class="in">    legend: true,</span></span>
<span id="cb47-1295"><a href="#cb47-1295" aria-hidden="true" tabindex="-1"></a><span class="in">    label: "Total obligations",</span></span>
<span id="cb47-1296"><a href="#cb47-1296" aria-hidden="true" tabindex="-1"></a><span class="in">    tickFormat: d =&gt; d3.format("$0.2s")(d).replace("G", "B"),</span></span>
<span id="cb47-1297"><a href="#cb47-1297" aria-hidden="true" tabindex="-1"></a><span class="in">    style: {</span></span>
<span id="cb47-1298"><a href="#cb47-1298" aria-hidden="true" tabindex="-1"></a><span class="in">      "font-size": "14px" </span></span>
<span id="cb47-1299"><a href="#cb47-1299" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb47-1300"><a href="#cb47-1300" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb47-1301"><a href="#cb47-1301" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb47-1302"><a href="#cb47-1302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2024–2025 Bradley Rentz</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-2893-6105">0000-0002-2893-6105</a></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/rentzb/rentz_website">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


<script src="../../../../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>